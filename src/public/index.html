<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JobMatch AI - AI-Powered Resume Analyzer & Job Matching Platform</title>
  <meta name="description"
    content="Optimize your career with JobMatch AI. Our AI-powered resume analyzer, mock interviews, and job matching tools help you land your dream job faster.">
  <meta name="keywords"
    content="resume analyzer, job matching, mock interview, AI career tools, resume optimizer, cover letter generator">
  <link rel="canonical" href="https://whynointerviews.vercel.app/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://whynointerviews.vercel.app/">
  <meta property="og:title" content="JobMatch AI - AI-Powered Resume Analyzer & Job Matching Platform">
  <meta property="og:description"
    content="Optimize your career with JobMatch AI. Our AI-powered resume analyzer, mock interviews, and job matching tools help you land your dream job faster.">
  <meta property="og:image" content="https://whynointerviews.vercel.app/favicon.ico">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://whynointerviews.vercel.app/">
  <meta property="twitter:title" content="JobMatch AI - AI-Powered Resume Analyzer & Job Matching Platform">
  <meta property="twitter:description"
    content="Optimize your career with JobMatch AI. Our AI-powered resume analyzer, mock interviews, and job matching tools help you land your dream job faster.">
  <meta property="twitter:image" content="https://whynointerviews.vercel.app/favicon.ico">

  <!-- Google Analytics (GA4) -->
  <!-- REPLACE G-XXXXXXXXXX WITH YOUR ACTUAL MEASUREMENT ID -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-XXXXXXXXXX');

    // Helper for event logging
    window.logEvent = function (eventName, params = {}) {
      if (typeof gtag === 'function') {
        gtag('event', eventName, params);
      }
      console.log('üìä Event:', eventName, params);
    };
  </script>

  <!-- Google OAuth Library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- JSON-LD SEO -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "JobMatch AI",
      "url": "https://whynointerviews.vercel.app/",
      "description": "AI-powered resume analyzer, mock interviews, and job matching platform.",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://whynointerviews.vercel.app/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
  </script>
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "JobMatch AI",
      "url": "https://whynointerviews.vercel.app/",
      "logo": "https://whynointerviews.vercel.app/favicon.ico",
      "sameAs": [
        "https://www.linkedin.com/company/jobmatch-ai"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer support",
        "email": "support@jobmatch.ai"
      }
    }
  </script>
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "JobMatch AI",
      "operatingSystem": "All",
      "applicationCategory": "CareerService",
      "description": "AI-powered platform to analyze resumes, search jobs, and practice interviews.",
      "offers": {
        "@type": "Offer",
        "price": "0.00",
        "priceCurrency": "USD"
      }
    }
  </script>

  <!-- Google Identity Services -->
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #FFF9F0;
      color: #1E293B;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    header {
      background: white;
      border-bottom: 1px solid #E2E8F0;
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1E293B;
    }

    .logo span {
      color: #FF9500;
    }

    .logo img {
      height: 40px;
      width: auto;
    }

    /* Main Tabs */
    .main-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      flex: 1;
      min-width: 0;
      justify-content: center;
    }

    .main-tab {
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      color: #94a3b8;
      font-weight: 500;
      font-size: 0.85rem;
      transition: all 0.2s;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .main-tab:hover {
      color: #1E293B;
      background: #FFF4E6;
    }

    .main-tab.active {
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.15), rgba(255, 149, 0, 0.05));
      color: #FF9500;
      border-color: rgba(255, 149, 0, 0.3);
    }

    .main-tab .badge {
      background: #FF9500;
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 6px;
    }

    /* Hide Home tab by default (shown only in new UI mode) */
    .main-tab[data-tab="home"] {
      display: none;
    }

    /* Container */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Cards */
    .card {
      background: white;
      border: 1px solid #E2E8F0;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-header {
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: #64748b;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #FF9500, #FF7A00);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 149, 0, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: white;
      color: #1E293B;
      border: 1px solid #E2E8F0;
      transform: none;
    }

    .btn-secondary:hover {
      background: #E2E8F0;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .btn-full {
      width: 100%;
    }

    /* Grid */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 16px;
        padding: 16px 24px;
      }

      .main-tabs {
        order: 2;
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      .header-actions {
        order: 1;
      }

      .grid-2 {
        grid-template-columns: 1fr;
      }

      .grid-4 {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 1024px) {
      .main-tabs {
        flex-wrap: wrap;
        gap: 4px;
      }

      .main-tab {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
    }

    /* Upload */
    .upload-zone {
      border: 2px dashed #E2E8F0;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-zone:hover {
      border-color: #FF9500;
      background: rgba(255, 149, 0, 0.05);
    }

    .upload-zone.has-file {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.05);
    }

    .upload-zone input {
      display: none;
    }

    .upload-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .file-name {
      color: #10b981;
      font-weight: 600;
      margin-top: 12px;
    }

    /* Textarea */
    textarea {
      width: 100%;
      min-height: 200px;
      padding: 16px;
      background: white;
      border: 1px solid #E2E8F0;
      border-radius: 10px;
      color: #1E293B;
      font-family: inherit;
      font-size: 0.95rem;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #FF9500;
    }

    /* Input */
    .input,
    select,
    textarea {
      width: 100%;
      padding: 12px 16px;
      background: white;
      border: 1px solid #E2E8F0;
      border-radius: 10px;
      color: #1E293B;
      font-size: 0.95rem;
    }

    .input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #FF9500;
    }

    /* Sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Score Display */
    .score-hero {
      text-align: center;
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
    }

    .score-hero.strong {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
      border: 2px solid rgba(16, 185, 129, 0.3);
    }

    .score-hero.moderate {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
      border: 2px solid rgba(245, 158, 11, 0.3);
    }

    .score-hero.weak {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
      border: 2px solid rgba(239, 68, 68, 0.3);
    }

    .score-ring {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      border: 5px solid;
    }

    .score-ring.high {
      border-color: #10b981;
      color: #10b981;
    }

    .score-ring.medium {
      border-color: #f59e0b;
      color: #f59e0b;
    }

    .score-ring.low {
      border-color: #ef4444;
      color: #ef4444;
    }

    .score-number {
      font-size: 2.5rem;
      font-weight: 800;
    }

    .score-label {
      font-size: 0.7rem;
      color: #94a3b8;
      text-transform: uppercase;
    }

    .verdict-badge {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }

    .verdict-badge.high {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .verdict-badge.medium {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .verdict-badge.low {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    /* Analysis Items */
    .analysis-card {
      background: #1e1e2e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .analysis-card h4 {
      font-size: 0.95rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .item {
      background: #0a0a0f;
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .item.success {
      border-left: 4px solid #10b981;
    }

    .item.danger {
      border-left: 4px solid #ef4444;
    }

    .item.warning {
      border-left: 4px solid #f59e0b;
    }

    .item-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .item-desc {
      font-size: 0.9rem;
      color: #94a3b8;
    }

    .item-fix {
      font-size: 0.85rem;
      color: #6366f1;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #2e2e3e;
    }

    /* Tags */
    .tag {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      margin: 3px;
    }

    .tag-success {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .tag-danger {
      background: rgba(100, 116, 139, 0.15);
      color: #94a3b8;
    }

    .tag-warning {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .tag-info {
      background: rgba(99, 102, 241, 0.15);
      color: #a5b4fc;
    }

    /* Progress Bar */
    .progress-bar {
      height: 8px;
      background: #1e1e2e;
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
    }

    .progress-fill.high {
      background: #10b981;
    }

    .progress-fill.medium {
      background: #f59e0b;
    }

    .progress-fill.low {
      background: #ef4444;
    }

    /* Job Cards */
    .job-card {
      background: #12121a;
      border: 1px solid #1e1e2e;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .job-card:hover {
      border-color: #3e3e4e;
      transform: translateX(4px);
    }

    .job-card.excellent {
      border-left: 4px solid #10b981;
    }

    .job-card.good {
      border-left: 4px solid #6366f1;
    }

    .job-card.moderate {
      border-left: 4px solid #f59e0b;
    }

    .job-header {
      display: flex;
      justify-content: space-between;
    }

    .job-title {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .job-company {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .job-meta {
      display: flex;
      gap: 16px;
      color: #64748b;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .match-percent {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .match-percent.high {
      color: #10b981;
    }

    .match-percent.medium {
      color: #f59e0b;
    }

    .match-percent.low {
      color: #ef4444;
    }

    .recommendation {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .recommendation.apply-now {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .recommendation.worth-it {
      background: rgba(99, 102, 241, 0.2);
      color: #a5b4fc;
    }

    .recommendation.customize {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .recommendation.skip {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    /* Bottom Line */
    .bottom-line {
      background: linear-gradient(135deg, #1e1e2e, #12121a);
      border: 1px solid #2e2e3e;
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      margin-top: 24px;
    }

    .bottom-line h3 {
      color: #f59e0b;
      margin-bottom: 16px;
    }

    .one-thing {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
    }

    .one-thing-label {
      font-size: 0.75rem;
      color: #818cf8;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .one-thing-text {
      font-weight: 600;
    }

    .encouragement {
      color: #10b981;
      font-style: italic;
    }

    /* Cover Letter */
    .cover-letter-box {
      background: white;
      border: 1px solid #E2E8F0;
      border-radius: 12px;
      padding: 24px;
      font-size: 0.95rem;
      line-height: 1.8;
      white-space: pre-wrap;
      color: #1E293B;
    }

    /* Tracker Stats */
    .tracker-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border: 1px solid #E2E8F0;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
    }

    .stat-number.saved {
      color: #FF9500;
    }

    .stat-number.applied {
      color: #f59e0b;
    }

    .stat-number.interview {
      color: #10b981;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      margin-top: 4px;
    }

    @media (max-width: 600px) {
      .tracker-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Search Links Grid */
    .search-links-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 700px) {
      .search-links-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Actions */
    .action-list {
      list-style: none;
    }

    .action-list li {
      padding: 12px 14px;
      background: #0a0a0f;
      border-radius: 8px;
      margin-bottom: 6px;
      border-left: 3px solid;
    }

    .action-list.urgent li {
      border-left-color: #ef4444;
    }

    .action-list.quick li {
      border-left-color: #10b981;
    }

    .action-list.effort li {
      border-left-color: #f59e0b;
    }

    /* Cover Letter Modal (old style) */
    .cl-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(5px);
    }

    /* Paywall Modal Specific Styles */
    .paywall-modal-content {
      background: linear-gradient(135deg, #1e1e2e 0%, #12121a 100%);
      border: 1px solid #f59e0b;
      border-radius: 24px;
      width: 100%;
      max-width: 500px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(245, 158, 11, 0.2);
    }

    .paywall-icon {
      font-size: 4rem;
      margin-bottom: 24px;
      display: inline-block;
      filter: drop-shadow(0 0 10px rgba(245, 158, 11, 0.4));
    }

    .paywall-title {
      font-size: 1.75rem;
      font-weight: 800;
      margin-bottom: 16px;
      background: linear-gradient(to right, #f59e0b, #fbbf24);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .paywall-desc {
      color: #94a3b8;
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .paywall-close-btn {
      background: white;
      border: 1px solid #E2E8F0;
      color: #1E293B;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .paywall-close-btn:hover {
      background: #F8FAFC;
      color: #FF9500;
    }

    .cl-modal.open {
      display: flex;
    }

    .cl-modal-content {
      background: white;
      border: 1px solid #E2E8F0;
      border-radius: 20px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .cl-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #E2E8F0;
      position: sticky;
      top: 0;
      background: white;
    }

    .cl-modal-body {
      padding: 24px;
    }

    .cl-modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Misc */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: #1e1e2e;
      border: 1px solid #2e2e3e;
      color: white;
      border-radius: 12px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: #10b981;
    }

    .toast.error {
      border-color: #ef4444;
      background: #ef4444;
    }

    .empty-state {
      text-align: center;
      padding: 48px;
      color: #64748b;
    }

    .empty-state .icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .divider {
      height: 1px;
      background: #1e1e2e;
      margin: 20px 0;
    }

    .text-muted {
      color: #64748b;
    }

    .mb-4 {
      margin-bottom: 16px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    .flex {
      display: flex;
    }

    .gap-2 {
      gap: 8px;
    }

    .gap-4 {
      gap: 16px;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .flex-wrap {
      flex-wrap: wrap;
    }

    /* Auth Styles */
    .auth-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .auth-buttons .btn {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .user-name {
      font-size: 1rem;
      font-weight: 600;
      color: #1e293b;
      /* Darker color for better visibility */
    }

    .dropdown {
      position: relative;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: #1e1e2e;
      border: 1px solid #2e2e3e;
      border-radius: 8px;
      padding: 8px 0;
      min-width: 180px;
      display: none;
      z-index: 200;
      margin-top: 8px;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #94a3b8;
      transition: all 0.2s;
    }

    .dropdown-item:hover {
      background: #2e2e3e;
      color: #e2e8f0;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-overlay.show {
      display: flex !important;
    }

    .modal {
      background: #12121a;
      border: 1px solid #2e2e3e;
      border-radius: 16px;
      padding: 32px;
      width: 90%;
      max-width: 420px;
      position: relative;
    }

    .modal-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }

    .modal-header p {
      color: #64748b;
      font-size: 0.9rem;
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.8rem;
      cursor: pointer;
      line-height: 1;
      padding: 4px;
    }

    .modal-close:hover {
      color: #e2e8f0;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      background: white;
      border: 1px solid #E2E8F0;
      border-radius: 8px;
      color: #1E293B;
      font-size: 0.95rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: #FF9500;
    }

    .form-error {
      color: #ef4444;
      font-size: 0.8rem;
      margin-top: 4px;
      display: none;
    }

    .form-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      color: #64748b;
      font-size: 0.85rem;
    }

    .form-divider::before,
    .form-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #E2E8F0;
    }

    .auth-switch {
      text-align: center;
      margin-top: 16px;
      font-size: 0.9rem;
      color: #64748b;
    }

    .auth-switch a {
      color: #FF9500;
      cursor: pointer;
      text-decoration: underline;
    }

    .btn-google {
      background: white;
      color: #1f1f1f;
      border: 1px solid #dadce0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 500;
    }

    .btn-google:hover {
      background: #f8f9fa;
      border-color: #dadce0;
    }

    .btn-google svg {
      flex-shrink: 0;
    }

    .google-btn-container {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
    }

    /* Saved Items indicator */
    .saved-indicator {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .saved-indicator .icon {
      font-size: 1.2rem;
    }

    .saved-indicator .text {
      font-size: 0.9rem;
      color: #10b981;
    }

    /* Target Companies Styles */
    .stat-card {
      background: #1e1e2e;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #94a3b8;
      text-transform: uppercase;
    }

    /* Company Search & Add */
    .company-search-container {
      position: relative;
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .search-input-wrapper {
      position: relative;
      flex: 1;
      min-width: 250px;
    }

    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #E2E8F0;
      border-radius: 12px;
      margin-top: 4px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .search-suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #F1F5F9;
      transition: background 0.2s;
    }

    .search-suggestion-item:last-child {
      border-bottom: none;
    }

    .search-suggestion-item:hover {
      background: #F8FAFC;
    }

    .search-suggestion-item .comp-name {
      font-weight: 600;
      color: #1E293B;
    }

    .search-suggestion-item .comp-industry {
      font-size: 0.8rem;
      color: #64748b;
    }

    .company-card {
      background: #1e1e2e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      border-left: 4px solid #6366f1;
      position: relative;
      transition: all 0.2s;
    }

    .company-card:hover {
      background: #252530;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .company-card.priority-1 {
      border-left-color: #ef4444;
    }

    .company-card.priority-2 {
      border-left-color: #f59e0b;
    }

    .company-card.priority-3 {
      border-left-color: #6366f1;
    }

    .company-card.priority-4 {
      border-left-color: #64748b;
    }

    .company-card.priority-5 {
      border-left-color: #475569;
    }

    .company-card.inactive {
      opacity: 0.5;
    }

    .company-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .company-info {
      flex: 1;
    }

    .company-name {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .company-meta {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .company-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .priority-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-badge.p1 {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .priority-badge.p2 {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .priority-badge.p3 {
      background: rgba(99, 102, 241, 0.2);
      color: #6366f1;
    }

    .priority-badge.p4 {
      background: rgba(100, 116, 139, 0.2);
      color: #94a3b8;
    }

    .priority-badge.p5 {
      background: rgba(71, 85, 105, 0.2);
      color: #64748b;
    }

    .company-actions {
      display: flex;
      gap: 8px;
    }

    .company-actions .btn {
      padding: 8px 12px;
      font-size: 0.8rem;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      margin-right: 12px;
    }

    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .company-notes {
      background: #0a0a0f;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 0.9rem;
      color: #94a3b8;
    }

    .suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      max-height: 60vh;
      overflow-y: auto;
      padding: 4px;
    }

    .suggestion-card {
      background: #1e1e2e;
      border: 2px solid #2e2e3e;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion-card:hover {
      border-color: #6366f1;
      background: #252530;
    }

    .suggestion-card.selected {
      border-color: #FF9500;
      background: rgba(255, 149, 0, 0.05);
    }

    .discovery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .discovery-card {
      background: white;
      border: 1px solid #E2E8F0;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .discovery-card:hover {
      border-color: #FF9500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    .discovery-card h4 {
      margin: 0;
      color: #1E293B;
      font-size: 1.1rem;
    }

    .discovery-card .industry {
      font-size: 0.75rem;
      font-weight: 600;
      color: #FF9500;
      background: rgba(255, 149, 0, 0.1);
      padding: 4px 10px;
      border-radius: 20px;
      align-self: flex-start;
    }

    .discovery-card .description {
      font-size: 0.85rem;
      color: #64748B;
      line-height: 1.5;
    }

    .discovery-card .btn-add {
      margin-top: auto;
      width: 100%;
      background: #F8FAFC;
      border: 1px solid #E2E8F0;
      color: #1E293B;
      padding: 8px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .discovery-card:hover .btn-add {
      background: #FF9500;
      border-color: #FF9500;
      color: white;
    }

    .section-subtitle {
      font-size: 0.9rem;
      color: #94A3B8;
      margin-bottom: 24px;
    }

    .suggestion-card h4 {
      font-size: 1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .suggestion-card .industry {
      font-size: 0.75rem;
      color: #6366f1;
      background: rgba(99, 102, 241, 0.15);
      padding: 2px 8px;
      border-radius: 8px;
      display: inline-block;
      margin-bottom: 8px;
    }

    .suggestion-card .description {
      font-size: 0.85rem;
      color: #94a3b8;
      line-height: 1.4;
    }

    .modal.large {
      max-width: 800px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .job-card {
      background: #1e1e2e;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 12px;
      border-left: 3px solid #6366f1;
    }

    .job-card:hover {
      background: #252530;
    }

    .job-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .job-company {
      font-size: 0.9rem;
      color: #94a3b8;
      margin-bottom: 12px;
    }

    .job-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 12px;
    }

    .job-actions {
      display: flex;
      gap: 8px;
    }

    .badge-new {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Library Tabs */
    .lib-tab {
      background: transparent;
      border: none;
      color: #94a3b8;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
    }

    .lib-tab:hover {
      background: rgba(99, 102, 241, 0.1);
      color: #e2e8f0;
    }

    .lib-tab.active {
      background: #6366f1;
      color: white;
    }

    /* ============================================
       SIDEBAR NAVIGATION - LIGHT THEME
       ============================================ */

    /* Layout */
    body {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      height: 100vh;
      background: #FFFFFF;
      border-right: 1px solid #E2E8F0;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0;
      top: 0;
      z-index: 1000;
      transition: width 0.3s ease;
      overflow: hidden;
    }

    .sidebar.collapsed {
      width: 60px;
    }

    /* Sidebar Header */
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 12px;
      border-bottom: 1px solid #E2E8F0;
      min-height: 64px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      overflow: hidden;
    }

    .logo-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .logo-text {
      font-size: 1.1rem;
      color: #1E293B;
      white-space: nowrap;
      transition: opacity 0.2s;
    }

    .logo-text strong {
      color: #FF9500;
    }

    .sidebar.collapsed .logo-text {
      opacity: 0;
      width: 0;
    }

    .sidebar-toggle {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: transparent;
      border: 1px solid #E2E8F0;
      color: #64748B;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .sidebar-toggle:hover {
      background: #FFF9F0;
      color: #FF9500;
      border-color: #FF9500;
    }

    .toggle-icon {
      transition: transform 0.3s;
    }

    .sidebar.collapsed .toggle-icon {
      transform: rotate(180deg);
    }

    /* Sidebar Navigation */
    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 0;
    }

    .sidebar-nav::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar-nav::-webkit-scrollbar-thumb {
      background: #E2E8F0;
      border-radius: 2px;
    }

    /* Nav Section */
    .nav-section {
      margin-bottom: 16px;
    }

    .section-header {
      font-size: 0.7rem;
      font-weight: 600;
      color: #94A3B8;
      padding: 6px 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: opacity 0.2s;
    }

    .sidebar.collapsed .section-header {
      opacity: 0;
      height: 0;
      padding: 0;
    }

    /* Nav Item */
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      margin: 2px 8px;
      color: #64748B;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
    }

    .nav-item:hover {
      background: #FFF9F0;
      color: #1E293B;
    }

    .nav-item.active {
      background: linear-gradient(90deg, rgba(255, 149, 0, 0.1), rgba(255, 149, 0, 0.05));
      color: #FF9500;
      font-weight: 600;
    }

    .nav-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
      width: 24px;
      text-align: center;
    }

    .nav-label {
      transition: opacity 0.2s;
    }

    .sidebar.collapsed .nav-label {
      opacity: 0;
      width: 0;
    }

    /* Sidebar Footer */
    .sidebar-footer {
      border-top: 1px solid #E2E8F0;
      padding: 12px;
    }

    .upgrade-btn {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #FF9500, #FF7A00);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upgrade-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
    }

    .upgrade-btn .arrow {
      margin-left: auto;
      transition: transform 0.2s;
    }

    .upgrade-btn:hover .arrow {
      transform: translateX(4px);
    }

    .sidebar.collapsed .upgrade-btn .nav-label,
    .sidebar.collapsed .upgrade-btn .arrow {
      opacity: 0;
      width: 0;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 240px;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
      background: #FFF9F0;
      display: flex;
      flex-direction: column;
    }

    .sidebar.collapsed+.main-content {
      margin-left: 60px;
    }

    .content-wrapper {
      flex: 1;
    }

    /* Top Bar (Mobile) */
    .top-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid #E2E8F0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .mobile-menu-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #1E293B;
      cursor: pointer;
    }

    .top-bar-logo {
      font-size: 1.1rem;
      color: #1E293B;
    }

    .top-bar-logo strong {
      color: #FF9500;
    }

    /* Mobile Overlay */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 240px !important;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0 !important;
      }

      .top-bar {
        display: flex;
      }

      .sidebar-overlay.show {
        display: block;
      }

      .sidebar .nav-label,
      .sidebar .logo-text,
      .sidebar .section-header {
        opacity: 1 !important;
        width: auto !important;
      }
    }

    /* Tablet */
    @media (max-width: 1024px) and (min-width: 769px) {
      .sidebar {
        width: 60px;
      }

      .main-content {
        margin-left: 60px;
      }

      .sidebar .nav-label,
      .sidebar .logo-text,
      .sidebar .section-header {
        opacity: 0;
        width: 0;
      }
    }

    /* ============================================
       OVERRIDE DARK INLINE STYLES
       ============================================ */

    /* Fix Resume Optimizer textarea */
    #optimizer-job-description {
      background: white !important;
      border: 2px solid #E2E8F0 !important;
      color: #1E293B !important;
    }

    #optimizer-job-description:focus {
      border-color: #FF9500 !important;
      outline: none !important;
    }

    /* Fix Resume Analysis select dropdown */
    #llm-provider-select {
      background: white !important;
      border: 1px solid #E2E8F0 !important;
      color: #1E293B !important;
    }

    #llm-provider-select:focus {
      border-color: #FF9500 !important;
      outline: none !important;
    }

    /* Fix any other job description textareas */
    #job-description {
      background: white !important;
      border: 2px solid #E2E8F0 !important;
      color: #1E293B !important;
    }

    #job-description:focus {
      border-color: #FF9500 !important;
      outline: none !important;
    }
  </style>
  <link rel="stylesheet" href="/new-ui.css">
</head>

<body class="new-ui">
  <!-- Sidebar Navigation -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="logo.svg" alt="JobMatch AI" class="logo-icon" style="width: 32px; height: 32px;" />
        <span class="logo-text"><strong>Job</strong>Match AI</span>
      </div>
      <button class="sidebar-toggle" onclick="toggleSidebar()">
        <span class="toggle-icon">‚Üê</span>
      </button>
    </div>

    <nav class="sidebar-nav">
      <!-- MAIN Section -->
      <div class="nav-section">
        <a href="#" class="nav-item" data-tab="home">
          <span class="nav-icon">üè†</span>
          <span class="nav-label">Home</span>
        </a>
        <a href="#" class="nav-item active" data-tab="analyze">
          <span class="nav-icon">üìÑ</span>
          <span class="nav-label">Resume Analysis</span>
        </a>
        <a href="#" class="nav-item" data-tab="search">
          <span class="nav-icon">üíº</span>
          <span class="nav-label">Job Matching</span>
        </a>
        <a href="#" class="nav-item" data-tab="optimizer">
          <span class="nav-icon">‚ú®</span>
          <span class="nav-label">Resume Optimizer</span>
        </a>
        <a href="#" class="nav-item" data-tab="target-companies">
          <span class="nav-icon">üè¢</span>
          <span class="nav-label">Target Companies</span>
        </a>
        <a href="#" class="nav-item" data-tab="networking">
          <span class="nav-icon">ü§ù</span>
          <span class="nav-label">Networking</span>
        </a>
        <a href="#" class="nav-item" data-tab="community">
          <span class="nav-icon">üí¨</span>
          <span class="nav-label">Community</span>
        </a>
        <button class="nav-item" onclick="showMyLibrary()"
          style="width: calc(100% - 16px); margin: 2px 8px; border: none; background: transparent; text-align: left; font-family: inherit;">
          <span class="nav-icon">üìö</span>
          <span class="nav-label">My Library</span>
        </button>
      </div>

      <!-- INTERVIEW Section -->
      <div class="nav-section">
        <a href="/practice-interview.html" class="nav-item">
          <span class="nav-icon">üéØ</span>
          <span class="nav-label">Practice Interview</span>
        </a>
        <a href="#" class="nav-item" data-tab="mock-interview">
          <span class="nav-icon">üé•</span>
          <span class="nav-label">Mock Interview</span>
        </a>
        <a href="#" class="nav-item" data-tab="interview-dashboard">
          <span class="nav-icon">üìä</span>
          <span class="nav-label">Dashboard</span>
        </a>
      </div>
    </nav>

    <!-- Sidebar Footer -->
    <div class="sidebar-footer">
      <!-- Help & Support Links -->
      <div style="display: flex; gap: 4px; margin-bottom: 8px;">
        <a href="/help-guide.html" target="_blank" class="nav-item"
          style="flex: 1; justify-content: center; margin: 0; padding: 6px; font-size: 0.8rem;">
          <span class="nav-label">‚ùì Help</span>
        </a>
        <a href="https://www.buymeacoffee.com/aravind.thiyaga" target="_blank" class="nav-item"
          style="flex: 1; justify-content: center; margin: 0; padding: 6px; font-size: 0.8rem;">
          <span class="nav-label">‚òï Support</span>
        </a>
      </div>

      <!-- Auth Buttons (shown when logged out) -->
      <div id="sidebar-auth-buttons" style="display: flex; gap: 8px; margin-bottom: 8px;">
        <button type="button" class="btn btn-secondary" onclick="openAuthModal('login')"
          style="flex: 1; padding: 8px 12px; font-size: 0.85rem;">Log In</button>
        <button type="button" class="btn btn-primary" onclick="openAuthModal('register')"
          style="flex: 1; padding: 8px 12px; font-size: 0.85rem;">Sign Up</button>
      </div>

      <!-- User Menu (shown when logged in) -->
      <div id="sidebar-user-menu" style="display: none; margin-bottom: 8px;">
        <div class="nav-item" style="margin: 0; cursor: pointer;"
          onclick="document.getElementById('sidebar-user-dropdown').classList.toggle('show')">
          <div class="user-avatar" id="sidebar-user-avatar"
            style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #FF9500, #FF7A00); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
            U</div>
          <span class="nav-label" id="sidebar-user-name">User</span>
          <span style="margin-left: auto; color: #64748B;">‚ñº</span>
        </div>
        <div class="dropdown-menu" id="sidebar-user-dropdown" style="position: relative; margin-top: 8px;">
          <div class="dropdown-item" onclick="logout()">üö™ Logout</div>
        </div>
      </div>

      <!-- Upgrade Button -->
      <button class="upgrade-btn" onclick="window.location.href='/upgrade.html'">
        <span class="nav-icon">üíé</span>
        <span class="nav-label">Upgrade</span>
        <span class="arrow">‚Üí</span>
      </button>
    </div>
  </aside>

  <!-- Main Content Wrapper -->
  <div class="main-content">
    <!-- Top Bar for Mobile -->
    <header class="top-bar">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <div class="top-bar-logo">
        <strong>Job</strong>Match AI
      </div>
      <div class="top-bar-actions" id="top-bar-auth">
        <!-- Auth buttons will be populated by JavaScript -->
      </div>
    </header>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
      <script>
        // Note: Auth modal functions are defined later in the document
      </script>
      <header style="display: none;">
        <div class="header-content">
          <div class="logo"><img src="/logo.svg" alt="JobMatch AI" /></div>
          <nav class="main-tabs">
            <div class="main-tab" data-tab="home">Home</div>
            <div class="main-tab active" data-tab="analyze">Resume Analysis</div>
            <div class="main-tab" data-tab="search">Job Matching</div>
            <div class="main-tab" data-tab="optimizer">Resume Optimizer</div>
            <div class="main-tab" data-tab="target-companies">Target Companies</div>
            <div class="main-tab" data-tab="networking">Networking</div>
            <div class="main-tab" data-tab="mock-interview">üéØ Mock Interview</div>
            <div class="main-tab" data-tab="interview-dashboard">üìä Dashboard</div>
          </nav>

          <div class="header-actions" style="display: flex; align-items: center; gap: 12px;">
            <a href="/help-guide.html" target="_blank" class="help-icon-btn" title="User Guide"
              style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; background: rgba(99, 102, 241, 0.15); color: #a5b4fc; text-decoration: none; font-size: 1.1rem; transition: all 0.2s; border: 1px solid rgba(99, 102, 241, 0.3);">‚ùì</a>
            <a href="/upgrade.html" class="btn-upgrade-short">üíé Upgrade</a>
            <a href="https://www.buymeacoffee.com/aravind.thiyaga" target="_blank" class="btn-support-short">‚òï
              Support</a>

            <!-- Auth Section -->
            <div id="auth-section">
              <!-- Shown when logged out -->
              <div id="auth-buttons" class="auth-buttons">
                <button type="button" class="btn btn-secondary" onclick="openAuthModal('login')">Log In</button>
                <button type="button" class="btn btn-primary" onclick="openAuthModal('register')">Sign Up</button>
              </div>

              <!-- Shown when logged in -->
              <div id="user-menu" class="user-menu" style="display: none;">
                <div class="dropdown">
                  <div style="display: flex; align-items: center; gap: 8px; cursor: pointer;"
                    onclick="document.getElementById('user-dropdown').classList.toggle('show')">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-name" id="user-display-name">User</span>
                    <span style="color: #64748b;">‚ñº</span>
                  </div>
                  <div class="dropdown-menu" id="user-dropdown">
                    <div class="dropdown-item" onclick="showMyLibrary()">üìö My Library</div>
                    <div class="dropdown-item" onclick="showUserGuide()">üìñ User Guide</div>
                    <div class="dropdown-item"
                      style="border-top: 1px solid #2e2e3e; margin-top: 8px; padding-top: 12px;" onclick="logout()">üö™
                      Log Out</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </header>

      <!-- Global Resume Upload Bar -->
      <div id="global-resume-bar"
        style="background: white; border-bottom: 1px solid #E2E8F0; padding: 12px 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
        <div
          style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px;">
          <!-- No Resume Uploaded State -->
          <div id="resume-empty-state" style="display: flex; align-items: center; gap: 16px; flex: 1;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 1.5rem;">üìÑ</span>
              <div>
                <div style="font-weight: 600; font-size: 0.95rem;">Upload Your Resume Once</div>
                <div style="font-size: 0.8rem; color: #64748b;">Use it across all features - analyze, optimize, and find
                  jobs</div>
              </div>
            </div>
            <input type="file" id="global-resume-input" accept=".pdf,.doc,.docx" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('global-resume-input').click()"
              style="white-space: nowrap;">
              üì§ Upload Resume
            </button>
          </div>

          <!-- Resume Uploaded State -->
          <div id="resume-loaded-state"
            style="display: none; align-items: center; gap: 16px; flex: 1; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 1.5rem;">‚úÖ</span>
              <div>
                <div style="font-weight: 600; font-size: 0.95rem;" id="global-resume-name">resume.pdf</div>
                <div style="font-size: 0.8rem; color: #64748b;">
                  <span id="global-resume-status">Ready to use</span>
                  <span style="margin: 0 8px;">‚Ä¢</span>
                  <span id="global-resume-session">Session active</span>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary btn-sm" onclick="replaceGlobalResume()">üîÑ Replace</button>
              <button class="btn btn-secondary btn-sm" onclick="clearGlobalResume()">‚ùå Clear</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Old Auth Modal Removed -->

      <!-- Unified Library Modal -->
      <div class="modal-overlay" id="library-modal">
        <div class="modal large"
          style="position: relative; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
          <button class="modal-close" onclick="hideLibraryModal()">&times;</button>

          <div class="modal-header" style="flex-shrink: 0;">
            <h2 id="library-modal-title">üìö My Library</h2>
            <p>Your saved resumes, cover letters, and AI-generated assets</p>

            <div class="library-tabs"
              style="display: flex; gap: 8px; margin-top: 20px; border-bottom: 1px solid #2e2e3e; padding-bottom: 12px;">
              <button class="lib-tab active" data-lib-tab="resumes" onclick="switchLibraryTab('resumes')">üìÑ
                Resumes</button>
              <button class="lib-tab" data-lib-tab="cover-letters" onclick="switchLibraryTab('cover-letters')">‚úâÔ∏è Cover
                Letters</button>
              <button class="lib-tab" data-lib-tab="pitches" onclick="switchLibraryTab('pitches')">üöÄ Elevator
                Pitches</button>
              <button class="lib-tab" data-lib-tab="interview-prep" onclick="switchLibraryTab('interview-prep')">üéØ
                Interview Prep</button>
            </div>
          </div>

          <div class="modal-body" id="library-content" style="overflow-y: auto; padding: 20px 0; flex-grow: 1;">
            <!-- Filled by JS based on active tab -->
          </div>
        </div>
      </div>

      <!-- User Guide Modal -->
      <div class="modal-overlay" id="guide-modal">
        <div class="modal large" style="max-width: 900px; max-height: 85vh; display: flex; flex-direction: column;">
          <button class="modal-close" onclick="closeModalById('guide-modal')">&times;</button>
          <div class="modal-header">
            <h2>üìñ User Guide & Feature Roadmap</h2>
            <p>Master JobMatch AI to land your next interview faster</p>
          </div>
          <div class="modal-body" style="overflow-y: auto; padding: 0 10px;">
            <div class="guide-section" style="margin-bottom: 24px;">
              <h3 style="display: flex; align-items: center; gap: 10px; color: #f59e0b;">üéØ 1. Resume Analysis</h3>
              <p style="color: #64748b; line-height: 1.6;">The core of JobMatch AI. Upload your resume and a job
                description
                to get an instant match score.
                Use the <b>Deep Diagnosis</b> to find specific gaps in your skills or keywords.</p>
            </div>
            <div class="guide-section" style="margin-bottom: 24px;">
              <h3 style="display: flex; align-items: center; gap: 10px; color: #f59e0b;">üíº 2. Job Matching</h3>
              <p style="color: #64748b; line-height: 1.6;">Don't just search‚Äîmatch. We use your profile to find relevant
                roles across 15+ major job boards and ATS systems.
                The <b>Fresh Jobs</b> section finds roles posted directly on company career pages.</p>
            </div>
            <div class="guide-section" style="margin-bottom: 24px;">
              <h3 style="display: flex; align-items: center; gap: 10px; color: #f59e0b;">üìù 3. Resume Optimizer</h3>
              <p style="color: #64748b; line-height: 1.6;">Tailor your resume for every application. The optimizer
                adjusts
                your bullet points for ATS compatibility while maintaining a professional "human" flow.</p>
            </div>
            <div class="guide-section" style="margin-bottom: 24px;">
              <h3 style="display: flex; align-items: center; gap: 10px; color: #f59e0b;">üè¢ 4. Target Companies</h3>
              <p style="color: #64748b; line-height: 1.6;">Keep a list of your dream companies. We'll help you search
                specifically for openings at those organizations and track your progress.</p>
            </div>
            <div class="guide-section" style="margin-bottom: 24px;">
              <h3 style="display: flex; align-items: center; gap: 10px; color: #f59e0b;">üë• 5. Networking (ICA)</h3>
              <p style="color: #64748b; line-height: 1.6;">Import your LinkedIn connections to identify "Advocates" who
                can
                give you internal referrals‚Äîthe #1 way to get past the initial screening.</p>
            </div>
            <div class="guide-section"
              style="background: rgba(245, 158, 11, 0.05); padding: 24px; border-radius: 16px; border: 1px dashed #f59e0b; margin-top: 20px;">
              <h3 style="color: #d97706; margin-bottom: 12px;">üöÄ Coming Soon</h3>
              <ul style="margin-left: 20px; color: #475569; display: flex; flex-direction: column; gap: 8px;">
                <li><b>Auto-Apply Bot:</b> Let AI handle the tedious application forms.</li>
                <li><b>AI Interviewer:</b> Real-time voice practice with mock interviews.</li>
                <li><b>Salary Insights:</b> Know your worth with AI-powered market data.</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer" style="padding: 20px 0 0 0;">
            <button class="btn btn-primary" onclick="closeModalById('guide-modal')">Got it, thanks!</button>
          </div>
        </div>
      </div>

      <div class="container">
        <!-- NEW HOME SECTION -->
        <section class="section" id="tab-home">
          <div class="home-hero">
            <div class="home-hero-content">
              <div class="home-badge">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                </svg>
                Stand out from the competition
              </div>

              <h1 class="home-title">
                Land Your Dream Job with
                <span class="home-highlight">Confidence</span>
              </h1>

              <p class="home-description">
                Transform your resume into interview-winning applications. Our AI analyzes job descriptions and creates
                personalized materials that get you noticed.
              </p>

              <div class="home-cta-buttons">
                <button class="home-cta-primary" onclick="switchTab('analyze')">
                  üîç Analyze Resume Match
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14m-7-7l7 7-7 7" />
                  </svg>
                </button>
                <button class="home-cta-secondary" onclick="switchTab('search')">
                  üíº Search Jobs
                </button>
              </div>

              <!-- Stats -->
              <div class="home-stats">
                <div class="home-stat">
                  <div class="home-stat-number">94%</div>
                  <div class="home-stat-label">Success Rate</div>
                </div>
                <div class="home-stat">
                  <div class="home-stat-number">2.5x</div>
                  <div class="home-stat-label">More Interviews</div>
                </div>
                <div class="home-stat">
                  <div class="home-stat-number">50k+</div>
                  <div class="home-stat-label">Jobs Matched</div>
                </div>
              </div>
            </div>

            <!-- Preview Card -->
            <div class="home-preview">
              <div class="home-preview-card">
                <h3 class="home-preview-title">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
                  </svg>
                  Resume vs Job Description
                </h3>

                <div class="home-upload-preview" onclick="switchTab('analyze')">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" />
                  </svg>
                  <p>Upload Your Resume</p>
                  <span>PDF, DOC, or DOCX</span>
                </div>

                <button class="home-preview-cta" onclick="switchTab('analyze')">
                  üîç Analyze Resume Match
                </button>
              </div>
            </div>
          </div>

          <!-- Features Section -->
          <div class="home-features">
            <h2 class="home-features-title">Everything You Need to Stand Out</h2>
            <p class="home-features-subtitle">One analysis, four powerful tools to accelerate your job search</p>

            <div class="home-features-grid">
              <div class="home-feature-card" onclick="switchTab('analyze')">
                <div class="home-feature-icon">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 6v6l4 2" />
                  </svg>
                </div>
                <h3>Match Score</h3>
                <p>Get an instant compatibility score between your resume and job description</p>
              </div>

              <div class="home-feature-card" onclick="switchTab('analyze')">
                <div class="home-feature-icon">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
                  </svg>
                </div>
                <h3>Cover Letter</h3>
                <p>Generate tailored cover letters that highlight your relevant experience</p>
              </div>

              <div class="home-feature-card" onclick="switchTab('networking')">
                <div class="home-feature-icon">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" />
                  </svg>
                </div>
                <h3>Referral Messages</h3>
                <p>Craft compelling messages to request referrals from your network</p>
              </div>

              <div class="home-feature-card" onclick="switchTab('analyze')">
                <div class="home-feature-icon">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
                  </svg>
                </div>
                <h3>Elevator Pitch</h3>
                <p>Create a powerful 30-second pitch customized for each opportunity</p>
              </div>

              <!-- PRO FEATURE CARD -->
              <div class="home-feature-card pro" onclick="window.location.href='/upgrade.html'">
                <div class="home-feature-icon">üíé</div>
                <h3>Go Pro</h3>
                <p>Unlock deep diagnosis, unlimited matches, and interview prep.</p>
                <div style="margin-top: 12px; font-weight: 700; color: #f59e0b;">View Plans ‚Üí</div>
              </div>
            </div>
          </div>

          <!-- BMC Support Section -->
          <div
            style="margin-top: 60px; text-align: center; padding: 40px; background: rgba(245, 158, 11, 0.05); border-radius: 20px; border: 1px dashed rgba(245, 158, 11, 0.2);">
            <h3 style="margin-bottom: 20px;">Support the Mission ‚òï</h3>
            <p style="color: #64748b; margin-bottom: 24px; max-width: 500px; margin-inline: auto;">
              JobMatch AI is a labor of love. If it helped you, consider supporting the developer!
            </p>
            <a href="https://www.buymeacoffee.com/aravind.thiyaga" target="_blank">
              <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee"
                style="height: 50px !important; width: 181px !important;">
            </a>
          </div>
        </section>

        <!-- TAB 1: ANALYZE RESUME -->
        <section class="section active" id="tab-analyze">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üöÄ Stand Out Instantly</h2>
              <p class="card-subtitle">Get expert, actionable feedback on how to make your resume an interview magnet
              </p>
            </div>

            <div class="grid-2">
              <div>
                <label style="font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 8px;">Your
                  Resume</label>
                <div class="upload-zone" id="analyze-upload-zone">
                  <input type="file" id="analyze-resume-input" accept=".pdf,.doc,.docx">
                  <div class="upload-icon">üìÑ</div>
                  <div style="color: #94a3b8;">Drop resume or click to browse</div>
                  <div class="file-name" id="analyze-file-name"></div>
                </div>
              </div>
              <div>
                <label style="font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 8px;">Job
                  Description</label>
                <textarea id="job-description" placeholder="Paste the complete job description here..."></textarea>
              </div>
            </div>

            <div style="margin-top: 16px;">
              <label style="font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 8px;">
                ü§ñ AI Model
                <span style="color: #64748b; font-size: 0.8rem;">(Choose which LLM to analyze your resume)</span>
              </label>
              <select id="llm-provider-select"
                style="width: 100%; padding: 12px; background: #1e293b; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 0.95rem;">
                <option value="">Loading providers...</option>
              </select>
            </div>

            <button class="btn btn-primary btn-full mt-4" id="analyze-btn" disabled>
              <span id="analyze-btn-text">üéØ Analyze My Match</span>
              <span class="loading" id="analyze-loading" style="display:none"></span>
            </button>
          </div>

          <!-- Analysis Results -->
          <div id="analysis-results" style="display:none">
            <!-- Filled by JS -->
          </div>
        </section>

        <!-- TAB 2: FIND JOBS -->
        <section class="section" id="tab-search">
          <!-- Upload Profile First -->
          <div class="card" id="search-upload-card">
            <div class="card-header">
              <h2 class="card-title">üíº Upload Resume to Find Matching Jobs</h2>
              <p class="card-subtitle">We'll analyze your profile and find jobs ranked by how well YOU match</p>
            </div>

            <div class="upload-zone" id="search-upload-zone">
              <input type="file" id="search-resume-input" accept=".pdf,.doc,.docx">
              <div class="upload-icon">üìÑ</div>
              <div style="color: #94a3b8;">Drop resume or click to browse</div>
              <div class="file-name" id="search-file-name"></div>
            </div>

            <button class="btn btn-primary btn-full mt-4" id="extract-btn" disabled>
              <span id="extract-btn-text">üöÄ Search Jobs with My Resume</span>
              <span class="loading" id="extract-loading" style="display:none"></span>
            </button>
          </div>

          <!-- Profile Display -->
          <div class="card" id="profile-card" style="display:none">
            <div class="flex justify-between items-center mb-4">
              <div>
                <h3 id="profile-name">Your Name</h3>
                <p class="text-muted" id="profile-title">Your Title</p>
              </div>
              <button class="btn btn-primary" id="search-jobs-btn">
                <span id="search-btn-text">üîç Search Jobs</span>
                <span class="loading" id="search-loading" style="display:none"></span>
              </button>
            </div>

            <div class="flex gap-2 flex-wrap mb-4">
              <span class="tag tag-info" id="profile-exp">- years</span>
              <span class="tag tag-info" id="profile-level">-</span>
              <span class="tag tag-info" id="profile-location">-</span>
            </div>

            <div class="flex gap-4 mb-4">
              <input type="text" class="input" id="search-query" placeholder="Job title or keywords..." style="flex:1">
              <input type="text" class="input" id="search-location" placeholder="Location" style="width:150px">
              <select class="input" id="search-date-posted" style="width:140px">
                <option value="month">Past Month</option>
                <option value="week">Past Week</option>
                <option value="today">Past 24h</option>
                <option value="any">Any Time</option>
              </select>
            </div>

            <div>
              <label style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px; display: block;">Your Skills:</label>
              <div id="profile-skills" class="flex gap-2 flex-wrap"></div>
            </div>
          </div>

          <!-- Job Results -->
          <div id="job-results" style="display:none">
            <!-- FRESH JOBS AT TOP -->
            <div class="card"
              style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.05)); border-color: rgba(245, 158, 11, 0.3);">
              <h3 style="color: #f59e0b; margin-bottom: 8px;">üî• Fresh Jobs from Company Career Pages</h3>
              <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 16px;">Search directly from ATS systems
                (Workday,
                Greenhouse, Lever, etc.) - Real job postings!</p>

              <div id="fresh-jobs-links" class="flex gap-2 flex-wrap mb-4"></div>

              <div class="flex gap-2 flex-wrap">
                <div id="fresh-jobs-all"></div>
                <div id="fresh-jobs-24h"></div>
              </div>
            </div>

            <!-- Smart Search Links -->
            <div class="card" id="search-links-card">
              <h3 class="mb-4">üîó Job Board Search Links</h3>
              <p class="text-muted mb-4">Click to search major job boards with your profile:</p>

              <div id="primary-links" class="flex gap-4 flex-wrap mb-4"></div>

              <div class="divider"></div>

              <div class="search-links-grid">
                <div>
                  <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üéØ Search by Your Target Roles
                  </h4>
                  <div id="title-links"></div>
                </div>
                <div>
                  <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üí° Search by Your Skills</h4>
                  <div id="skill-links" class="flex flex-wrap gap-2"></div>
                </div>
              </div>

              <div class="divider"></div>

              <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üåê General Job Boards</h4>
              <div id="secondary-links" class="flex gap-2 flex-wrap mb-4"></div>

              <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üíª Tech & Startups</h4>
              <div id="tech-links" class="flex gap-2 flex-wrap mb-4"></div>

              <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üè† Remote Jobs</h4>
              <div id="remote-links" class="flex gap-2 flex-wrap mb-4"></div>

              <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üå± Non-Profit & Social Impact</h4>
              <div id="non-profit-links" class="flex gap-2 flex-wrap"></div>
            </div>

            <!-- AI Suggestions -->
            <div id="suggestions-section" style="display: none;">
              <div class="flex justify-between items-center mb-4">
                <h3>üí° Suggested Matches (<span id="jobs-count">0</span>)</h3>
                <div class="flex gap-2">
                  <button class="btn btn-sm btn-secondary filter-btn active" data-filter="all">All</button>
                  <button class="btn btn-sm btn-secondary filter-btn" data-filter="excellent">üü¢ Best</button>
                  <button class="btn btn-sm btn-secondary filter-btn" data-filter="good">üîµ Good</button>
                </div>
              </div>
              <p class="text-muted mb-4" style="font-size: 0.9rem;">Based on your profile, here are roles worth
                exploring:
              </p>
              <div id="job-list"></div>
            </div>
          </div>
        </section>

        <section class="section" id="tab-optimizer">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üìù Resume Optimizer</h2>
              <p class="card-subtitle">Transform your resume for maximum ATS compatibility and interview conversion</p>
            </div>

            <div class="grid-2" style="margin-top: 24px; gap: 32px;">
              <!-- Upload Resume -->
              <div>
                <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: #1E293B;">Your Resume</h3>
                <div class="upload-zone" id="optimizer-upload-zone"
                  style="background: #F8FAFC; border: 2px dashed #CBD5E1;">
                  <div class="upload-icon" style="font-size: 3rem;">üìÑ</div>
                  <h3 style="color: #1E293B; margin: 12px 0 8px;">Drop resume or click to browse</h3>
                  <p style="color: #64748B;">PDF, DOC, or DOCX</p>
                  <input type="file" id="optimizer-resume-input" accept=".pdf,.doc,.docx" style="display:none">
                </div>
                <div id="optimizer-file-name"
                  style="margin-top: 12px; color: #10B981; font-weight: 500; display: none;"></div>
              </div>

              <!-- Job Description -->
              <div>
                <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: #1E293B;">Target Job Description</h3>
                <textarea id="optimizer-job-description" placeholder="Paste the job description here..."
                  style="width: 100%; min-height: 240px; padding: 16px; background: white; border: 2px solid #E2E8F0; border-radius: 12px; color: #1E293B; font-family: inherit; resize: vertical; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);"></textarea>
              </div>
            </div>

            <button class="btn btn-primary btn-full" id="optimize-resume-btn"
              style="margin-top: 32px; height: 56px; font-size: 1.1rem; background: linear-gradient(135deg, #FF9500, #FF5E00); box-shadow: 0 4px 12px rgba(255, 149, 0, 0.2);"
              disabled>
              <span id="optimize-btn-text">üöÄ Optimize My Resume</span>
              <span class="loading" id="optimize-loading" style="display:none"></span>
            </button>
          </div>

          <!-- Results Section (Hidden Initially) -->
          <div id="optimizer-results" style="display: none; margin-top: 24px;">
            <!-- Will be populated with results -->
          </div>
        </section>

        <!-- TAB 4: Target Companies -->
        <section class="section" id="tab-target-companies">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üè¢ Target Companies</h2>
              <p class="card-subtitle">Manage your dream companies and search for jobs specifically at those
                organizations
              </p>
            </div>

            <!-- Stats Overview -->
            <div id="target-companies-stats" class="grid-4" style="margin-bottom: 24px; display: none;">
              <div class="stat-card">
                <div class="stat-value" id="stat-total-companies">0</div>
                <div class="stat-label">Target Companies</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat-new-jobs">0</div>
                <div class="stat-label">New Jobs Found</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat-high-priority">0</div>
                <div class="stat-label">High Priority</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat-total-jobs">0</div>
                <div class="stat-label">Total Jobs</div>
              </div>
            </div>

            <div class="company-search-container" style="max-width: 600px; margin: 0 auto 32px auto;">
              <div class="search-input-wrapper" style="width: 100%;">
                <input type="text" id="company-search-input" class="input" placeholder="üîç Find my dream companies..."
                  oninput="handleCompanySearch(this.value)"
                  style="height: 48px; font-size: 1.1rem; padding-left: 20px;">
                <div id="company-search-suggestions" class="search-suggestions"></div>
              </div>
              <button class="btn btn-secondary" onclick="showAddCompanyModal()"
                style="height: 48px; white-space: nowrap;">
                ‚ûï Custom
              </button>
            </div>

            <!-- Discovery / Results Container -->
            <div id="discovery-container" style="display: none; border-top: 1px solid #F1F5F9; padding-top: 24px;">
              <div class="flex justify-between items-center mb-6">
                <h3 id="discovery-title">üî• Discover Popular Companies</h3>
                <button class="btn btn-secondary btn-sm" onclick="runMigration()">üõ† Re-Sync Data</button>
              </div>
              <div id="discovery-grid" class="discovery-grid">
                <!-- Populated by JS -->
              </div>
            </div>

            <!-- Companies List -->
            <div id="companies-container">
              <div id="empty-companies-state"
                style="text-align: center; padding: 60px 20px; color: #64748b; background: #F8FAFC; border-radius: 16px; border: 2px dashed #E2E8F0;">
                <div style="font-size: 4rem; margin-bottom: 20px;">üè¢</div>
                <h2 style="color: #1E293B; margin-bottom: 12px;">Start your target list</h2>
                <p style="font-size: 1.1rem; max-width: 500px; margin: 0 auto 24px auto;">Search for companies above or
                  explore the popular choices below to get started.</p>
                <div class="spinner" id="discovery-loading" style="display: none; margin: 0 auto;"></div>
              </div>
            </div>
          </div>

          <!-- Jobs Found at Target Companies -->
          <div class="card" id="target-company-jobs-card" style="display: none;">
            <div class="card-header">
              <h2 class="card-title">üìã Jobs at Target Companies</h2>
              <p class="card-subtitle">Openings discovered at your target companies</p>
            </div>
            <div id="target-company-jobs-container"></div>
          </div>
        </section>

        <!-- TAB 5: Networking (ICA) -->
        <section class="section" id="tab-networking">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üë• LinkedIn Contact Advocates (ICA)</h2>
              <p class="card-subtitle">Import and categorize your LinkedIn contacts by opportunity potential</p>
            </div>

            <!-- Upload Section -->
            <div class="upload-zone" id="ica-dropzone"
              style="margin-top: 20px; background: #F8FAFC; border: 2px dashed #E2E8F0; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s ease;">
              <div class="upload-icon" style="font-size: 2.5rem; margin-bottom: 12px;">üìÑ</div>
              <h3 style="color: #1E293B; margin-bottom: 8px;">Drag & drop your LinkedIn Connections.csv</h3>
              <p style="color: #64748b;">or <span class="browse" style="color: #FF7A00; font-weight: 600;">browse
                  files</span></p>
              <input type="file" id="ica-file-input" accept=".csv" style="display: none;">
            </div>

            <div id="ica-file-preview"
              style="display: none; margin-top: 16px; padding: 16px; background: #FFF4EB; border: 1px solid #FFE2CC; border-radius: 12px; align-items: center; gap: 12px;">
              <div
                style="background: #FF7A00; color: white; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                üìä</div>
              <div style="flex: 1;">
                <div id="ica-filename" style="font-weight: 600; color: #1E293B;">Connections.csv</div>
                <div style="font-size: 0.85rem; color: #64748b;">Ready to analyze</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button id="ica-upload-btn" class="btn btn-sm"
                  style="background: #FF7A00; color: white; border: none;">Upload & Analyze</button>
                <button id="ica-cancel-btn" class="btn btn-sm"
                  style="background: white; color: #64748b; border: 1px solid #E2E8F0;">Cancel</button>
              </div>
            </div>

            <div id="ica-status"
              style="margin-top: 12px; padding: 12px; border-radius: 8px; display: none; font-size: 0.9rem; font-weight: 500;">
            </div>
          </div>

          <!-- Stats Card -->
          <div class="card" id="ica-stats-card"
            style="display: none; margin-top: 24px; border: none; background: transparent; padding: 0;">
            <div class="grid-4"
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div class="stat-card"
                style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #E2E8F0; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                <div class="stat-number" id="ica-stat-total" style="font-size: 2rem; font-weight: 800; color: #1E293B;">
                  0</div>
                <div class="stat-label" style="color: #64748b; font-size: 0.9rem; margin-top: 4px;">Total Contacts</div>
              </div>
              <div class="stat-card"
                style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #E2E8F0; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-bottom: 4px solid #22c55e;">
                <div class="stat-number" id="ica-stat-high" style="font-size: 2rem; font-weight: 800; color: #22c55e;">0
                </div>
                <div class="stat-label" style="color: #64748b; font-size: 0.9rem; margin-top: 4px;">High Potential</div>
              </div>
              <div class="stat-card"
                style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #E2E8F0; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-bottom: 4px solid #f59e0b;">
                <div class="stat-number" id="ica-stat-medium"
                  style="font-size: 2rem; font-weight: 800; color: #f59e0b;">0</div>
                <div class="stat-label" style="color: #64748b; font-size: 0.9rem; margin-top: 4px;">Medium Potential
                </div>
              </div>
              <div class="stat-card"
                style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #E2E8F0; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-bottom: 4px solid #ef4444;">
                <div class="stat-number" id="ica-stat-low" style="font-size: 2rem; font-weight: 800; color: #ef4444;">0
                </div>
                <div class="stat-label" style="color: #64748b; font-size: 0.9rem; margin-top: 4px;">Low Potential</div>
              </div>
            </div>
          </div>

          <!-- Contacts Card -->
          <div class="card" id="ica-contacts-card" style="display: none; margin-top: 24px;">
            <div class="card-header"
              style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; border-bottom: 1px solid #F1F5F9; padding-bottom: 20px; margin-bottom: 20px;">
              <div>
                <h3 class="card-title" style="font-size: 1.25rem;">Your Network</h3>
                <p class="card-subtitle">Connect with insiders at your target companies</p>
              </div>
              <div style="display: flex; gap: 12px; flex-grow: 1; justify-content: flex-end; max-width: 600px;">
                <div style="position: relative; flex-grow: 1;">
                  <span
                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94A3B8;">üîç</span>
                  <input type="text" id="ica-search" placeholder="Search by name, company or role..."
                    style="width: 100%; padding: 10px 12px 10px 36px; border: 1px solid #E2E8F0; border-radius: 10px; background: white; color: #1E293B;">
                </div>
                <select id="ica-filter"
                  style="padding: 10px 16px; border: 1px solid #E2E8F0; border-radius: 10px; background: white; color: #1E293B; font-weight: 500;">
                  <option value="all">All Layers</option>
                  <option value="high_potential">üî• High Potential</option>
                  <option value="medium_potential">‚ö° Medium Potential</option>
                  <option value="low_potential">üí§ Low Potential</option>
                  <option value="uncategorized">‚ùì Uncategorized</option>
                </select>
              </div>
            </div>

            <div id="ica-contacts-grid" class="discovery-grid" style="margin-top: 16px;">
              <!-- Contacts will be rendered here as cards -->
              <div
                style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #64748b; background: #F8FAFC; border-radius: 16px; border: 2px dashed #E2E8F0;">
                <div style="font-size: 3rem; margin-bottom: 16px;">üìá</div>
                <h3 style="color: #1E293B;">Your network is empty</h3>
                <p>Upload your LinkedIn Contacts CSV to unlock referral opportunities.</p>
              </div>
            </div>

            <!-- Compatibility table for original logic if needed, hidden -->
            <table style="display: none;">
              <tbody id="ica-contacts-tbody"></tbody>
            </table>
          </div>
        </section>

        <!-- TAB: Community -->
        <section class="section" id="tab-community">
          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <h2 class="card-title">üí¨ Community</h2>
                <p class="card-subtitle">Connect, share experiences, and support each other on your job search journey
                </p>
              </div>
              <button class="btn btn-primary" onclick="showCreatePostModal()" style="white-space: nowrap;">
                ‚ûï New Post
              </button>
            </div>

            <!-- Filter and Sort Controls -->
            <div style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
              <div style="display: flex; gap: 8px; flex-wrap: wrap; flex: 1;">
                <button class="btn btn-sm" onclick="filterCommunity('all')" id="filter-all"
                  style="background: #FF9500; color: white;">All</button>
                <button class="btn btn-secondary btn-sm" onclick="filterCommunity('success_story')"
                  id="filter-success_story">üéâ Success</button>
                <button class="btn btn-secondary btn-sm" onclick="filterCommunity('question')" id="filter-question">‚ùì
                  Questions</button>
                <button class="btn btn-secondary btn-sm" onclick="filterCommunity('advice')" id="filter-advice">üí°
                  Advice</button>
                <button class="btn btn-secondary btn-sm" onclick="filterCommunity('vent')" id="filter-vent">üò§
                  Venting</button>
                <button class="btn btn-secondary btn-sm" onclick="filterCommunity('resource')" id="filter-resource">üìö
                  Resources</button>
              </div>
              <select id="community-sort" onchange="loadCommunityPosts()" class="input"
                style="width: auto; height: 40px; background: white;">
                <option value="recent">üìÖ Recent</option>
                <option value="popular">üî• Popular</option>
                <option value="trending">‚ö° Trending</option>
              </select>
            </div>

            <!-- Posts Feed -->
            <div id="community-feed" style="display: flex; flex-direction: column; gap: 16px;">
              <!-- Posts will be loaded here -->
            </div>

            <!-- Loading State -->
            <div id="community-loading" style="text-align: center; padding: 60px; display: none;">
              <div class="spinner" style="margin: 0 auto 16px;"></div>
              <p style="color: #64748B;">Loading posts...</p>
            </div>

            <!-- Empty State -->
            <div id="community-empty"
              style="text-align: center; padding: 80px 40px; color: #64748b; background: #F8FAFC; border-radius: 16px; display: none;">
              <div style="font-size: 4rem; margin-bottom: 24px;">üí¨</div>
              <h3 style="font-size: 1.8rem; margin-bottom: 12px; color: #1E293B;">Start the conversation</h3>
              <p
                style="margin-bottom: 32px; line-height: 1.6; max-width: 500px; margin-left: auto; margin-right: auto;">
                Be the first to share your experience, ask a question, or offer advice to fellow job seekers.</p>
              <button class="btn btn-primary" onclick="showCreatePostModal()"
                style="padding: 16px 48px; border-radius: 50px;">Create First Post</button>
            </div>

            <!-- Load More -->
            <div id="community-load-more" style="text-align: center; margin-top: 24px; display: none;">
              <button class="btn btn-secondary" onclick="loadMorePosts()">Load More Posts</button>
            </div>
          </div>
        </section>

        <!-- TAB 6: Mock Interview -->
        <section class="section" id="tab-mock-interview">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üéØ AI Mock Interview</h2>
              <p class="card-subtitle">Practice your interview skills with AI-powered feedback and video analysis</p>
            </div>

            <!-- Setup Form -->
            <div id="mock-interview-setup" style="max-width: 600px; margin: 24px auto;">
              <div class="form-group" style="margin-bottom: 20px;">
                <label for="mock-job-role"
                  style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">Target Job Role</label>
                <input type="text" id="mock-job-role" class="input"
                  placeholder="e.g., Software Engineer, Product Manager" style="width: 100%; height: 48px;" required>
              </div>

              <!-- Job Description Field -->
              <div class="form-group" style="margin-bottom: 20px;">
                <label for="mock-job-description"
                  style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">
                  Job Description <span style="color: #94a3b8; font-weight: 400; font-size: 0.9rem;">(Optional)</span>
                </label>
                <textarea id="mock-job-description" class="input"
                  placeholder="Paste the job description here to get more tailored interview questions..."
                  style="width: 100%; min-height: 120px; padding: 12px; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 12px; color: #1E293B; font-family: inherit; resize: vertical; font-size: 0.95rem; line-height: 1.5;"></textarea>
                <small style="color: #64748B; font-size: 0.85rem; display: block; margin-top: 6px;">
                  üí° Adding a job description helps generate questions specific to the role's requirements
                </small>
              </div>

              <div class="grid-2" style="gap: 16px; margin-bottom: 24px;">
                <div class="form-group">
                  <label for="mock-interview-type"
                    style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">Interview Type</label>
                  <select id="mock-interview-type" class="input" style="width: 100%; height: 48px; background: white;">
                    <option value="technical">Technical</option>
                    <option value="behavioral">Behavioral</option>
                    <option value="mixed">Mixed</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="mock-duration"
                    style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">Duration</label>
                  <select id="mock-duration" class="input" style="width: 100%; height: 48px; background: white;">
                    <option value="15">15 minutes</option>
                    <option value="30">30 minutes (Standard)</option>
                    <option value="45">45 minutes (Deep Session)</option>
                  </select>
                </div>
              </div>

              <button class="btn btn-primary btn-full" onclick="startMockInterview()"
                style="height: 56px; font-size: 1.1rem; background: linear-gradient(135deg, #6366F1, #4F46E5); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);">
                üéØ Start Practice Session
              </button>
            </div>

            <!-- Interview Session (Hidden initially) -->
            <div id="mock-interview-session" style="display: none; animation: fadeIn 0.5s ease;">
              <div class="card"
                style="background: #F8FAFC; border: 1px solid #E2E8F0; margin-bottom: 24px; padding: 32px; text-align: center;">
                <div id="mock-question-number"
                  style="color: #6366f1; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px;">
                  Question 1 of 5
                </div>
                <div id="mock-question-text"
                  style="font-size: 1.5rem; font-weight: 700; line-height: 1.4; color: #1E293B;">Loading interview
                  question...</div>
              </div>

              <div
                style="background: #0F172A; border-radius: 16px; overflow: hidden; margin: 0 auto 24px auto; max-width: 500px; max-height: 350px; position: relative; box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);">
                <video id="mock-preview-video" autoplay muted
                  style="width: 100%; height: 100%; object-fit: cover;"></video>
                <div id="mock-timer"
                  style="position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); padding: 6px 20px; border-radius: 50px; font-size: 1.2rem; font-weight: 700; color: white; border: 1px solid rgba(255,255,255,0.2);">
                  00:00
                </div>
              </div>

              <div style="display: flex; gap: 16px; justify-content: center; margin-top: 32px;">
                <button class="btn btn-secondary" id="mock-start-recording-btn" onclick="startMockRecording()"
                  style="background: #FEE2E2; color: #DC2626; border: none; padding: 12px 32px;">
                  üî¥ Start Recording
                </button>
                <button class="btn btn-primary" id="mock-stop-recording-btn" onclick="stopMockRecording()"
                  style="display: none; background: #1E293B; color: white;">‚èπÔ∏è Stop Recording</button>
                <button class="btn btn-primary" id="mock-next-question-btn" onclick="nextMockQuestion()"
                  style="display: none; padding: 12px 40px;">‚û°Ô∏è Next Question</button>
              </div>
            </div>

            <!-- Results (Hidden initially) -->
            <div id="mock-interview-results" style="display: none; animation: slideUp 0.6s ease;">
              <div style="text-align: center; margin-bottom: 40px;">
                <div style="font-size: 3rem; margin-bottom: 16px;">üéä</div>
                <h2 style="font-size: 2rem; color: #1E293B;">Interview Analysis Ready</h2>
                <p style="color: #64748B;">Our AI has analyzed your performance, body language, and technical accuracy.
                </p>
              </div>

              <div class="grid-4" style="margin-bottom: 32px; gap: 20px;">
                <div class="card" style="text-align: center; border-bottom: 4px solid #6366F1;">
                  <div
                    style="font-size: 0.8rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">
                    Overall</div>
                  <div id="mock-overall-score" style="font-size: 2.8rem; font-weight: 800; color: #1E293B;">--</div>
                </div>
                <div class="card" style="text-align: center; border-bottom: 4px solid #22C55E;">
                  <div
                    style="font-size: 0.8rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">
                    Communication</div>
                  <div id="mock-communication-score" style="font-size: 2.8rem; font-weight: 800; color: #1E293B;">--
                  </div>
                </div>
                <div class="card" style="text-align: center; border-bottom: 4px solid #F59E0B;">
                  <div
                    style="font-size: 0.8rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">
                    Technical</div>
                  <div id="mock-technical-score" style="font-size: 2.8rem; font-weight: 800; color: #1E293B;">--</div>
                </div>
                <div class="card" style="text-align: center; border-bottom: 4px solid #8B5CF6;">
                  <div
                    style="font-size: 0.8rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">
                    Confidence</div>
                  <div id="mock-confidence-score" style="font-size: 2.8rem; font-weight: 800; color: #1E293B;">--</div>
                </div>
              </div>

              <div class="grid-2" style="gap: 24px; margin-bottom: 32px;">
                <div class="card" style="border-left: 6px solid #22c55e;">
                  <h4
                    style="margin-bottom: 16px; color: #166534; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                    ‚úÖ Key Strengths
                  </h4>
                  <ul id="mock-strengths-list"
                    style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: 12px; color: #334155;">
                  </ul>
                </div>

                <div class="card" style="border-left: 6px solid #f59e0b;">
                  <h4
                    style="margin-bottom: 16px; color: #9a3412; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                    üìà Areas for Growth
                  </h4>
                  <ul id="mock-improvements-list"
                    style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: 12px; color: #334155;">
                  </ul>
                </div>
              </div>

              <div style="display: flex; justify-content: center; gap: 16px;">
                <button class="btn btn-primary" onclick="resetMockInterview()" style="padding: 12px 40px;">üîÑ Start New
                  Session</button>
                <button class="btn btn-secondary" onclick="switchTab('interview-dashboard')"
                  style="padding: 12px 40px; background: white; border: 1px solid #E2E8F0;">üìä View Dashboard</button>
              </div>
            </div>
          </div>
        </section>

        <!-- TAB 7: Interview Dashboard -->
        <section class="section" id="tab-interview-dashboard">
          <div class="card">
            <div class="card-header"
              style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px;">
              <div>
                <h2 class="card-title">üìä Activity Dashboard</h2>
                <p class="card-subtitle">Your interview progress, performance trends, and history</p>
              </div>
              <button class="btn btn-primary" onclick="switchTab('mock-interview')">
                üÜï New Session
              </button>
            </div>

            <div id="dashboard-error-message" class="error"
              style="display: none; background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            </div>

            <div id="dashboard-loading"
              style="text-align: center; padding: 80px 40px; color: #64748b; background: #F8FAFC; border-radius: 16px;">
              <div class="spinner" style="margin: 0 auto 16px;"></div>
              <div style="font-weight: 500;">Analyzing your interview records...</div>
            </div>

            <div id="dashboard-content" style="display: none;">
              <!-- Summary Stats -->
              <div class="grid-4" style="margin-bottom: 40px; gap: 16px;">
                <div class="stat-card"
                  style="background: white; border: 1px solid #E2E8F0; padding: 24px; border-radius: 12px;">
                  <div
                    style="font-size: 0.8rem; font-weight: 700; color: #64748B; text-transform: uppercase; margin-bottom: 12px;">
                    Total Sessions</div>
                  <div id="total-interviews" style="font-size: 2.2rem; font-weight: 800; color: #6366F1;">0</div>
                </div>
                <div class="stat-card"
                  style="background: white; border: 1px solid #E2E8F0; padding: 24px; border-radius: 12px;">
                  <div
                    style="font-size: 0.8rem; font-weight: 700; color: #64748B; text-transform: uppercase; margin-bottom: 12px;">
                    Completed</div>
                  <div id="completed-interviews" style="font-size: 2.2rem; font-weight: 800; color: #10B981;">0</div>
                </div>
                <div class="stat-card"
                  style="background: white; border: 1px solid #E2E8F0; padding: 24px; border-radius: 12px;">
                  <div
                    style="font-size: 0.8rem; font-weight: 700; color: #64748B; text-transform: uppercase; margin-bottom: 12px;">
                    Avg Score</div>
                  <div id="average-score" style="font-size: 2.2rem; font-weight: 800; color: #F59E0B;">--</div>
                </div>
                <div class="stat-card"
                  style="background: white; border: 1px solid #E2E8F0; padding: 24px; border-radius: 12px;">
                  <div
                    style="font-size: 0.8rem; font-weight: 700; color: #64748B; text-transform: uppercase; margin-bottom: 12px;">
                    Success Rate</div>
                  <div style="font-size: 2.2rem; font-weight: 800; color: #8B5CF6;">88%</div>
                </div>
              </div>

              <div class="flex justify-between items-center mb-6">
                <h3 style="color: #1E293B; font-weight: 700;">Recent Performance</h3>
                <div style="font-size: 0.85rem; color: #64748B;">Showing last 10 attempts</div>
              </div>

              <div id="interviews-list" style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                <!-- Filled by JS -->
              </div>
            </div>

            <!-- Empty State -->
            <div id="dashboard-empty-state"
              style="display: none; text-align: center; padding: 80px 40px; color: #64748b; background: #F8FAFC; border-radius: 16px;">
              <div style="font-size: 4rem; margin-bottom: 24px;">üéØ</div>
              <h3 style="font-size: 1.8rem; margin-bottom: 12px; color: #1E293B;">Ready to practice?</h3>
              <p
                style="margin-bottom: 32px; line-height: 1.6; max-width: 500px; margin-left: auto; margin-right: auto;">
                Start your first mock interview to get AI-powered feedback and track your progress toward landing that
                offer.</p>
              <button class="btn btn-primary" onclick="switchTab('mock-interview')"
                style="padding: 16px 48px; border-radius: 50px;">Start Your First Interview</button>
            </div>
          </div>
        </section>
      </div>

      <!-- Create Post Modal -->
      <div class="modal-overlay" id="create-post-modal"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal"
          style="max-width: 700px; background: white; border-radius: 16px; padding: 0; max-height: 90vh; overflow-y: auto;">
          <button class="modal-close" onclick="closeCreatePostModal()"
            style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 2rem; cursor: pointer; color: #64748B;">&times;</button>
          <div class="modal-header" style="padding: 24px; border-bottom: 1px solid #E2E8F0;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 4px;">‚úçÔ∏è Create New Post</h2>
            <p style="color: #64748B;">Share your experience, ask questions, or offer advice</p>
          </div>
          <div class="modal-body" style="padding: 24px;">
            <form id="create-post-form" onsubmit="submitCommunityPost(event)">
              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">Category</label>
                <select id="post-category" class="input" required style="width: 100%; height: 48px; background: white;">
                  <option value="">Select a category...</option>
                  <option value="success_story">üéâ Success Story</option>
                  <option value="question">‚ùì Question</option>
                  <option value="advice">üí° Advice</option>
                  <option value="vent">üò§ Venting</option>
                  <option value="resource">üìö Resource</option>
                </select>
              </div>

              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">Title</label>
                <input type="text" id="post-title" class="input" placeholder="Give your post a clear title..." required
                  style="width: 100%; height: 48px;">
              </div>

              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">Content</label>
                <textarea id="post-content" class="input"
                  placeholder="Share your thoughts, experiences, or questions..." required
                  style="width: 100%; min-height: 200px; padding: 16px; background: white; border: 2px solid #E2E8F0; border-radius: 12px; color: #1E293B; font-family: inherit; resize: vertical;"></textarea>
              </div>

              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">Tags
                  (optional)</label>
                <input type="text" id="post-tags" class="input"
                  placeholder="e.g., resume, interview, networking (comma-separated)"
                  style="width: 100%; height: 48px;">
                <small style="color: #64748B; font-size: 0.85rem;">Add tags to help others find your post</small>
              </div>

              <div class="form-group" style="margin-bottom: 24px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="post-anonymous" style="width: 18px; height: 18px;">
                  <span style="font-weight: 500; color: #475569;">Post anonymously</span>
                </label>
                <small style="color: #64748B; font-size: 0.85rem; margin-left: 26px;">Your name will be hidden from
                  other users</small>
              </div>

              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeCreatePostModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submit-post-btn">
                  <span id="submit-post-text">Publish Post</span>
                  <span class="loading" id="submit-post-loading" style="display:none"></span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Post Detail Modal -->
      <div class="modal-overlay" id="post-detail-modal"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal"
          style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; background: white; border-radius: 16px; overflow: hidden;">
          <button class="modal-close" onclick="closePostDetailModal()"
            style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 2rem; cursor: pointer; color: #64748B; z-index: 10;">&times;</button>
          <div class="modal-header" style="flex-shrink: 0; padding: 24px; border-bottom: 1px solid #E2E8F0;">
            <h2 id="detail-post-title" style="font-size: 1.5rem; font-weight: 700;">Post Title</h2>
          </div>
          <div class="modal-body" id="post-detail-content" style="overflow-y: auto; flex-grow: 1; padding: 24px;">
            <!-- Post detail will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Cover Letter Modal -->
      <div class="cl-modal" id="cover-letter-modal">
        <div class="cl-modal-content">
          <div class="cl-modal-header">
            <div>
              <h3>üìù Cover Letter</h3>
              <p class="text-muted" id="cl-job-info">For: Job at Company</p>
            </div>
            <button class="cl-modal-close" onclick="closeCoverLetterModal()">√ó</button>
          </div>
          <div class="cl-modal-body">
            <div class="cover-letter-box" id="cover-letter-text">Generating...</div>
            <div class="flex gap-2 mt-4">
              <button class="btn btn-primary" onclick="copyCoverLetter()">üìã Copy</button>
              <button class="btn btn-secondary" onclick="regenerateCoverLetter()">üîÑ Regenerate</button>
            </div>
          </div>
        </div>
      </div>

      <div class="toast" id="toast"></div>

      <script>
        // ========== UTILITIES ==========
        function copyToClipboard(text, btn) {
          // Decode escaped characters from template string
          const sanitizedText = text.replace(/\\`/g, '`').replace(/\\\${/g, '${');
          navigator.clipboard.writeText(sanitizedText).then(() => {
            const originalText = btn.innerHTML;
            const originalClass = btn.className;
            btn.innerHTML = '‚úÖ Copied!';
            btn.className = 'btn btn-success btn-sm';
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.className = originalClass;
            }, 2000);
          }).catch(err => {
            console.error('Failed to copy:', err);
            showToast('Failed to copy', 'error');
          });
        }

        function tailorForJob(jobId) {
          const job = (window.jobs || []).find(j => j.id === jobId) || (window.savedJobs || []).find(j => j.id === jobId);
          if (!job) {
            showToast('Job not found - try searching again', 'error');
            return;
          }

          // Populate analyze JD field
          const jdField = document.getElementById('analyze-jd');
          if (jdField) {
            const desc = job.description || job.quickTake || `${job.title} at ${job.company}`;
            jdField.value = desc;

            // Show success message
            showToast(`Ready to tailor for ${job.title}!`, 'success');

            // Switch to analyze tab
            switchTab('analyze');

            // Scroll to the JD field to reduce friction
            jdField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            jdField.focus();
          }
        }

        // ========== AUTH & USER STATE ==========
        let currentUser = JSON.parse(localStorage.getItem('jobmatch_user') || 'null');

        // ========== GLOBAL RESUME MANAGER ==========
        // This manages ONE resume upload that works across ALL features
        let globalResumeState = {
          file: null,
          fileName: null,
          sessionId: null,
          resumeText: null,
          profile: null,
          uploadedAt: null
        };

        // Try to restore from sessionStorage on page load
        function restoreGlobalResume() {
          const saved = sessionStorage.getItem('globalResumeState');
          if (saved) {
            try {
              const parsed = JSON.parse(saved);
              // Check if session is still valid (24 hours)
              if (parsed.uploadedAt && (Date.now() - parsed.uploadedAt < 24 * 60 * 60 * 1000)) {
                globalResumeState = {
                  ...parsed,
                  file: null // Can't serialize File object, will need to re-upload if needed
                };
                window.sessionId = globalResumeState.sessionId; // Backward compatibility
                updateGlobalResumeUI();
                return true;
              }
            } catch (e) {
              console.error('Failed to restore resume state:', e);
            }
          }
          return false;
        }

        function saveGlobalResumeState() {
          const toSave = {
            ...globalResumeState,
            file: null // Don't try to serialize File object
          };
          sessionStorage.setItem('globalResumeState', JSON.stringify(toSave));
        }

        function updateGlobalResumeUI() {
          const emptyState = document.getElementById('resume-empty-state');
          const loadedState = document.getElementById('resume-loaded-state');
          const nameEl = document.getElementById('global-resume-name');
          const statusEl = document.getElementById('global-resume-status');
          const sessionEl = document.getElementById('global-resume-session');

          if (globalResumeState.sessionId && globalResumeState.fileName) {
            emptyState.style.display = 'none';
            loadedState.style.display = 'flex';
            nameEl.textContent = globalResumeState.fileName;

            const age = Date.now() - (globalResumeState.uploadedAt || Date.now());
            const hours = Math.floor(age / (1000 * 60 * 60));
            const timeStr = hours < 1 ? 'Just now' : `${hours}h ago`;

            statusEl.textContent = 'Ready to use';
            sessionEl.textContent = `Uploaded ${timeStr}`;
          } else {
            emptyState.style.display = 'flex';
            loadedState.style.display = 'none';
          }
        }

        // Handle global resume upload
        document.getElementById('global-resume-input').addEventListener('change', async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          // Show loading state
          document.getElementById('resume-empty-state').innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px;">
      <span style="font-size: 1.5rem;">‚è≥</span>
      <span>Processing ${file.name}...</span>
    </div>
  `;

          try {
            // Upload and extract profile in one go
            const formData = new FormData();
            formData.append('resume', file);

            const response = await fetch('/api/extract-profile', {
              method: 'POST',
              body: formData
            });

            const data = await response.json();

            if (data.success) {
              // Store globally
              globalResumeState = {
                file: file,
                fileName: file.name,
                sessionId: data.data.sessionId,
                resumeText: data.data.resumeText,
                profile: data.data.profile,
                uploadedAt: Date.now()
              };

              // Set for backward compatibility
              window.sessionId = data.data.sessionId;

              // Save to sessionStorage
              saveGlobalResumeState();

              // Update UI
              updateGlobalResumeUI();

              showToast(`‚úÖ Resume uploaded! Now available to all features`, 'success');

              // Refresh current tab's data
              refreshCurrentTab();
            } else {
              throw new Error(data.error || 'Upload failed');
            }
          } catch (error) {
            console.error('Global resume upload error:', error);
            showToast('Failed to upload resume: ' + error.message, 'error');

            // Reset UI
            document.getElementById('resume-empty-state').innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5rem;">üìÑ</span>
        <div>
          <div style="font-weight: 600; font-size: 0.95rem;">Upload Your Resume Once</div>
          <div style="font-size: 0.8rem; color: #64748b;">Use it across all features - analyze, optimize, and find jobs</div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="document.getElementById('global-resume-input').click()" style="white-space: nowrap;">
        üì§ Upload Resume
      </button>
    `;
          }

          // Clear input so same file can be uploaded again
          e.target.value = '';
        });

        function replaceGlobalResume() {
          document.getElementById('global-resume-input').click();
        }

        function clearGlobalResume() {
          if (!confirm('Clear your uploaded resume? You can always upload again.')) return;

          globalResumeState = {
            file: null,
            fileName: null,
            sessionId: null,
            resumeText: null,
            profile: null,
            uploadedAt: null
          };

          window.sessionId = null;
          sessionStorage.removeItem('globalResumeState');
          updateGlobalResumeUI();
          showToast('Resume cleared', 'info');
        }

        function refreshCurrentTab() {
          const activeTab = document.querySelector('.main-tab.active');
          if (!activeTab) return;

          const tabName = activeTab.dataset.tab;

          // Refresh tab-specific data
          if (tabName === 'search' && globalResumeState.profile) {
            displayProfile(globalResumeState.profile);
          } else if (tabName === 'target-companies') {
            loadTargetCompanies();
          }
        }

        // Initialize on page load
        restoreGlobalResume();

        // Check for admin status and update UI
        async function checkAdminStatus() {
          if (!sessionId) return;
          try {
            const res = await fetch('/api/admin/config', { headers: { 'x-session-id': sessionId } });
            if (res.ok) {
              const userDropdown = document.getElementById('user-dropdown');
              if (userDropdown && !document.getElementById('admin-link')) {
                const adminLink = document.createElement('div');
                adminLink.id = 'admin-link';
                adminLink.className = 'dropdown-item';
                adminLink.innerHTML = '‚öôÔ∏è Admin Dashboard';
                adminLink.onclick = () => window.location.href = '/admin.html';
                userDropdown.insertBefore(adminLink, userDropdown.firstChild);
              }
            }
          } catch (e) {
            console.error('Admin check silent fail:', e);
          }
        }

        // Initialize auth UI on page load
        async function initAuth() {
          if (currentUser) {
            document.getElementById('auth-buttons').style.display = 'none';
            document.getElementById('user-menu').style.display = 'flex';
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('user-display-name').textContent = currentUser.name.split(' ')[0];

            // Load saved resume if exists
            loadSavedUserData();

            // Check Admin
            await checkAdminStatus();
          }
        }

        function showAuthModal(mode) {
          const modal = document.getElementById('auth-modal');
          if (modal) {
            modal.classList.add('show');
            modal.style.display = 'flex'; // Fallback
            switchAuthMode(mode);
          }
        }

        function hideAuthModal() {
          const modal = document.getElementById('auth-modal');
          if (modal) {
            modal.classList.remove('show');
            modal.style.display = 'none'; // Fallback
          }
          const loginErr = document.getElementById('login-error');
          const signupErr = document.getElementById('signup-error');
          if (loginErr) loginErr.style.display = 'none';
          if (signupErr) signupErr.style.display = 'none';
        }

        function switchAuthMode(mode) {
          if (mode === 'login') {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
          } else {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
          }
        }

        // Tab switching function
        function switchTab(tabName) {
          // Remove active from all tabs
          document.querySelectorAll('.main-tab').forEach(tab => {
            tab.classList.remove('active');
          });

          // Add active to target tab
          const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
          if (targetTab) {
            targetTab.classList.add('active');
          }

          // Hide all sections
          document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
          });

          // Show target section
          const targetSection = document.getElementById(`tab-${tabName}`);
          if (targetSection) {
            targetSection.classList.add('active');
          }

          // Load data for specific tabs
          if (tabName === 'target-companies') {
            if (typeof loadTargetCompanies === 'function') {
              loadTargetCompanies();
            } else {
              console.warn('loadTargetCompanies not defined');
            }
          } else if (tabName === 'mock-interview') {
            // Initialize mock interview if needed
            if (typeof initializeMockInterview === 'function') {
              initializeMockInterview();
            }
          } else if (tabName === 'interview-dashboard') {
            // Load interview dashboard
            if (typeof loadInterviewDashboard === 'function') {
              loadInterviewDashboard();
            }
          } else if (tabName === 'search') {
            // Ensure UI is ready for search
          } else if (tabName === 'search') {
            // Ensure UI is ready for search using GLOBAL STATE
            if (globalResumeState.profile) {
              // If we have a profile, make sure it's displayed
              if (typeof displayProfile === 'function') {
                displayProfile(globalResumeState.profile);
              }
            } else if (globalResumeState.file || globalResumeState.fileName) {
              // File exists in global state, pre-fill
              if (globalResumeState.file) searchFile = globalResumeState.file;
              const searchFileName = document.getElementById('search-file-name');
              const searchUploadZone = document.getElementById('search-upload-zone');
              if (searchFileName) {
                searchFileName.textContent = '‚úì ' + globalResumeState.fileName + (globalResumeState.file ? '' : ' (stored)');
              }
              if (searchUploadZone) {
                searchUploadZone.classList.add('has-file');
              }
              const extractBtn = document.getElementById('extract-btn');
              if (extractBtn) extractBtn.disabled = false;

              // Remove hint if it exists
              document.querySelectorAll('.empty-hint').forEach(h => h.remove());
            } else {
              // Really no profile? Show a hint
              const searchContainer = document.getElementById('tab-search');
              if (searchContainer && !searchContainer.querySelector('.empty-hint') && !document.getElementById('profile-card').style.display === 'block') {
                const hint = document.createElement('div');
                hint.className = 'empty-hint';
                hint.style.padding = '40px';
                hint.style.textAlign = 'center';
                hint.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 20px;">üîç</div>
                <h3>Resume Not Found</h3>
                <p style="color: #64748b; margin: 16px 0;">Upload your resume to start matching with relevant jobs!</p>
             `;
                searchContainer.prepend(hint);
              }
            }
          }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
          switchTab('home');

          // Attach logo click handler safely
          const logo = document.querySelector('.logo');
          if (logo) {
            logo.addEventListener('click', function () {
              switchTab('home');
            });

            // Add cursor pointer style
            logo.style.cursor = 'pointer';
          }

          // Attach tab click handlers
          document.querySelectorAll('.main-tab').forEach(tab => {
            tab.addEventListener('click', function () {
              const tabName = this.getAttribute('data-tab');
              switchTab(tabName);
            });
          });

          // Add event-delegated click listener for tab navigation
          document.addEventListener("click", (e) => {
            const tabEl = e.target.closest(".main-tab");
            if (!tabEl) return;
            const tabName = tabEl.getAttribute("data-tab");
            if (!tabName) return;
            if (typeof switchTab === "function") switchTab(tabName);
          });
        });

        function handleSignup(e) {
          e.preventDefault();
          const name = document.getElementById('signup-name').value.trim();
          const email = document.getElementById('signup-email').value.trim().toLowerCase();
          const password = document.getElementById('signup-password').value;

          // Check if user exists
          const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
          if (users[email]) {
            document.getElementById('signup-error').textContent = 'Email already registered. Please log in.';
            document.getElementById('signup-error').style.display = 'block';
            return;
          }

          // Create user
          const user = {
            name,
            email,
            password: btoa(password), // Simple encoding (not secure, but ok for demo)
            createdAt: Date.now(),
            savedResumes: [],
            savedCoverLetters: [],
            savedProfile: null
          };

          users[email] = user;
          localStorage.setItem('jobmatch_users', JSON.stringify(users));

          // Log in the user
          currentUser = user;
          localStorage.setItem('jobmatch_user', JSON.stringify(user));

          // Ensure sessionId is created for new user (stable, based on email only)
          if (!sessionId) {
            sessionId = 'sess_' + btoa(email).replace(/[=\/\+]/g, '').toLowerCase().substring(0, 15);
            localStorage.setItem('jobmatch_session', sessionId);
          }

          hideAuthModal();
          initAuth();
          showToast(`Welcome, ${name.split(' ')[0]}! Your account has been created.`, 'success');
        }

        function handleLogin(e) {
          e.preventDefault();
          const email = document.getElementById('login-email').value.trim().toLowerCase();
          const password = document.getElementById('login-password').value;

          const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
          const user = users[email];

          if (!user || user.password !== btoa(password)) {
            document.getElementById('login-error').textContent = 'Invalid email or password.';
            document.getElementById('login-error').style.display = 'block';
            return;
          }

          // Log in
          currentUser = user;
          localStorage.setItem('jobmatch_user', JSON.stringify(user));

          // Ensure sessionId is created/restored after login (stable, based on email only)
          if (!sessionId) {
            sessionId = 'sess_' + btoa(email).replace(/[=\/\+]/g, '').toLowerCase().substring(0, 15);
            localStorage.setItem('jobmatch_session', sessionId);
          }

          hideAuthModal();
          initAuth();
          showToast(`Welcome back, ${user.name.split(' ')[0]}!`, 'success');
        }

        function logout() {
          currentUser = null;

          // Clear all possible session storage keys
          localStorage.removeItem('jobmatch_user');
          localStorage.removeItem('sessionId');
          localStorage.removeItem('currentSessionId');
          localStorage.removeItem('jobmatch_session');

          // Clear global state
          globalResumeState = {
            sessionId: null,
            fileName: null,
            file: null,
            profile: null
          };

          // Update UI
          updateUserDisplay(null);
          document.getElementById('auth-buttons').style.display = 'flex';
          document.getElementById('user-menu').style.display = 'none';
          document.getElementById('user-dropdown').classList.remove('show');

          // Clear any cached data
          if (typeof updateGlobalResumeUI === 'function') {
            updateGlobalResumeUI();
          }

          showToast('Logged out successfully', 'success');

          // Optionally redirect to home tab
          switchTab('home');
        }

        // ========== USER DROPDOWN ==========

        function toggleUserDropdown() {
          document.getElementById('user-dropdown').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.dropdown')) {
            document.getElementById('user-dropdown')?.classList.remove('show');
          }
          // Close auth modal when clicking overlay (not the modal itself)
          if (e.target.id === 'auth-modal') {
            hideAuthModal();
          }
          if (e.target.id === 'my-data-modal') {
            hideMyDataModal();
          }
          if (e.target.id === 'cover-letters-modal') {
            hideCoverLettersModal();
          }
        });

        // ========== USER DATA PERSISTENCE ==========
        function saveUserResume(resumeText, fileName, profileData, fileBase64 = null) {
          if (!currentUser) return;

          const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
          const user = users[currentUser.email];

          if (user) {
            // Save latest resume
            user.savedProfile = profileData;
            user.lastResumeText = resumeText;
            user.lastResumeFileName = fileName;
            user.lastResumeDate = Date.now();
            if (fileBase64) {
              user.lastResumeBase64 = fileBase64; // Store actual file for re-upload
            }

            // Keep history (max 3 resumes with full data)
            if (!user.savedResumes) user.savedResumes = [];

            // Check if this resume already exists (by name)
            const existingIdx = user.savedResumes.findIndex(r => r.fileName === fileName);
            if (existingIdx >= 0) {
              user.savedResumes.splice(existingIdx, 1);
            }

            user.savedResumes.unshift({
              id: Date.now(),
              fileName,
              resumeText: resumeText.substring(0, 1000), // Store preview
              profile: profileData,
              fileBase64: fileBase64, // Store full file
              savedAt: Date.now()
            });
            user.savedResumes = user.savedResumes.slice(0, 3); // Max 3 full resumes

            users[currentUser.email] = user;
            localStorage.setItem('jobmatch_users', JSON.stringify(users));
            currentUser = user;
            localStorage.setItem('jobmatch_user', JSON.stringify(user));
          }
        }

        // Convert file to base64
        function fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }

        // Convert base64 back to File object
        function base64ToFile(base64, fileName) {
          const arr = base64.split(',');
          const mime = arr[0].match(/:(.*?);/)[1];
          const bstr = atob(arr[1]);
          let n = bstr.length;
          const u8arr = new Uint8Array(n);
          while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
          }
          return new File([u8arr], fileName, { type: mime });
        }

        function saveCoverLetter(coverLetter, jobTitle, companyName) {
          if (!currentUser) {
            showToast('Log in to save cover letters', 'error');
            return false;
          }

          const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
          const user = users[currentUser.email];

          if (user) {
            if (!user.savedCoverLetters) user.savedCoverLetters = [];
            user.savedCoverLetters.unshift({
              id: Date.now(),
              coverLetter,
              jobTitle: jobTitle || 'Unknown Role',
              companyName: companyName || 'Unknown Company',
              savedAt: Date.now()
            });
            user.savedCoverLetters = user.savedCoverLetters.slice(0, 20); // Max 20

            users[currentUser.email] = user;
            localStorage.setItem('jobmatch_users', JSON.stringify(users));
            currentUser = user;
            localStorage.setItem('jobmatch_user', JSON.stringify(user));
            return true;
          }
          return false;
        }

        async function loadSavedUserData() {
          if (!currentUser) return;

          // Ensure stable sessionId based on email
          if (!sessionId && currentUser.email) {
            sessionId = 'sess_' + btoa(currentUser.email).replace(/[=\/\+]/g, '').toLowerCase().substring(0, 15);
            localStorage.setItem('jobmatch_session', sessionId);
          }

          try {
            // 1. Fetch Profile from DB
            const profileRes = await fetch(`/api/profile/${sessionId}`);
            const profileData = await profileRes.json();

            if (profileData.success && profileData.data) {
              profile = profileData.data;
              console.log('‚úÖ Profile auto-loaded from DB');

              // Update global profile
              window.profile = profile;

              // Auto-display in Find Jobs tab
              if (typeof displayProfile === 'function') {
                displayProfile(profile);
                const searchUploadCard = document.getElementById('search-upload-card');
                const profileCard = document.getElementById('profile-card');
                if (searchUploadCard) searchUploadCard.style.display = 'none';
                if (profileCard) profileCard.style.display = 'block';
              }

              // Remove empty hints if they exist
              document.querySelectorAll('.empty-hint').forEach(h => h.remove());
            }

            // 2. Fetch Last Resume Metadata (for status visibility)
            const resumeRes = await fetch(`/api/resume/${sessionId}`);
            const resumeData = await resumeRes.json();

            if (resumeData.success && resumeData.data) {
              const resume = resumeData.data;
              const fileName = resume.original_filename;

              // We don't download the whole file automatically, but we show it's loaded
              const analyzeFileName = document.getElementById('analyze-file-name');
              const analyzeUploadZone = document.getElementById('analyze-upload-zone');
              const searchFileName = document.getElementById('search-file-name');
              const searchUploadZone = document.getElementById('search-upload-zone');

              if (analyzeFileName) analyzeFileName.textContent = '‚úì ' + fileName + ' (stored)';
              if (analyzeUploadZone) analyzeUploadZone.classList.add('has-file');

              if (!searchFile) {
                if (searchFileName) searchFileName.textContent = '‚úì ' + fileName + ' (stored)';
                if (searchUploadZone) searchUploadZone.classList.add('has-file');
                const extractBtn = document.getElementById('extract-btn');
                if (extractBtn) extractBtn.disabled = false;
              }

              // Trigger check so analyze button is enabled if JD is present
              if (typeof checkAnalyzeReady === 'function') checkAnalyzeReady();

              console.log('‚úì Last resume metadata restored from DB:', fileName);
            }
          } catch (err) {
            console.error('Error auto-loading data from DB:', err);
          }
        }

        // ========== UNIFIED LIBRARY ==========
        let currentLibraryTab = 'resumes';

        function showMyLibrary(initialTab = 'resumes') {
          const dropdown = document.getElementById('user-dropdown');
          if (dropdown) dropdown.classList.remove('show');

          if (!currentUser) {
            showToast('Please log in to see your library.', 'info');
            showAuthModal('login');
            return;
          }

          document.getElementById('library-modal').classList.add('show');
          switchLibraryTab(initialTab);
        }

        function hideLibraryModal() {
          document.getElementById('library-modal').classList.remove('show');
        }

        function switchLibraryTab(tab) {
          currentLibraryTab = tab;

          // Update tab UI
          document.querySelectorAll('.lib-tab').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.libTab === tab);
          });

          const content = document.getElementById('library-content');
          content.innerHTML = '<div style="text-align: center; padding: 40px;"><span class="loading"></span></div>';

          // Render content
          if (tab === 'resumes') renderLibraryResumes();
          else if (tab === 'cover-letters') renderLibraryCoverLetters();
          else if (tab === 'pitches') renderLibraryPitches();
          else if (tab === 'interview-prep') renderLibraryInterviewPrep();
        }

        function renderLibraryResumes() {
          const content = document.getElementById('library-content');
          const resumes = currentUser.savedResumes || [];

          if (resumes.length === 0) {
            content.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #64748b;">
            <p>No saved resumes yet.</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Upload a resume to get started.</p>
          </div>
        `;
            return;
          }

          content.innerHTML = resumes.map((r, idx) => `
        <div style="background: #1e1e2e; padding: 16px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #2e2e3e;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
            <div>
              <h4 style="font-size: 0.95rem; margin-bottom: 4px;">üìé ${r.fileName}</h4>
              <p style="font-size: 0.8rem; color: #64748b;">Saved ${new Date(r.savedAt).toLocaleDateString()}</p>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="deleteSavedResume(${idx})" style="padding: 4px 8px;">üóëÔ∏è</button>
          </div>
          ${r.profile ? `
            <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 8px;">${r.profile.name || ''} ‚Ä¢ ${r.profile.currentTitle || ''}</p>
            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">
              ${(r.profile.hardSkills || []).slice(0, 5).map(s => `<span class="tag tag-info" style="font-size: 0.7rem; padding: 2px 6px;">${s}</span>`).join('')}
            </div>
          ` : ''}
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-primary btn-sm" onclick="useSavedResume(${idx}, 'analyze')">üîç Analyze</button>
            <button class="btn btn-secondary btn-sm" onclick="useSavedResume(${idx}, 'search')">üíº Find Jobs</button>
          </div>
        </div>
      `).join('');
        }

        function renderLibraryCoverLetters() {
          const content = document.getElementById('library-content');
          const letters = currentUser.savedCoverLetters || [];

          if (letters.length === 0) {
            content.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #64748b;">
            <p>No saved cover letters yet.</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Generate one in the Analyze tab!</p>
          </div>
        `;
            return;
          }

          content.innerHTML = letters.map((cl, i) => `
        <div style="background: #1e1e2e; padding: 16px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #2e2e3e;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
              <h4 style="font-size: 0.95rem;">${cl.jobTitle}</h4>
              <p style="font-size: 0.85rem; color: #64748b;">${cl.companyName} ‚Ä¢ ${new Date(cl.savedAt).toLocaleDateString()}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary btn-sm" onclick="copySavedCoverLetter(${i})">üìã Copy</button>
              <button class="btn btn-secondary btn-sm" onclick="deleteCoverLetter(${i})">üóëÔ∏è</button>
            </div>
          </div>
          <div style="background: #0a0a0f; padding: 12px; border-radius: 8px; max-height: 150px; overflow-y: auto; font-size: 0.85rem; color: #94a3b8; white-space: pre-wrap;">${cl.coverLetter.substring(0, 400)}${cl.coverLetter.length > 400 ? '...' : ''}</div>
        </div>
      `).join('');
        }

        function renderLibraryPitches() {
          const content = document.getElementById('library-content');
          const pitches = JSON.parse(localStorage.getItem('saved_elevator_pitches') || '[]');

          if (pitches.length === 0) {
            content.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #64748b;">
            <p>No saved elevator pitches yet.</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Generate one after analyzing a job!</p>
          </div>
        `;
            return;
          }

          content.innerHTML = pitches.map((pitch, i) => `
        <div style="background: #1e1e2e; padding: 16px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #2e2e3e;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
              <h4 style="font-size: 0.95rem;">üöÄ ${pitch.jobTitle} Elevator Pitch</h4>
              <p style="font-size: 0.85rem; color: #64748b;">${pitch.companyName} ‚Ä¢ ${new Date(pitch.createdAt).toLocaleDateString()}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary btn-sm" onclick="copySavedPitch(${i})">üìã Copy</button>
              <button class="btn btn-secondary btn-sm" onclick="deleteSavedPitch(${i})">üóëÔ∏è</button>
            </div>
          </div>
          <div style="background: #0a0a0f; padding: 12px; border-radius: 8px; font-size: 0.85rem; color: #94a3b8; white-space: pre-wrap;">${pitch.content}</div>
        </div>
      `).join('');
        }

        function renderLibraryInterviewPrep() {
          const content = document.getElementById('library-content');
          const prepList = JSON.parse(localStorage.getItem('saved_interview_prep') || '[]');

          if (prepList.length === 0) {
            content.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #64748b;">
            <p>No saved interview prep yet.</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Save prep guides from your analysis results!</p>
          </div>
        `;
            return;
          }

          content.innerHTML = prepList.map((prep, i) => `
        <div style="background: #1e1e2e; padding: 16px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #2e2e3e;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
              <h4 style="font-size: 0.95rem;">üéØ ${prep.jobTitle} Prep Guide</h4>
              <p style="font-size: 0.85rem; color: #64748b;">${prep.companyName} ‚Ä¢ ${new Date(prep.createdAt).toLocaleDateString()}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary btn-sm" onclick="viewSavedPrep(${i})">üëÅÔ∏è View Full</button>
              <button class="btn btn-secondary btn-sm" onclick="deleteSavedPrep(${i})">üóëÔ∏è</button>
            </div>
          </div>
          <div style="font-size: 0.85rem; color: #94a3b8;">
            ${(prep.questions || []).length} questions ‚Ä¢ Includes follow-ups & questions to ask.
          </div>
        </div>
      `).join('');
        }

        function copySavedPitch(index) {
          const pitches = JSON.parse(localStorage.getItem('saved_elevator_pitches') || '[]');
          if (pitches[index]) {
            navigator.clipboard.writeText(pitches[index].content).then(() => {
              showToast('Pitch copied to clipboard!', 'success');
            });
          }
        }

        function deleteSavedPitch(index) {
          if (!confirm('Delete this elevator pitch?')) return;
          const pitches = JSON.parse(localStorage.getItem('saved_elevator_pitches') || '[]');
          pitches.splice(index, 1);
          localStorage.setItem('saved_elevator_pitches', JSON.stringify(pitches));
          renderLibraryPitches();
          showToast('Pitch deleted', 'success');
        }

        function viewSavedPrep(index) {
          const prepList = JSON.parse(localStorage.getItem('saved_interview_prep') || '[]');
          const prep = prepList[index];
          if (!prep) return;

          // Close library modal temporarily or show prep over it
          // Let's reuse the existing prep output structure but in a modal or similar
          document.getElementById('interview-prep-content').innerHTML = `
        <div style="max-height: 600px; overflow-y: auto; padding: 10px;">
          <h4 style="margin-bottom: 16px;">üìö Prep for ${prep.jobTitle} at ${prep.companyName}</h4>
          ${(prep.questions || []).map((q, i) => `
            <div class="analysis-card" style="margin-bottom: 16px; background: #1e1e2e;">
              <h5 style="font-size: 0.95rem; color: #6366f1; margin-bottom: 8px;">${i + 1}. ${q.question}</h5>
              <div style="background: #0a0a0f; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                <div style="font-size: 0.85rem; color: #e2e8f0; margin-bottom: 8px;"><strong>Suggested Answer:</strong></div>
                <div style="font-size: 0.85rem; color: #94a3b8; line-height: 1.6;">${q.suggestedAnswer}</div>
              </div>
              ${q.tips ? `<div style="font-size: 0.8rem; color: #64748b; font-style: italic;">üí° ${q.tips}</div>` : ''}
            </div>
          `).join('')}
          
          ${(prep.questionsToAsk || []).length > 0 ? `
            <h4 style="margin-top: 24px; margin-bottom: 16px;">‚ùì Questions to Ask</h4>
            ${prep.questionsToAsk.map((q, i) => `<div class="item success" style="margin-bottom: 8px;">${i + 1}. ${q}</div>`).join('')}
          ` : ''}
        </div>
      `;

          document.getElementById('interview-prep-output').style.display = 'block';
          hideLibraryModal();
          document.getElementById('interview-prep-output').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteSavedPrep(index) {
          if (!confirm('Delete this interview prep guide?')) return;
          const prepList = JSON.parse(localStorage.getItem('saved_interview_prep') || '[]');
          prepList.splice(index, 1);
          localStorage.setItem('saved_interview_prep', JSON.stringify(prepList));
          renderLibraryInterviewPrep();
          showToast('Prep guide deleted', 'success');
        }

        function saveCurrentInterviewPrep() {
          if (!lastInterviewPrepData) {
            showToast('No interview prep to save', 'error');
            return;
          }

          const jobDesc = document.getElementById('job-description').value || '';

          // Try to extract company name
          const companyMatch = jobDesc.match(/(?:at|@|company[:\s]+|about[:\s]+)([A-Z][a-zA-Z0-9\s&]+?)(?:\.|,|\n|is|we|has)/i) ||
            jobDesc.match(/([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+)?)\s+is\s+(?:seeking|hiring|looking)/i);
          const companyName = companyMatch ? companyMatch[1].trim() : 'Company';

          // Try to extract job title
          const titleMatch = jobDesc.match(/(?:title|position|role)[:\s]+([^\n]+)/i) ||
            jobDesc.match(/(?:seeking|hiring|looking for)[:\s]+(?:an?\s+)?([^\n.]+)/i) ||
            jobDesc.match(/^([A-Z][a-zA-Z\s]+(?:Engineer|Manager|Director|Developer|Architect|Lead|Analyst))/m);
          const jobTitle = titleMatch ? titleMatch[1].trim().substring(0, 50) : 'Job Role';

          const savedPrepList = JSON.parse(localStorage.getItem('saved_interview_prep') || '[]');

          const prepData = {
            id: Date.now(),
            jobTitle,
            companyName,
            createdAt: new Date().toISOString(),
            questions: lastInterviewPrepData.questions,
            questionsToAsk: lastInterviewPrepData.questionsToAsk
          };

          savedPrepList.unshift(prepData);
          if (savedPrepList.length > 50) savedPrepList.splice(50);

          localStorage.setItem('saved_interview_prep', JSON.stringify(savedPrepList));
          showToast('Interview prep guide saved to your Library!', 'success');
        }

        function deleteSavedResume(index) {
          if (!currentUser) return;
          if (!confirm('Delete this saved resume?')) return;

          const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
          const user = users[currentUser.email];

          if (user && user.savedResumes) {
            user.savedResumes.splice(index, 1);
            users[currentUser.email] = user;
            localStorage.setItem('jobmatch_users', JSON.stringify(users));
            currentUser = user;
            localStorage.setItem('jobmatch_user', JSON.stringify(user));

            renderLibraryResumes(); // Refresh
            showToast('Resume deleted', 'success');
          }
        }

        async function useSavedResume(index, mode) {
          if (!currentUser || !currentUser.savedResumes || !currentUser.savedResumes[index]) {
            showToast('Resume not found', 'error');
            return;
          }

          const savedResume = currentUser.savedResumes[index];

          hideLibraryModal();

          if (mode === 'analyze') {
            // Switch to Analyze tab
            switchTab('analyze');

            if (savedResume.fileBase64) {
              // Convert base64 back to file and set it
              analyzeFile = base64ToFile(savedResume.fileBase64, savedResume.fileName);
              document.getElementById('analyze-file-name').textContent = '‚úì ' + savedResume.fileName + ' (saved)';
              const analyzeUploadZone = document.getElementById('analyze-upload-zone');
              if (analyzeUploadZone) analyzeUploadZone.classList.add('has-file');
              checkAnalyzeReady();
              showToast('Resume loaded! Paste a job description and click Analyze.', 'success');
            } else {
              showToast('Resume file not available. Please re-upload.', 'error');
            }
          } else if (mode === 'search') {
            // Switch to Find Jobs tab
            switchTab('search');

            if (savedResume.profile) {
              // Use saved profile directly
              profile = savedResume.profile;

              // Ensure stable sessionId based on email
              if (!sessionId && currentUser && currentUser.email) {
                sessionId = 'sess_' + btoa(currentUser.email).replace(/[=\/\+]/g, '').toLowerCase().substring(0, 15);
                localStorage.setItem('jobmatch_session', sessionId);
              }

              displayProfile();
              const searchUploadCard = document.getElementById('search-upload-card');
              const profileCard = document.getElementById('profile-card');
              if (searchUploadCard) searchUploadCard.style.display = 'none';
              if (profileCard) profileCard.style.display = 'block';

              showToast('Profile loaded! Click "Search Jobs" to find matches.', 'success');
            } else if (savedResume.fileBase64) {
              // Re-extract profile from saved file
              searchFile = base64ToFile(savedResume.fileBase64, savedResume.fileName);
              document.getElementById('search-file-name').textContent = '‚úì ' + savedResume.fileName + ' (saved)';
              const searchUploadZone = document.getElementById('search-upload-zone');
              if (searchUploadZone) searchUploadZone.classList.add('has-file');
              const extractBtn = document.getElementById('extract-btn');
              if (extractBtn) extractBtn.disabled = false;
              showToast('Resume loaded! Click "Extract My Profile" to continue.', 'success');
            } else {
              showToast('Resume data not available. Please re-upload.', 'error');
            }
          }
        }

        function copySavedCoverLetter(index) {
          if (currentUser && currentUser.savedCoverLetters && currentUser.savedCoverLetters[index]) {
            navigator.clipboard.writeText(currentUser.savedCoverLetters[index].coverLetter).then(() => {
              showToast('Cover letter copied!', 'success');
            });
          }
        }

        function deleteCoverLetter(index) {
          if (!currentUser) return;
          if (!confirm('Delete this cover letter?')) return;

          const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
          const user = users[currentUser.email];

          if (user && user.savedCoverLetters) {
            user.savedCoverLetters.splice(index, 1);
            users[currentUser.email] = user;
            localStorage.setItem('jobmatch_users', JSON.stringify(users));
            currentUser = user;
            localStorage.setItem('jobmatch_user', JSON.stringify(user));

            renderLibraryCoverLetters(); // Refresh
            showToast('Cover letter deleted', 'success');
          }
        }


        // Initialize auth on page load
        document.addEventListener('DOMContentLoaded', initAuth);

        // ========== LLM PROVIDER SELECTION ==========
        let availableLLMProviders = [];

        // Load available LLM providers on page load
        async function loadLLMProviders() {
          try {
            const res = await fetch('/api/llm-providers');
            const data = await res.json();

            if (data.success) {
              availableLLMProviders = data.data.providers;
              const select = document.getElementById('llm-provider-select');

              select.innerHTML = availableLLMProviders
                .filter(p => p.available)
                .map(p => `<option value="${p.name}" ${p.name === data.data.default ? 'selected' : ''}>${p.displayName}</option>`)
                .join('');

              if (availableLLMProviders.filter(p => p.available).length === 0) {
                select.innerHTML = '<option value="">No AI providers configured</option>';
              }
            }
          } catch (error) {
            console.error('Failed to load LLM providers:', error);
            document.getElementById('llm-provider-select').innerHTML = '<option value="">Error loading providers</option>';
          }
        }

        // Load providers when page loads
        document.addEventListener('DOMContentLoaded', loadLLMProviders);

        // ========== EXISTING STATE ==========
        // State
        // Global data
        let sessionId = localStorage.getItem('jobmatch_session');
        window.sessionId = sessionId; // Ensure global window scope for other scripts
        let profile = null;
        let jobs = [];
        let savedJobs = [];
        let currentJob = null;
        let analyzeFile = null;
        let searchFile = null;

        // Tab Navigation
        document.querySelectorAll('.main-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');

            // Load data when switching to specific tabs
            if (tab.dataset.tab === 'target-companies') {
              loadTargetCompanies();
            } else if (tab.dataset.tab === 'search') {
              // Auto-show profile if global resume exists
              if (globalResumeState.profile) {
                displayProfile(globalResumeState.profile);
              } else if (globalResumeState.file || globalResumeState.fileName) {
                // Pre-fill search upload if file exists
                if (globalResumeState.file) searchFile = globalResumeState.file;
                document.getElementById('search-file-name').textContent = '‚úì ' + globalResumeState.fileName + (globalResumeState.file ? '' : ' (stored)');
                document.getElementById('search-upload-zone').classList.add('has-file');
                document.getElementById('extract-btn').disabled = false;
              }
            } else if (tab.dataset.tab === 'analyze' || tab.dataset.tab === 'optimizer') {
              // Enable buttons if global resume exists
              if (globalResumeState.sessionId) {
                checkAnalyzeReady();
                checkOptimizerReady();
              } else if (globalResumeState.file) {
                // If file exists but no session, pre-fill analyze
                analyzeFile = globalResumeState.file;
                document.getElementById('analyze-file-name').textContent = '‚úì ' + globalResumeState.fileName;
                document.getElementById('analyze-upload-zone').classList.add('has-file');
                checkAnalyzeReady();
              }
            }
          });
        });

        // ========== ANALYZE TAB ==========
        const analyzeZone = document.getElementById('analyze-upload-zone');
        const analyzeInput = document.getElementById('analyze-resume-input');
        const analyzeBtn = document.getElementById('analyze-btn');
        const jobDescInput = document.getElementById('job-description');

        analyzeZone.addEventListener('click', () => analyzeInput.click());
        analyzeZone.addEventListener('dragover', e => { e.preventDefault(); analyzeZone.style.borderColor = '#6366f1'; });
        analyzeZone.addEventListener('dragleave', () => { analyzeZone.style.borderColor = analyzeFile ? '#10b981' : '#2e2e3e'; });
        analyzeZone.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files[0]) handleAnalyzeFile(e.dataTransfer.files[0]); });
        analyzeInput.addEventListener('change', e => { if (e.target.files[0]) handleAnalyzeFile(e.target.files[0]); });

        function handleAnalyzeFile(file) {
          if (!file.name.match(/\.(pdf|doc|docx)$/i)) { showToast('Please upload PDF or Word', 'error'); return; }
          analyzeFile = file;
          document.getElementById('analyze-file-name').textContent = '‚úì ' + file.name;
          analyzeZone.classList.add('has-file');

          logEvent('resume_upload', { fileName: file.name, type: 'analyze' });

          // SYNC GLOBAL STATE
          globalResumeState.file = file;
          globalResumeState.fileName = file.name;
          globalResumeState.uploadedAt = Date.now();
          saveGlobalResumeState();
          updateGlobalResumeUI();

          checkAnalyzeReady();
        }

        jobDescInput.addEventListener('input', checkAnalyzeReady);
        function checkAnalyzeReady() {
          // Check if we have EITHER a local file OR global resume
          const hasResume = analyzeFile || (globalResumeState.file || globalResumeState.resumeText);
          analyzeBtn.disabled = !(hasResume && jobDescInput.value.trim().length > 50);
        }

        analyzeBtn.addEventListener('click', async () => {
          setLoading('analyze', true, 'Analyzing (15-20 sec)...');
          logEvent('analysis_start');

          try {
            const selectedProvider = document.getElementById('llm-provider-select').value;

            // Use global resume if no local file uploaded
            const resumeToUse = analyzeFile || globalResumeState.file;

            if (!resumeToUse) {
              showToast('Please upload a resume first', 'error');
              return;
            }

            const formData = new FormData();
            formData.append('resume', resumeToUse);
            formData.append('jobDescription', jobDescInput.value.trim());
            if (selectedProvider) {
              formData.append('llmProvider', selectedProvider);
            }
            // Pass existing sessionId to maintain session
            if (globalResumeState.sessionId && !analyzeFile) {
              formData.append('sessionId', globalResumeState.sessionId);
            }

            const res = await fetch('/api/analyze-match', { method: 'POST', body: formData });

            if (res.status === 402) {
              showPaywallModal();
              return;
            }

            const data = await res.json();

            if (!data.success) throw new Error(data.error);

            // IMPORTANT: Capture sessionId from response
            if (data.sessionId) {
              sessionId = data.sessionId;
              window.sessionId = sessionId; // Sync window scope
              localStorage.setItem('jobmatch_session', sessionId);
              globalResumeState.sessionId = sessionId; // Sync global
            }

            lastAnalysisData = data.data; // Store for cover letter generation

            // Sync global profile
            if (data.data.profile) {
              globalResumeState.profile = data.data.profile;
              globalResumeState.resumeText = data.data.resumeText;
              saveGlobalResumeState();
            }

            // Save resume for logged-in users
            if (currentUser && analyzeFile) {
              try {
                const fileBase64 = await fileToBase64(analyzeFile);
                const profile = data.data.profile || { name: 'User', currentTitle: 'Professional' };
                saveUserResume(data.data.resumeText || '', analyzeFile.name, profile, fileBase64);
              } catch (e) {
                console.log('Could not save resume:', e);
              }
            }

            displayAnalysisResults(data.data);
            logEvent('analysis_complete', { score: data.data.overallScore });

          } catch (err) {
            showToast(err.message, 'error');
            logEvent('analysis_error', { error: err.message });
          } finally {
            setLoading('analyze', false, 'üéØ Analyze My Match');
          }
        });

        function displayAnalysisResults(d) {
          const score = d.overallScore || 0;
          const scoreClass = score >= 70 ? 'high' : score >= 50 ? 'medium' : 'low';

          // Circumference for radius 80 is ~502.6
          const circumference = 502.6;
          const offset = circumference - (score / 100) * circumference;

          // Calculate accurate verdict
          let accurateVerdict = 'NOT A FIT';
          if (score >= 80) accurateVerdict = 'STRONG MATCH';
          else if (score >= 60) accurateVerdict = 'MODERATE MATCH';
          else if (score >= 40) accurateVerdict = 'WEAK MATCH';
          else if (score >= 20) accurateVerdict = 'LONG SHOT';

          const resultsContainer = document.getElementById('analysis-results');
          resultsContainer.style.display = 'block';

          // Modern UI rendering
          resultsContainer.innerHTML = `
      <div class="match-hero-modern">
        <div class="modern-gauge-container">
          <svg class="modern-gauge-svg" width="180" height="180" viewBox="0 0 180 180">
            <circle class="gauge-bg" cx="90" cy="90" r="80" />
            <circle class="gauge-fill ${scoreClass}" cx="90" cy="90" r="80" 
              stroke-dasharray="${circumference}" 
              stroke-dashoffset="${circumference}" />
          </svg>
          <div class="modern-gauge-text">
            <div class="modern-gauge-number">${score}%</div>
            <div class="modern-gauge-label">Match Score</div>
          </div>
        </div>
        
        <div class="modern-verdict ${scoreClass}">
          <span>${score >= 70 ? '‚ú®' : score >= 50 ? '‚öñÔ∏è' : '‚ö†Ô∏è'}</span>
          ${accurateVerdict}
        </div>
        
        <p class="modern-summary">${d.summary || ''}</p>
        
        ${d.aiOriginalScore ? `
          <div class="sub-scores-modern">
            <div class="sub-score-item">
              <div class="sub-score-label">AI Assessment</div>
              <div class="sub-score-value">${d.aiOriginalScore}%</div>
            </div>
            <div class="sub-score-item">
              <div class="sub-score-label">Skill-Based</div>
              <div class="sub-score-value">${score}%</div>
            </div>
          </div>
        ` : ''}
        
        ${d.llmProvider || d.modelUsed ? `
          <div style="margin-top: 32px; font-size: 0.75rem; color: #94a3b8;">
            ü§ñ Analyzed by ${d.llmProvider === 'claude' ? 'Claude' :
                d.llmProvider === 'openai' ? 'GPT-4' :
                  'Groq Llama 3'
              } ${d.modelUsed ? `(${d.modelUsed})` : ''}
          </div>
        ` : ''}
      </div>

      <div class="action-toolkit-grid">
        <!-- 1. Interview Probability -->
        <div class="action-card-modern">
          <div class="action-card-icon ${scoreClass === 'high' ? 'icon-bg-green' : scoreClass === 'medium' ? 'icon-bg-orange' : 'icon-bg-orange'}" style="background: ${scoreClass === 'high' ? '#f0fdf4' : '#fff7ed'}; color: ${scoreClass === 'high' ? '#16a34a' : '#ea580c'};">
            ${score >= 60 ? 'üìà' : 'üìâ'}
          </div>
          <div class="action-card-title">Interview Odds</div>
          <div class="action-card-desc">${d.interviewProbability?.percentage || 0}% Probability</div>
          <div class="progress-bar" style="width: 80%; margin-top: 12px; height: 6px;">
            <div class="progress-fill ${scoreClass}" style="width:${d.interviewProbability?.percentage || 0}%"></div>
          </div>
        </div>

        <!-- 2. Cover Letter -->
        <div class="action-card-modern" onclick="generateAnalysisCoverLetter()">
          <div class="action-card-icon icon-bg-purple">‚úâÔ∏è</div>
          <div class="action-card-title">Cover Letter</div>
          <div class="action-card-desc">Tailored generator</div>
        </div>

        <!-- 3. Interview Prep -->
        <div class="action-card-modern" onclick="generateAnalysisInterviewPrep()">
          <div class="action-card-icon icon-bg-blue">üéØ</div>
          <div class="action-card-title">Interview Prep</div>
          <div class="action-card-desc">Practice questions</div>
        </div>

        <!-- 4. Elevator Pitch -->
        <div class="action-card-modern" onclick="generateElevatorPitch()">
          <div class="action-card-icon icon-bg-orange">üöÄ</div>
          <div class="action-card-title">Elevator Pitch</div>
          <div class="action-card-desc">30-45s framework</div>
        </div>
      </div>

      <div class="action-card-modern" style="margin-bottom: 24px; flex-direction: row; gap: 20px; justify-content: flex-start; padding: 20px 32px;" onclick="switchToNetworking()">
        <div class="action-card-icon icon-bg-green" style="margin-bottom: 0;">üë•</div>
        <div style="text-align: left;">
          <div class="action-card-title">Find Referrals</div>
          <div class="action-card-desc">Get insider help from company advocates</div>
        </div>
      </div>
    `;

          // Trigger gauge animation after a short delay
          setTimeout(() => {
            const fill = resultsContainer.querySelector('.gauge-fill');
            if (fill) fill.style.strokeDashoffset = offset;
          }, 100);

          // Rest of the results (reasoning, ATS, etc.) - keep mostly the same but ensure cards are styled
          resultsContainer.innerHTML += `
    <!-- Interview Probability Details -->

    ${d.interviewProbability?.reasoning ? `
    <div class="card" style="margin-bottom: 24px;">
      <p class="text-muted" style="font-size:0.9rem;">${d.interviewProbability.reasoning}</p>
      ${d.interviewProbability?.whatWouldIncreaseOdds ? `<div class="item success mt-4"><div class="item-title">üí° To increase your odds:</div><div class="item-desc">${d.interviewProbability.whatWouldIncreaseOdds}</div></div>` : ''}
    </div>
    ` : ''}

    <div class="grid-2">
      <div>
        <div class="analysis-card">
          <h4>üëÅÔ∏è 6-Second Scan</h4>
          <div class="flex items-center gap-4 mb-4">
            <span style="font-size:2rem;">${d.sixSecondScan?.wouldReadMore === true ? '‚úÖ' : d.sixSecondScan?.wouldReadMore === false ? '‚ùå' : 'ü§î'}</span>
            <div>
              <div style="font-weight:600;">${d.sixSecondScan?.wouldReadMore === true ? 'They\'d keep reading!' : d.sixSecondScan?.wouldReadMore === false ? 'Probably not...' : 'Borderline'}</div>
              <div class="text-muted" style="font-size:0.9rem;">${d.sixSecondScan?.whyOrWhyNot || ''}</div>
            </div>
          </div>
          <p class="text-muted" style="font-size:0.9rem;">${d.sixSecondScan?.firstImpression || ''}</p>
        </div>
        
        <div class="analysis-card">
          <h4>ü§ñ ATS Compatibility</h4>
          <div class="flex justify-between items-center mb-2">
            <span class="tag ${d.atsAnalysis?.likelyToPass ? 'tag-success' : 'tag-danger'}">${d.atsAnalysis?.likelyToPass ? '‚úì Likely to pass' : '‚úó Likely to fail'}</span>
            <span style="font-weight:700;">${d.atsAnalysis?.score || 0}%</span>
          </div>
          <div class="progress-bar"><div class="progress-fill ${(d.atsAnalysis?.score || 0) >= 70 ? 'high' : 'low'}" style="width:${d.atsAnalysis?.score || 0}%"></div></div>
          <div class="mb-4">
            <div style="font-size:0.8rem; color:#10b981; margin-bottom:6px;">‚úì Keywords found:</div>
            <div>${(d.atsAnalysis?.keywordsFound || []).map(k => `<span class="tag tag-success">${k}</span>`).join('') || '<span class="text-muted">None</span>'}</div>
          </div>
          <div>
            <div style="font-size:0.8rem; color:#ef4444; margin-bottom:6px;">‚úó Missing keywords:</div>
            <div>${(d.atsAnalysis?.criticalKeywordsMissing || []).map(k => `<span class="tag tag-danger">${k}</span>`).join('') || '<span class="text-muted">None</span>'}</div>
          </div>
          ${d.atsAnalysis?.suggestionToPassATS ? `<div class="item warning mt-4"><div class="item-title">üîß To pass ATS:</div><div class="item-desc">${d.atsAnalysis.suggestionToPassATS}</div></div>` : ''}
        </div>
        
        ${(d.hiddenRedFlags || []).length > 0 ? `
        <div class="analysis-card">
          <h4>üö© Hidden Red Flags</h4>
          ${d.hiddenRedFlags.map(f => `
            <div class="item warning">
              <div class="item-title">${f.issue}</div>
              <div class="item-desc">ü§î Recruiter thinks: "${f.whatRecruiterThinks}"</div>
              ${f.howToAddress ? `<div class="item-fix">üîß ${f.howToAddress}</div>` : ''}
            </div>
          `).join('')}
        </div>
        ` : ''}
      </div>
      
      <div>
        <div class="analysis-card">
          <h4>üìè Experience Gap</h4>
          <div class="grid-2 mb-4" style="gap:12px;">
            <div class="item"><div style="font-size:0.75rem; color:#64748b;">They want:</div><div>${d.qualificationGap?.experienceRequired || '-'}</div></div>
            <div class="item"><div style="font-size:0.75rem; color:#64748b;">You have:</div><div>${d.qualificationGap?.experienceYouHave || '-'}</div></div>
          </div>
          <span class="tag ${(d.qualificationGap?.gapAssessment || '').includes('GOOD') ? 'tag-success' : 'tag-warning'}">${(d.qualificationGap?.gapAssessment || 'Unknown').replace(/_/g, ' ')}</span>
          <p class="text-muted mt-4" style="font-size:0.9rem;">${d.qualificationGap?.yearsGap || ''}</p>
          ${d.qualificationGap?.howToCloseGap ? `<div class="item success mt-4"><div class="item-desc">${d.qualificationGap.howToCloseGap}</div></div>` : ''}
        </div>
        
        ${(d.dealbreakers || []).length > 0 ? `
        <div class="analysis-card">
          <h4>üõë Dealbreakers</h4>
          ${d.dealbreakers.map(db => `
            <div class="item danger">
              <div class="item-title">${db.requirement}</div>
              <div class="item-desc">Status: ${db.status}</div>
              ${db.urgentFix ? `<div class="item-fix">üîß ${db.urgentFix}</div>` : ''}
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        ${(d.strengths || []).length > 0 ? `
        <div class="analysis-card">
          <h4>üí™ Your Strengths</h4>
          ${d.strengths.map(s => `
            <div class="item success">
              <div class="item-title">${s.skill}</div>
              <div class="item-desc">${s.howItHelps}</div>
              ${s.howToHighlight ? `<div class="item-fix">üí° ${s.howToHighlight}</div>` : ''}
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        <div class="analysis-card">
          <h4>üë• Your Competition</h4>
          <div class="item mb-4"><div style="font-size:0.8rem; color:#64748b;">Typical winner:</div><div style="font-size:0.9rem;">${d.competitorAnalysis?.typicalWinningCandidate || '-'}</div></div>
          <div class="item mb-4"><div style="font-size:0.8rem; color:#64748b;">How you compare:</div><div style="font-size:0.9rem;">${d.competitorAnalysis?.howYouCompare || '-'}</div></div>
          <div class="grid-2" style="gap:8px;">
            <div class="item success"><div style="font-size:0.75rem; color:#10b981;">Your advantage:</div><div style="font-size:0.85rem;">${d.competitorAnalysis?.yourCompetitiveAdvantage || '-'}</div></div>
            <div class="item danger"><div style="font-size:0.75rem; color:#ef4444;">Your disadvantage:</div><div style="font-size:0.85rem;">${d.competitorAnalysis?.yourBiggestDisadvantage || '-'}</div></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0;">üìã Your Action Plan</h3>
        <span class="tag tag-info">Quick Boost Available ‚ö°</span>
      </div>
      <div class="grid-2">
        <div>
          <div style="color:#ef4444; font-size:0.85rem; font-weight:600; margin-bottom:8px;">üö® Critical Fixes (High Impact):</div>
          <ul class="action-list urgent">${(d.prioritizedActionPlan?.before_applying || []).map(a => `<li>${a}</li>`).join('') || '<li class="text-muted">None</li>'}</ul>
        </div>
        <div>
          <div style="color:#10b981; font-size:0.85rem; font-weight:600; margin-bottom:8px;">‚ö° Quick Wins (Low Effort):</div>
          <ul class="action-list quick">
            ${(d.prioritizedActionPlan?.quick_wins || []).map(a => `<li>${a}</li>`).join('')}
            <li style="color: #f59e0b; font-weight: 500;">üí° Pro-Tip: Use the "Copy Optimized Text" buttons below to update your resume in seconds!</li>
          </ul>
        </div>
      </div>
    </div>
    
    ${(d.resumeRewrites || []).length > 0 ? `
    <div class="card">
      <h3 class="mb-4">‚úçÔ∏è Suggested Rewrites</h3>
      <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 16px;">Click the copy icon to quickly update your resume!</p>
      ${d.resumeRewrites.map((r, idx) => `
        <div style="border-radius:10px; padding:16px; margin-bottom:12px; position: relative;" class="item">
          <div style="font-size:0.8rem; margin-bottom:8px;" class="text-muted">${r.section || 'Resume section'}</div>
          
          <div style="font-size:0.75rem; color:#ef4444; margin-bottom:4px;">BEFORE:</div>
          <div style="padding:10px; border-radius:6px; text-decoration:line-through; font-size: 0.9rem;" class="text-muted item danger">${r.currentText}</div>
          
          <div style="font-size:0.75rem; color:#10b981; margin:12px 0 4px; display: flex; justify-content: space-between; align-items: center;">
            <span>AFTER:</span>
            <button class="btn btn-secondary btn-sm" onclick="copyToClipboard(\`${r.rewrittenText.replace(/`/g, '\\`').replace(/\${/g, '\\${')}\`, this)" style="padding: 2px 8px; font-size: 0.7rem;">
               üìã Copy Optimized Text
            </button>
          </div>
          <div style="padding:10px; border-radius:6px; font-size: 0.9rem; font-weight: 500;" class="item success">${r.rewrittenText}</div>
          
          ${r.whyBetter ? `<div style="font-size:0.85rem; margin-top:8px; font-style:italic;" class="text-muted">Why: ${r.whyBetter}</div>` : ''}
        </div>
      `).join('')}
    </div>
    ` : ''}
    
    <div class="bottom-line">
      <h3>üí¨ The Bottom Line</h3>
      <p style="font-size:1.05rem; margin-bottom:16px; color:#e2e8f0;">${d.bottomLine?.honestAssessment || ''}</p>
      <div class="one-thing">
        <div class="one-thing-label">If you fix ONE thing, fix this:</div>
        <div class="one-thing-text">${d.bottomLine?.oneThingToFix || ''}</div>
      </div>
      <p class="encouragement">${d.bottomLine?.encouragement || ''}</p>
    </div>
    
    <!-- HIDDEN BUTTONS FOR ACTION CARDS -->
    <button id="generate-cover-letter-btn" style="display:none"></button>
    <button id="generate-interview-prep-btn" style="display:none"></button>

    <!-- Cover Letter Output -->
    <div id="cover-letter-output" style="display:none">
      <div class="card">
        <div class="flex justify-between items-center mb-4">
          <h3>‚úâÔ∏è Your Personalized Cover Letter</h3>
          <div class="flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="copyCoverLetter()">üìã Copy</button>
            <button class="btn btn-primary btn-sm" onclick="saveCurrentCoverLetter()">üíæ Save</button>
          </div>
        </div>
        <div id="cover-letter-content" style="background: #0a0a0f; padding: 20px; border-radius: 10px; white-space: pre-wrap; font-family: Georgia, serif; line-height: 1.8; color: #e2e8f0;"></div>
      </div>
    </div>

    <!-- Elevator Pitch Output -->
    <div id="elevator-pitch-output" style="display:none">
      <div class="card">
        <div class="flex justify-between items-center mb-4">
          <h3>üöÄ Your Elevator Pitch</h3>
          <div class="flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="copyElevatorPitch()">üìã Copy</button>
            <button class="btn btn-primary btn-sm" onclick="saveCurrentElevatorPitch()">üíæ Save</button>
          </div>
        </div>
        <div id="elevator-pitch-content" style="background: #0a0a0f; padding: 20px; border-radius: 10px; white-space: pre-wrap; font-family: Georgia, serif; line-height: 1.8; color: #e2e8f0;"></div>
      </div>
    </div>

    <!-- Interview Prep Output -->
    <div id="interview-prep-output" style="display:none">
      <div class="card">
        <div class="flex justify-between items-center mb-4">
          <h3>üéØ Your Interview Preparation</h3>
          <button class="btn btn-secondary btn-sm" onclick="saveCurrentInterviewPrep()">üíæ Save</button>
        </div>
        <div id="interview-prep-content"></div>
      </div>
    </div>
  `;

          // Attach button listeners
          setTimeout(() => {
            const clBtn = document.getElementById('generate-cover-letter-btn');
            if (clBtn) clBtn.addEventListener('click', generateAnalysisCoverLetter);

            const ipBtn = document.getElementById('generate-interview-prep-btn');
            if (ipBtn) ipBtn.addEventListener('click', generateAnalysisInterviewPrep);
          }, 100);

          document.getElementById('analysis-results').scrollIntoView({ behavior: 'smooth' });
        }

        // Helper function to switch to Networking tab
        function switchToNetworking() {
          document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
          document.querySelector('[data-tab="networking"]').classList.add('active');
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          document.getElementById('tab-networking').classList.add('active');
          document.getElementById('tab-networking').scrollIntoView({ behavior: 'smooth' });
        }

        // ========== COVER LETTER GENERATOR (ANALYZE PAGE) ==========
        let lastAnalysisData = null; // Store the analysis data for cover letter

        async function generateAnalysisCoverLetter() {
          const jobDesc = document.getElementById('job-description').value.trim();
          if (!jobDesc) {
            showToast('Job description is required for cover letter', 'error');
            return;
          }

          if (!lastAnalysisData) {
            showToast('Please analyze your resume first', 'error');
            return;
          }

          // Ensure sessionId exists before generating cover letter (stable, based on email only)
          if (!sessionId) {
            if (currentUser && currentUser.email) {
              sessionId = 'sess_' + btoa(currentUser.email).replace(/[=\/\+]/g, '').toLowerCase().substring(0, 15);
              localStorage.setItem('jobmatch_session', sessionId);
            } else {
              showToast('Please log in first', 'error');
              return;
            }
          }

          // Show loading toast
          showToast('Generating cover letter...', 'success');

          try {
            const res = await fetch('/api/generate-specific-cover-letter', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sessionId: sessionId,
                jobDescription: jobDesc,
                analysisData: lastAnalysisData
              })
            });

            if (res.status === 402) {
              showPaywallModal();
              return;
            }

            const data = await res.json();

            if (!data.success) throw new Error(data.error || 'Generation failed');

            // Display the cover letter
            document.getElementById('cover-letter-content').textContent = data.data.coverLetter;
            document.getElementById('cover-letter-output').style.display = 'block';
            document.getElementById('cover-letter-output').scrollIntoView({ behavior: 'smooth' });

            showToast('Cover letter generated!', 'success');

          } catch (err) {
            console.error('Cover letter error:', err);
            showToast(String(err.message || 'Generation failed'), 'error');
          }
        }

        function copyCoverLetter() {
          const content = document.getElementById('cover-letter-content').textContent;
          navigator.clipboard.writeText(content).then(() => {
            showToast('Cover letter copied!', 'success');
          }).catch(() => {
            showToast('Failed to copy', 'error');
          });
        }

        function saveCurrentCoverLetter() {
          const content = document.getElementById('cover-letter-content').textContent;
          if (!content) {
            showToast('No cover letter to save', 'error');
            return;
          }

          // Extract job info from the job description
          const jobDesc = document.getElementById('job-description').value || '';

          // Try to extract company name
          const companyMatch = jobDesc.match(/(?:at|@|company[:\s]+|about[:\s]+)([A-Z][a-zA-Z0-9\s&]+?)(?:\.|,|\n|is|we|has)/i) ||
            jobDesc.match(/([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+)?)\s+is\s+(?:seeking|hiring|looking)/i);
          const companyName = companyMatch ? companyMatch[1].trim() : 'Company';

          // Try to extract job title
          const titleMatch = jobDesc.match(/(?:title|position|role)[:\s]+([^\n]+)/i) ||
            jobDesc.match(/(?:seeking|hiring|looking for)[:\s]+(?:an?\s+)?([^\n.]+)/i) ||
            jobDesc.match(/^([A-Z][a-zA-Z\s]+(?:Engineer|Manager|Director|Developer|Architect|Lead|Analyst))/m);
          const jobTitle = titleMatch ? titleMatch[1].trim().substring(0, 50) : 'Job Role';

          if (saveCoverLetter(content, jobTitle, companyName)) {
            showToast('Cover letter saved! View in "My Cover Letters"', 'success');
          }
        }

        // ========== ELEVATOR PITCH GENERATOR (ANALYZE PAGE) ==========
        async function generateElevatorPitch() {
          const jobDesc = document.getElementById('job-description').value.trim();
          if (!jobDesc) {
            showToast('Job description is required for elevator pitch', 'error');
            return;
          }

          if (!lastAnalysisData) {
            showToast('Please analyze your resume first', 'error');
            return;
          }

          // Ensure sessionId exists before generating elevator pitch (stable, based on email only)
          if (!sessionId) {
            if (currentUser && currentUser.email) {
              sessionId = 'sess_' + btoa(currentUser.email).replace(/[=\/\+]/g, '').toLowerCase().substring(0, 15);
              localStorage.setItem('jobmatch_session', sessionId);
            } else {
              showToast('Please log in first', 'error');
              return;
            }
          }

          // Show loading toast
          showToast('Generating elevator pitch...', 'success');

          try {
            const res = await fetch('/api/generate-elevator-pitch', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sessionId: sessionId,
                jobDescription: jobDesc,
                analysisData: lastAnalysisData
              })
            });

            if (res.status === 402) {
              showPaywallModal();
              return;
            }

            const data = await res.json();

            if (!data.success) throw new Error(data.error || 'Generation failed');

            // Display the elevator pitch
            document.getElementById('elevator-pitch-content').textContent = data.data.pitchText;
            document.getElementById('elevator-pitch-output').style.display = 'block';
            document.getElementById('elevator-pitch-output').scrollIntoView({ behavior: 'smooth' });

            showToast('Elevator pitch generated!', 'success');

          } catch (err) {
            console.error('Elevator pitch error:', err);
            showToast(String(err.message || 'Generation failed'), 'error');
          }
        }

        function copyElevatorPitch() {
          const content = document.getElementById('elevator-pitch-content').textContent;
          navigator.clipboard.writeText(content).then(() => {
            showToast('Elevator pitch copied!', 'success');
          }).catch(() => {
            showToast('Failed to copy', 'error');
          });
        }

        function saveCurrentElevatorPitch() {
          const content = document.getElementById('elevator-pitch-content').textContent;
          if (!content) {
            showToast('No elevator pitch to save', 'error');
            return;
          }

          // Extract job info from the job description
          const jobDesc = document.getElementById('job-description').value || '';

          // Try to extract company name
          const companyMatch = jobDesc.match(/(?:at|@|company[:\s]+|about[:\s]+)([A-Z][a-zA-Z0-9\s&]+?)(?:\.|,|\n|is|we|has)/i) ||
            jobDesc.match(/([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+)?)\s+is\s+(?:seeking|hiring|looking)/i);
          const companyName = companyMatch ? companyMatch[1].trim() : 'Company';

          // Try to extract job title
          const titleMatch = jobDesc.match(/(?:title|position|role)[:\s]+([^\n]+)/i) ||
            jobDesc.match(/(?:seeking|hiring|looking for)[:\s]+(?:an?\s+)?([^\n.]+)/i) ||
            jobDesc.match(/^([A-Z][a-zA-Z\s]+(?:Engineer|Manager|Director|Developer|Architect|Lead|Analyst))/m);
          const jobTitle = titleMatch ? titleMatch[1].trim().substring(0, 50) : 'Job Role';

          // Save to localStorage (similar to cover letters)
          const savedPitches = JSON.parse(localStorage.getItem('saved_elevator_pitches') || '[]');
          const pitchData = {
            id: Date.now(),
            content: content,
            jobTitle: jobTitle,
            companyName: companyName,
            createdAt: new Date().toISOString(),
            jobDescription: jobDesc.substring(0, 500) + (jobDesc.length > 500 ? '...' : '')
          };

          savedPitches.unshift(pitchData);

          // Keep only last 50 pitches
          if (savedPitches.length > 50) {
            savedPitches.splice(50);
          }

          localStorage.setItem('saved_elevator_pitches', JSON.stringify(savedPitches));
          showToast('Elevator pitch saved!', 'success');
        }

        // ========== INTERVIEW PREP GENERATOR (ANALYZE PAGE) ==========
        async function generateAnalysisInterviewPrep() {
          const jobDesc = document.getElementById('job-description').value.trim();
          if (!jobDesc) {
            showToast('Job description is required for interview prep', 'error');
            return;
          }

          if (!lastAnalysisData) {
            showToast('Please analyze your resume first', 'error');
            return;
          }

          if (!sessionId) {
            if (currentUser && currentUser.email) {
              sessionId = 'sess_' + btoa(currentUser.email).replace(/[=\/\+]/g, '').toLowerCase().substring(0, 15);
              localStorage.setItem('jobmatch_session', sessionId);
            } else {
              showToast('Please log in first', 'error');
              return;
            }
          }

          showToast('Generating interview prep...', 'success');

          try {
            const res = await fetch('/api/generate-interview-prep', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sessionId,
                jobDescription: jobDesc,
                analysisData: lastAnalysisData
              })
            });

            if (res.status === 402) {
              showPaywallModal();
              return;
            }

            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Generation failed');

            // Display interview prep
            const questions = data.data.questions || [];
            const questionsToAsk = data.data.questionsToAsk || [];

            let html = '<div style="max-height: 600px; overflow-y: auto;">';

            // Questions to answer
            html += '<h4 style="margin-bottom: 16px;">üìù Common Interview Questions</h4>';
            questions.forEach((q, i) => {
              html += `
        <div class="analysis-card" style="margin-bottom: 16px;">
          <h5 style="font-size: 0.95rem; color: #6366f1; margin-bottom: 8px;">${i + 1}. ${q.question}</h5>
          <div style="background: #0a0a0f; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
            <div style="font-size: 0.85rem; color: #e2e8f0; margin-bottom: 8px;"><strong>Suggested Answer:</strong></div>
            <div style="font-size: 0.85rem; color: #94a3b8; line-height: 1.6;">${q.suggestedAnswer}</div>
          </div>
          ${q.tips ? `<div style="font-size: 0.8rem; color: #64748b; font-style: italic;">üí° ${q.tips}</div>` : ''}
        </div>
      `;
            });

            // Questions to ask interviewer
            if (questionsToAsk.length > 0) {
              html += '<h4 style="margin-top: 24px; margin-bottom: 16px;">‚ùì Questions to Ask the Interviewer</h4>';
              questionsToAsk.forEach((q, i) => {
                html += `<div class="item success" style="margin-bottom: 8px;">${i + 1}. ${q}</div>`;
              });
            }

            html += '</div>';

            document.getElementById('interview-prep-content').innerHTML = html;
            document.getElementById('interview-prep-output').style.display = 'block';
            document.getElementById('interview-prep-output').scrollIntoView({ behavior: 'smooth' });

            lastInterviewPrepData = data.data; // Store for saving
            showToast('Interview prep ready!', 'success');

          } catch (err) {
            console.error('Interview prep error:', err);
            showToast(String(err.message || 'Generation failed'), 'error');
          }
        }

        function saveCurrentInterviewPrep() {
          showToast('Interview prep saved!', 'success');
          // TODO: Implement save to localStorage/database
        }

        // ========== SEARCH TAB ==========
        const searchZone = document.getElementById('search-upload-zone');
        const searchInput = document.getElementById('search-resume-input');
        const extractBtn = document.getElementById('extract-btn');

        searchZone.addEventListener('click', () => searchInput.click());
        searchZone.addEventListener('dragover', e => { e.preventDefault(); searchZone.style.borderColor = '#6366f1'; });
        searchZone.addEventListener('dragleave', () => { searchZone.style.borderColor = searchFile ? '#10b981' : '#2e2e3e'; });
        searchZone.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files[0]) handleSearchFile(e.dataTransfer.files[0]); });
        searchInput.addEventListener('change', e => { if (e.target.files[0]) handleSearchFile(e.target.files[0]); });

        function handleSearchFile(file) {
          if (!file.name.match(/\.(pdf|doc|docx)$/i)) { showToast('Please upload PDF or Word', 'error'); return; }
          searchFile = file;
          document.getElementById('search-file-name').textContent = '‚úì ' + file.name;
          searchZone.classList.add('has-file');
          extractBtn.disabled = false;
        }

        extractBtn.addEventListener('click', async () => {
          if (!searchFile) return;
          setLoading('extract', true, 'Extracting profile...');

          try {
            const formData = new FormData();
            formData.append('resume', searchFile);

            const res = await fetch('/api/extract-profile', { method: 'POST', body: formData });
            const data = await res.json();

            if (!data.success) throw new Error(data.error);

            sessionId = data.data.sessionId;
            window.sessionId = sessionId; // Sync window scope
            profile = data.data.profile;
            localStorage.setItem('jobmatch_session', sessionId);

            // Auto-save profile and file if user is logged in
            if (currentUser) {
              try {
                const fileBase64 = await fileToBase64(searchFile);
                saveUserResume(data.data.resumeText || '', searchFile.name, profile, fileBase64);
                showToast('Profile extracted and saved to your account!', 'success');
              } catch (e) {
                saveUserResume(data.data.resumeText || '', searchFile.name, profile);
                showToast('Profile extracted and saved!', 'success');
              }
            } else {
              showToast('Profile extracted! Log in to save it.', 'success');
            }

            displayProfile();

          } catch (err) {
            showToast(err.message, 'error');
          } finally {
            setLoading('extract', false, 'Extract My Profile & Find Jobs');
          }
        });

        function displayProfile(profileData) {
          // Use provided profile or global resume profile or default profile variable
          const profileToShow = profileData || globalResumeState.profile || profile;

          // CLEANUP: Always remove empty hints when displaying a profile
          document.querySelectorAll('.empty-hint').forEach(h => h.remove());

          if (!profileToShow) {
            console.warn('No profile data available');
            return;
          }

          document.getElementById('search-upload-card').style.display = 'none';
          document.getElementById('profile-card').style.display = 'block';

          document.getElementById('profile-name').textContent = profileToShow.name || 'Your Profile';
          document.getElementById('profile-title').textContent = profileToShow.currentTitle || '';
          document.getElementById('profile-exp').textContent = `${profileToShow.yearsExperience || '?'} years`;
          document.getElementById('profile-level').textContent = profileToShow.experienceLevel || '';
          document.getElementById('profile-location').textContent = profileToShow.location || '';
          document.getElementById('profile-skills').innerHTML = (profileToShow.hardSkills || []).slice(0, 8).map(s => `<span class="tag tag-info">${s}</span>`).join('');

          // Store for use in job search
          profile = profileToShow;

          if (profile.targetTitles?.[0]) document.getElementById('search-query').value = profile.targetTitles[0];
          if (profile.location) document.getElementById('search-location').value = profile.location;
        }

        document.getElementById('search-jobs-btn').addEventListener('click', searchJobs);
        document.getElementById('search-query').addEventListener('keypress', e => { if (e.key === 'Enter') searchJobs(); });

        async function searchJobs() {
          if (!sessionId || !profile) { showToast('Upload resume first', 'error'); return; }

          // Generate links INSTANTLY (client-side, no API)
          const searchLinks = generateSearchLinksClientSide();
          displaySearchLinks(searchLinks);
          document.getElementById('job-results').style.display = 'block';
          document.getElementById('suggestions-section').style.display = 'none'; // Hide suggestions section
          showToast('Search links ready! Click any to find jobs.', 'success');
        }

        function generateSearchLinksClientSide() {
          const title = document.getElementById('search-query').value || profile.targetTitles?.[0] || profile.currentTitle || 'software engineer';
          const location = document.getElementById('search-location').value || profile.location || '';
          const encode = encodeURIComponent;

          // ATS sites for Fresh Jobs - all 15 sites
          const atsSites = [
            'myworkdayjobs.com', 'greenhouse.io', 'lever.co', 'icims.com',
            'smartrecruiters.com', 'taleo.net', 'jobvite.com', 'workforcenow.adp.com',
            'bamboohr.com', 'brassring.com', 'breezy.hr', 'bullhorn.com',
            'jazzhr.com', 'jobdiva.com', 'successfactors.com'
          ];

          // Extract seniority levels from title
          const seniorityLevels = ['Director', 'Head of', 'VP', 'Vice President', 'Principal', 'Lead', 'Senior', 'Manager', 'Chief', 'CTO', 'CIO'];
          const foundSeniority = seniorityLevels.filter(level =>
            title.toLowerCase().includes(level.toLowerCase()) ||
            (profile.targetTitles || []).some(t => t.toLowerCase().includes(level.toLowerCase()))
          );
          const seniorityQuery = foundSeniority.length > 0
            ? foundSeniority.slice(0, 4)
            : ['Director', 'Manager', 'Lead']; // Default

          // Extract domain/field keywords from title and target roles
          const domainKeywords = ['AI', 'Machine Learning', 'ML', 'Data', 'Engineering', 'Technology',
            'Enterprise Architecture', 'Platform', 'Digital Transformation', 'Automation',
            'Cloud', 'Software', 'Product', 'Analytics', 'Infrastructure', 'DevOps', 'Security'];
          const titleAndTargets = [title, ...(profile.targetTitles || [])].join(' ');
          const foundDomains = domainKeywords.filter(domain =>
            titleAndTargets.toLowerCase().includes(domain.toLowerCase())
          );
          const domainQuery = foundDomains.length > 0
            ? foundDomains.slice(0, 5)
            : ['Technology', 'Engineering', 'Software']; // Default

          // Extract tech skills from profile
          const techSkills = (profile.hardSkills || []).slice(0, 6);
          const skillsQuery = techSkills.length > 0 ? techSkills : ['Python', 'AWS', 'Cloud'];

          // Location - simplified
          const loc = location.replace(/"/g, '').split(',')[0].trim();
          const locationQuery = loc
            ? [loc, 'remote', 'United States']
            : ['remote', 'United States', 'worldwide'];

          // Build the smart Boolean query
          // Format: (sites) (seniority) (domain) (skills) (location)
          const sitesStr = atsSites.map(s => `site:${s}`).join(' OR ');
          const seniorityStr = seniorityQuery.map(s => `"${s}"`).join(' OR ');
          const domainStr = domainQuery.map(d => `"${d}"`).join(' OR ');
          const skillsStr = skillsQuery.map(s => `"${s}"`).join(' OR ');
          const locationStr = locationQuery.map(l => `"${l}"`).join(' OR ');

          const smartQuery = `(${sitesStr}) (${seniorityStr}) (${domainStr}) (${skillsStr}) (${locationStr})`;
          const freshJobsAllUrl = `https://www.google.com/search?q=${encodeURIComponent(smartQuery)}&tbs=qdr:w`;
          const freshJobs24hUrl = `https://www.google.com/search?q=${encodeURIComponent(smartQuery)}&tbs=qdr:d`;

          // Individual ATS site searches with simplified query
          const topSites = [
            { site: 'myworkdayjobs.com', name: 'Workday' },
            { site: 'greenhouse.io', name: 'Greenhouse' },
            { site: 'lever.co', name: 'Lever' },
            { site: 'icims.com', name: 'iCIMS' },
            { site: 'smartrecruiters.com', name: 'SmartRecruiters' },
            { site: 'taleo.net', name: 'Taleo' }
          ];

          const freshJobsIndividual = topSites.map(ats => {
            const singleSiteQuery = `site:${ats.site} (${seniorityStr}) (${domainStr}) (${locationStr})`;
            return {
              name: ats.name,
              url: `https://www.google.com/search?q=${encodeURIComponent(singleSiteQuery)}&tbs=qdr:w`
            };
          });

          // Build smart search queries for job boards
          // LinkedIn/Indeed support Boolean OR in search
          const seniorityTerms = seniorityQuery.join(' OR ');  // "Director" OR "Head of" OR "VP"
          const domainTerms = domainQuery.join(' OR ');        // "AI" OR "Engineering" OR "Technology"
          const topSkills = skillsQuery.slice(0, 3).join(' OR '); // "AWS" OR "Python" OR "MLOps"

          // Smart query for LinkedIn (supports OR)
          const linkedInQuery = `(${seniorityTerms}) (${domainTerms})`;

          // Smart query for Indeed (supports Boolean)
          const indeedQuery = `(${seniorityTerms}) (${domainTerms})`;

          // Smart query for Google Jobs
          const googleJobsQuery = `(${seniorityTerms}) (${domainTerms}) (${topSkills}) ${loc || 'remote'}`;

          return {
            primary: [
              { name: 'LinkedIn', icon: 'üíº', url: `https://www.linkedin.com/jobs/search/?keywords=${encode(linkedInQuery)}&location=${encode(location)}` },
              { name: 'Indeed', icon: 'üîç', url: `https://www.indeed.com/jobs?q=${encode(indeedQuery)}&l=${encode(location)}` },
              { name: 'Glassdoor', icon: '‚≠ê', url: `https://www.glassdoor.com/Job/jobs.htm?sc.keyword=${encode(linkedInQuery)}&locKeyword=${encode(location)}` },
              { name: 'Google Jobs', icon: 'üîé', url: `https://www.google.com/search?q=${encode(googleJobsQuery + ' jobs')}&ibp=htl;jobs` }
            ],
            secondary: [
              { name: 'ZipRecruiter', icon: '‚ö°', url: `https://www.ziprecruiter.com/jobs-search?search=${encode(linkedInQuery)}&location=${encode(location)}` },
              { name: 'Monster', icon: 'üëæ', url: `https://www.monster.com/jobs/search?q=${encode(linkedInQuery)}&where=${encode(location)}` },
              { name: 'CareerBuilder', icon: 'üèóÔ∏è', url: `https://www.careerbuilder.com/jobs?keywords=${encode(linkedInQuery)}&location=${encode(location)}` },
              { name: 'SimplyHired', icon: '‚ú®', url: `https://www.simplyhired.com/search?q=${encode(indeedQuery)}&l=${encode(location)}` }
            ],
            tech: [
              { name: 'Dice', icon: 'üé≤', url: `https://www.dice.com/jobs?q=${encode(linkedInQuery)}&location=${encode(location)}` },
              { name: 'Built In', icon: 'üè¢', url: `https://builtin.com/jobs?search=${encode(domainTerms)}&location=${encode(location)}` },
              { name: 'Wellfound', icon: 'üöÄ', url: `https://wellfound.com/jobs?query=${encode(domainTerms)}` },
              { name: 'Levels.fyi', icon: 'üìä', url: `https://www.levels.fyi/jobs?searchText=${encode(linkedInQuery)}&location=${encode(location)}` }
            ],
            remote: [
              { name: 'We Work Remotely', icon: 'üåç', url: `https://weworkremotely.com/remote-jobs/search?term=${encode(domainTerms)}` },
              { name: 'Remote OK', icon: 'üè†', url: `https://remoteok.com/remote-${encode(domainQuery[0] || 'tech').toLowerCase().replace(/\s+/g, '-')}-jobs` },
              { name: 'FlexJobs', icon: 'üßò', url: `https://www.flexjobs.com/search?search=${encode(linkedInQuery)}` },
              { name: 'Remote.co', icon: 'üíª', url: `https://remote.co/remote-jobs/search/?search_keywords=${encode(domainTerms)}` }
            ],
            nonProfit: [
              { name: 'Idealist', icon: 'üå±', url: `https://www.idealist.org/en/jobs?q=${encode(domainTerms)}` },
              { name: 'LinkedIn Non-Profit', icon: 'ü§ù', url: `https://www.linkedin.com/jobs/search/?keywords=${encode(domainTerms)}&f_JT=VOLUNTEER%2COTHER&f_E=1%2C2%2C3` },
              { name: 'Philanthropy News', icon: 'üì∞', url: `https://philanthropynewsdigest.org/jobs?keyword=${encode(domainTerms)}` },
              { name: 'NGO Jobs', icon: 'üåç', url: `https://www.ngojobs.eu/jobs?search=${encode(domainTerms)}` }
            ],
            freshJobs: freshJobsIndividual,
            freshJobsAll: freshJobsAllUrl,
            freshJobs24h: freshJobs24hUrl,
            bySkill: (profile.hardSkills || []).slice(0, 5).map(skill => ({
              skill,
              url: `https://www.linkedin.com/jobs/search/?keywords=${encode(skill + ' ' + seniorityQuery[0])}&location=${encode(location)}`
            })),
            byTitle: (profile.targetTitles || []).slice(0, 4).map(t => ({
              title: t,
              linkedin: `https://www.linkedin.com/jobs/search/?keywords=${encode(t)}&location=${encode(location)}`,
              indeed: `https://www.indeed.com/jobs?q=${encode(t)}&l=${encode(location)}`
            }))
          };
        }

        function displaySearchLinks(links) {
          // Primary job boards
          document.getElementById('primary-links').innerHTML = links.primary.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-primary" style="text-decoration: none;">
      ${l.icon} ${l.name}
    </a>
  `).join('');

          // Secondary job boards (General)
          document.getElementById('secondary-links').innerHTML = links.secondary.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none;">
      ${l.icon} ${l.name}
    </a>
  `).join('');

          // Tech job boards
          document.getElementById('tech-links').innerHTML = links.tech.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none;">
      ${l.icon} ${l.name}
    </a>
  `).join('');

          // Remote job boards
          document.getElementById('remote-links').innerHTML = links.remote.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none;">
      ${l.icon} ${l.name}
    </a>
  `).join('');

          // Non-Profit job boards
          document.getElementById('non-profit-links').innerHTML = links.nonProfit.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none; border-color: #10b981; color: #10b981;">
      ${l.icon} ${l.name}
    </a>
  `).join('');

          // Fresh Jobs - Individual ATS sites
          document.getElementById('fresh-jobs-links').innerHTML = links.freshJobs.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none; border-color: #f59e0b;">
      üî• ${l.name}
    </a>
  `).join('');

          // Fresh Jobs - All ATS combined (Past Week - more results)
          document.getElementById('fresh-jobs-all').innerHTML = `
    <a href="${links.freshJobsAll}" target="_blank" class="btn btn-primary" style="text-decoration: none; background: linear-gradient(135deg, #f59e0b, #ef4444);">
      üî• ALL ATS Sites (Past Week)
    </a>
  `;

          // Fresh Jobs - Last 24h option
          document.getElementById('fresh-jobs-24h').innerHTML = `
    <a href="${links.freshJobs24h}" target="_blank" class="btn btn-secondary" style="text-decoration: none; border-color: #f59e0b; color: #f59e0b;">
      ‚ö° Last 24 Hours Only
    </a>
  `;

          // By title
          document.getElementById('title-links').innerHTML = links.byTitle.map(t => `
    <div style="margin-bottom: 8px;">
      <span style="color: #e2e8f0; font-size: 0.9rem; margin-right: 8px;">${t.title}</span>
      <a href="${t.linkedin}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">LinkedIn</a>
      <a href="${t.indeed}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">Indeed</a>
    </div>
  `).join('');

          // By skill
          document.getElementById('skill-links').innerHTML = links.bySkill.map(s => `
    <a href="${s.url}" target="_blank" class="tag tag-info" style="text-decoration: none; cursor: pointer;">
      ${s.skill} ‚Üí
    </a>
  `).join('');
        }

        function displayJobs(list, filter = 'all') {
          let filtered = list;
          if (filter === 'excellent') filtered = list.filter(j => j.matchScore >= 80);
          else if (filter === 'good') filtered = list.filter(j => j.matchScore >= 60 && j.matchScore < 80);

          document.getElementById('jobs-count').textContent = filtered.length;

          document.getElementById('job-list').innerHTML = filtered.length === 0
            ? '<div class="empty-state"><div class="icon">üîç</div><h3>No jobs match this filter</h3></div>'
            : filtered.map(job => {
              const scoreClass = job.matchScore >= 80 ? 'high' : job.matchScore >= 60 ? 'medium' : 'low';
              const cardClass = job.matchScore >= 80 ? 'excellent' : job.matchScore >= 60 ? 'good' : 'moderate';
              const recClass = job.recommendation === 'APPLY_NOW' ? 'apply-now' : job.recommendation === 'WORTH_APPLYING' ? 'worth-it' : job.recommendation === 'CUSTOMIZE_FIRST' ? 'customize' : 'skip';

              // For suggestions, create search URLs. For real jobs, use applyUrl
              const searchQuery = encodeURIComponent(`${job.title} ${job.company}`);
              const linkedInUrl = job.applyUrl || job.searchUrl || `https://www.linkedin.com/jobs/search/?keywords=${searchQuery}`;
              const indeedUrl = `https://www.indeed.com/jobs?q=${searchQuery}`;

              return `
        <div class="job-card ${cardClass}">
          <div class="job-header">
            <div>
              <div class="job-title">${job.title}</div>
              <div class="job-company">${job.company}${job.isSuggestion ? ' <span style="font-size:0.75rem; color:#64748b;">(suggested)</span>' : ''}</div>
              ${job.location ? `<div class="job-meta">
                <span>üìç ${job.location}</span>
                ${job.salary ? `<span>üí∞ ${job.salary}</span>` : ''}
                ${job.postedDate ? `<span>üïê ${job.postedDate}</span>` : ''}
                ${job.isRemote ? '<span>üè† Remote</span>' : ''}
              </div>` : ''}
            </div>
            <div style="text-align:right;">
              <div class="match-percent ${scoreClass}">${job.matchScore}%</div>
              <div style="font-size:0.7rem; color:#64748b;">MATCH</div>
            </div>
          </div>
          <div class="flex gap-2 items-center mt-4">
            <span class="recommendation ${recClass}">${(job.recommendation || 'WORTH_APPLYING').replace(/_/g, ' ')}</span>
            ${(job.matchingSkills || []).slice(0, 3).map(s => `<span class="tag tag-success" style="font-size:0.75rem;">${s}</span>`).join('')}
          </div>
          <p style="color:#94a3b8; font-size:0.9rem; margin-top:12px;">${job.quickTake || job.description || ''}</p>
          <div class="flex gap-2 flex-wrap mt-4">
            <button class="btn btn-primary btn-sm" onclick="generateCoverLetter('${job.id}')">üìù Cover Letter</button>
            <button class="btn btn-info btn-sm" onclick="tailorForJob('${job.id}')">üéØ Tailor Resume</button>
            <button class="btn btn-secondary btn-sm" onclick="saveJob('${job.id}')">üíæ Save</button>
            <a href="${linkedInUrl}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration:none;">
               ${job.applyUrl ? 'üîó Apply Now' : 'üîó Find on LinkedIn'}
            </a>
            ${!job.applyUrl ? `<a href="${indeedUrl}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration:none;">üîó Indeed</a>` : ''}
          </div>
        </div>
      `;
            }).join('');
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            displayJobs(jobs, btn.dataset.filter);
          });
        });

        // ========== COVER LETTER ==========
        async function generateCoverLetter(jobId) {
          const job = jobs.find(j => j.id === jobId) || savedJobs.find(j => j.id === jobId);
          if (!job) return;

          // Ensure sessionId exists before generating cover letter (stable, based on email only)
          if (!sessionId) {
            if (currentUser && currentUser.email) {
              sessionId = 'sess_' + btoa(currentUser.email).replace(/[=\/\+]/g, '').toLowerCase().substring(0, 15);
              localStorage.setItem('jobmatch_session', sessionId);
            } else {
              showToast('Please log in first', 'error');
              return;
            }
          }

          currentJob = job;
          document.getElementById('cl-job-info').textContent = `For: ${job.title} at ${job.company}`;
          document.getElementById('cover-letter-text').innerHTML = '<div class="loading"></div> Generating...';
          document.getElementById('cover-letter-modal').classList.add('open');

          try {
            const res = await fetch('/api/generate-cover-letter', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId, jobId, companyName: job.company, jobTitle: job.title })
            });

            if (res.status === 402) {
              showPaywallModal();
              closeCoverLetterModal();
              return;
            }

            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            document.getElementById('cover-letter-text').textContent = data.data.coverLetter;
          } catch (err) {
            document.getElementById('cover-letter-text').textContent = 'Failed to generate. Please try again.';
          }
        }

        function closeCoverLetterModal() { document.getElementById('cover-letter-modal').classList.remove('open'); }
        function copyCoverLetter() { navigator.clipboard.writeText(document.getElementById('cover-letter-text').textContent); showToast('Copied!', 'success'); }
        function regenerateCoverLetter() { if (currentJob) generateCoverLetter(currentJob.id); }

        // ========== TRACKER ==========
        async function saveJob(jobId) {
          const job = jobs.find(j => j.id === jobId);
          if (!job) return;

          try {
            const res = await fetch('/api/save-job', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId, job, status: 'SAVED' })
            });

            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            savedJobs = data.data.savedJobs;
            updateTracker();
            showToast('Job saved!', 'success');
          } catch (err) {
            showToast(err.message, 'error');
          }
        }

        async function updateJobStatus(jobId, status) {
          try {
            const res = await fetch('/api/update-job-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId, jobId, status })
            });

            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            const job = savedJobs.find(j => j.id === jobId);
            if (job) job.status = status;
            updateTracker();
            showToast('Status updated!', 'success');
          } catch (err) {
            showToast(err.message, 'error');
          }
        }

        function updateTracker() {
          const counts = { SAVED: 0, APPLIED: 0, INTERVIEW: 0, REJECTED: 0 };
          savedJobs.forEach(j => { if (counts[j.status] !== undefined) counts[j.status]++; });

          document.getElementById('stat-saved').textContent = counts.SAVED;
          document.getElementById('stat-applied').textContent = counts.APPLIED;
          document.getElementById('stat-interview').textContent = counts.INTERVIEW;
          document.getElementById('stat-rejected').textContent = counts.REJECTED;
          document.getElementById('saved-badge').textContent = savedJobs.length;
          document.getElementById('saved-badge').style.display = savedJobs.length ? 'inline' : 'none';

          if (savedJobs.length === 0) {
            document.getElementById('no-saved-jobs').style.display = 'block';
            return;
          }

          document.getElementById('no-saved-jobs').style.display = 'none';
          document.getElementById('saved-jobs-list').innerHTML = savedJobs.map(job => {
            const searchQuery = encodeURIComponent(`${job.title} ${job.company}`);
            const applyUrl = job.applyUrl || job.searchUrl || `https://www.linkedin.com/jobs/search/?keywords=${searchQuery}`;
            return `
    <div class="job-card">
      <div class="job-header">
        <div>
          <div class="job-title">${job.title}</div>
          <div class="job-company">${job.company}</div>
          <div class="job-meta">
            ${job.location ? `<span>üìç ${job.location}</span>` : ''}
            <span class="tag ${job.status === 'INTERVIEW' ? 'tag-success' : job.status === 'APPLIED' ? 'tag-warning' : job.status === 'REJECTED' ? 'tag-danger' : 'tag-info'}">${job.status}</span>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="match-percent ${job.matchScore >= 70 ? 'high' : 'medium'}">${job.matchScore}%</div>
        </div>
      </div>
      <div class="flex gap-2 flex-wrap mt-4">
        <select onchange="updateJobStatus('${job.id}', this.value)" style="padding:8px; background:#1e1e2e; border:1px solid #2e2e3e; border-radius:8px; color:#e2e8f0;">
          <option value="SAVED" ${job.status === 'SAVED' ? 'selected' : ''}>Saved</option>
          <option value="APPLIED" ${job.status === 'APPLIED' ? 'selected' : ''}>Applied</option>
          <option value="INTERVIEW" ${job.status === 'INTERVIEW' ? 'selected' : ''}>Interview</option>
          <option value="OFFER" ${job.status === 'OFFER' ? 'selected' : ''}>Offer</option>
          <option value="REJECTED" ${job.status === 'REJECTED' ? 'selected' : ''}>Rejected</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="generateCoverLetter('${job.id}')">üìù Cover Letter</button>
        <a href="${applyUrl}" target="_blank" class="btn btn-primary btn-sm" style="text-decoration:none;">${job.applyUrl ? 'üîó Apply' : 'üîó Find Job'}</a>
      </div>
    </div>
  `;
          }).join('');
        }

        // ========== UTILITIES ==========
        function setLoading(prefix, loading, text) {
          document.getElementById(`${prefix}-btn-text`).textContent = text;
          document.getElementById(`${prefix}-loading`).style.display = loading ? 'inline-block' : 'none';
          document.getElementById(`${prefix}-btn`).disabled = loading;
        }

        function showToast(msg, type = 'info') {
          const t = document.getElementById('toast');
          t.textContent = msg;
          t.className = `toast ${type} show`;
          setTimeout(() => t.classList.remove('show'), 3000);
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeCoverLetterModal(); });

        // Load saved on init
        async function loadSaved() {
          if (!sessionId) return;
          try {
            const res = await fetch(`/api/saved-jobs?sessionId=${sessionId}`);
            const data = await res.json();
            if (data.success) { savedJobs = data.data.savedJobs || []; updateTracker(); }
          } catch (e) { }
        }
        loadSaved();

        // ============================================
        // ICA (LinkedIn Contact Advocates) Functionality
        // ============================================

        let icaSelectedFile = null;
        let icaContacts = [];

        const icaDropzone = document.getElementById('ica-dropzone');
        const icaFileInput = document.getElementById('ica-file-input');
        const icaFilePreview = document.getElementById('ica-file-preview');
        const icaFilename = document.getElementById('ica-filename');
        const icaUploadBtn = document.getElementById('ica-upload-btn');
        const icaCancelBtn = document.getElementById('ica-cancel-btn');
        const icaStatus = document.getElementById('ica-status');
        const icaStatsCard = document.getElementById('ica-stats-card');
        const icaContactsCard = document.getElementById('ica-contacts-card');
        const icaSearch = document.getElementById('ica-search');
        const icaFilter = document.getElementById('ica-filter');
        const icaContactsTbody = document.getElementById('ica-contacts-tbody');

        function showIcaStatus(message, type) {
          icaStatus.textContent = message;
          icaStatus.style.display = 'block';
          icaStatus.style.background = type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#6366f1';
          icaStatus.style.color = 'white';
        }

        function hideIcaStatus() {
          icaStatus.style.display = 'none';
        }

        icaDropzone.addEventListener('click', () => icaFileInput.click());
        icaDropzone.querySelector('.browse').addEventListener('click', (e) => {
          e.stopPropagation();
          icaFileInput.click();
        });

        icaDropzone.addEventListener('dragover', (e) => {
          e.preventDefault();
          icaDropzone.style.borderColor = '#6366f1';
        });

        icaDropzone.addEventListener('dragleave', () => {
          icaDropzone.style.borderColor = '#2e2e3e';
        });

        icaDropzone.addEventListener('drop', (e) => {
          e.preventDefault();
          icaDropzone.style.borderColor = '#2e2e3e';
          const file = e.dataTransfer.files[0];
          if (file) handleIcaFile(file);
        });

        icaFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) handleIcaFile(file);
        });

        icaCancelBtn.addEventListener('click', () => {
          icaSelectedFile = null;
          icaFileInput.value = '';
          icaFilePreview.style.display = 'none';
          icaDropzone.style.display = 'block';
          hideIcaStatus();
        });

        function handleIcaFile(file) {
          if (!file.name.endsWith('.csv')) {
            showIcaStatus('Please upload a CSV file', 'error');
            return;
          }
          icaSelectedFile = file;
          icaFilename.textContent = file.name;
          icaDropzone.style.display = 'none';
          icaFilePreview.style.display = 'flex';
          hideIcaStatus();
        }

        icaUploadBtn.addEventListener('click', async () => {
          if (!icaSelectedFile || !sessionId) return;

          const formData = new FormData();
          formData.append('file', icaSelectedFile);

          try {
            icaUploadBtn.disabled = true;
            icaUploadBtn.textContent = 'Uploading...';

            const response = await fetch(`/api/ica/upload/${sessionId}`, {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(errorText || `Upload failed with status ${response.status}`);
            }

            const result = await response.json();

            if (!result.success) {
              throw new Error(result.error || 'Upload failed');
            }

            showIcaStatus(`Successfully imported ${result.stats.successfulImports} contacts!`, 'success');

            icaSelectedFile = null;
            icaFileInput.value = '';
            icaFilePreview.style.display = 'none';
            icaDropzone.style.display = 'block';

            await loadIcaStats();
            await loadIcaContacts();

            icaStatsCard.style.display = 'block';
            icaContactsCard.style.display = 'block';

          } catch (error) {
            showIcaStatus(error.message || 'Upload failed', 'error');
          } finally {
            icaUploadBtn.disabled = false;
            icaUploadBtn.textContent = 'Upload & Analyze';
          }
        });

        async function loadIcaStats() {
          if (!sessionId) return;
          try {
            const response = await fetch(`/api/ica/stats/${sessionId}`);
            const result = await response.json();
            if (result.success && result.stats) {
              document.getElementById('ica-stat-total').textContent = result.stats.totalContacts || 0;
              document.getElementById('ica-stat-high').textContent = result.stats.highPotential || 0;
              document.getElementById('ica-stat-medium').textContent = result.stats.mediumPotential || 0;
              document.getElementById('ica-stat-low').textContent = result.stats.lowPotential || 0;
            }
          } catch (error) {
            console.error('Failed to load ICA stats:', error);
          }
        }

        async function loadIcaContacts() {
          if (!sessionId) {
            console.log('‚ùå loadIcaContacts: No sessionId');
            return;
          }
          try {
            const category = icaFilter.value;
            const search = icaSearch.value;
            let url = `/api/ica/contacts/${sessionId}?category=${category}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;

            console.log('üì° Fetching contacts from:', url);
            const response = await fetch(url);
            const result = await response.json();
            console.log('üì• Contacts API response:', result);

            if (result.success) {
              icaContacts = result.contacts;
              console.log(`‚úÖ Loaded ${icaContacts.length} contacts`);
              renderIcaContacts();
            } else {
              console.error('‚ùå API returned error:', result.error);
            }
          } catch (error) {
            console.error('‚ùå Failed to load contacts:', error);
          }
        }

        function renderIcaContacts() {
          const grid = document.getElementById('ica-contacts-grid');
          if (!grid) return;

          if (icaContacts.length === 0) {
            grid.innerHTML = `
              <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #64748b; background: #F8FAFC; border-radius: 16px; border: 2px dashed #E2E8F0;">
                <div style="font-size: 3rem; margin-bottom: 16px;">üìá</div>
                <h3 style="color: #1E293B;">No contacts found</h3>
                <p>Try a different filter or search term.</p>
              </div>
            `;
            return;
          }

          const categoryConfig = {
            high_potential: { label: 'High Potential', icon: 'üî•', class: 'p1' },
            medium_potential: { label: 'Medium Potential', icon: '‚ö°', class: 'p3' },
            low_potential: { label: 'Low Potential', icon: 'üí§', class: 'p5' },
            uncategorized: { label: 'Uncategorized', icon: '‚ùì', class: 'p3' }
          };

          grid.innerHTML = icaContacts.map(contact => {
            const config = categoryConfig[contact.ica_category] || categoryConfig.uncategorized;
            return `
              <div class="company-card" style="padding: 20px; background: white; border: 1px solid #E2E8F0; border-radius: 16px; border-left: 6px solid ${contact.ica_category === 'high_potential' ? '#22c55e' : contact.ica_category === 'medium_potential' ? '#f59e0b' : '#94a3b8'}; transition: transform 0.2s ease, box-shadow 0.2s ease;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                  <div style="font-size: 1.15rem; font-weight: 700; color: #1E293B; line-height: 1.3;">
                    ${contact.first_name} ${contact.last_name}
                  </div>
                  <div style="display: flex; gap: 8px;">
                    ${contact.linkedin_profile_url ? `
                      <a href="${contact.linkedin_profile_url}" target="_blank" title="LinkedIn Profile" style="color: #0a66c2; font-size: 1.5rem; text-decoration: none;">
                        <svg style="width: 24px; height: 24px;" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                      </a>
                    ` : ''}
                    <button class="btn-delete" onclick="deleteIcaContact('${contact.id}')" style="background: #FEE2E2; color: #DC2626; border: none; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
                
                <div style="color: #1E293B; font-weight: 500; font-size: 0.95rem; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                   ${contact.position || 'Unknown Role'}
                </div>
                <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 16px; min-height: 1.25rem;">
                  üè¢ ${contact.company || 'Unknown Company'}
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 16px; border-top: 1px solid #F1F5F9;">
                  <span class="priority-badge ${config.class}" style="margin: 0; padding: 4px 10px; font-size: 0.75rem;">
                    ${config.icon} ${config.label}
                  </span>
                   <select onchange="updateIcaCategory('${contact.id}', this.value)" style="padding: 4px 8px; border-radius: 8px; border: 1px solid #E2E8F0; font-size: 0.8rem; background: #F8FAFC; color: #64748b; cursor: pointer;">
                    <option value="high_potential" ${contact.ica_category === 'high_potential' ? 'selected' : ''}>High</option>
                    <option value="medium_potential" ${contact.ica_category === 'medium_potential' ? 'selected' : ''}>Medium</option>
                    <option value="low_potential" ${contact.ica_category === 'low_potential' ? 'selected' : ''}>Low</option>
                    <option value="uncategorized" ${contact.ica_category === 'uncategorized' ? 'selected' : ''}>Mixed</option>
                  </select>
                </div>
              </div>
            `;
          }).join('');

          // Keep table hidden sync
          if (icaContactsTbody) icaContactsTbody.innerHTML = '';
          icaContactsCard.style.display = 'block';
        }

        window.updateIcaCategory = async (contactId, category) => {
          if (!sessionId) return;
          try {
            await fetch(`/api/ica/contacts/${sessionId}/${contactId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ icaCategory: category })
            });
            await loadIcaStats();
            showIcaStatus('Category updated', 'success');
            setTimeout(hideIcaStatus, 2000);
          } catch (error) {
            console.error('Failed to update category:', error);
          }
        };

        window.updateIcaNotes = async (contactId, notes) => {
          if (!sessionId) return;
          try {
            await fetch(`/api/ica/contacts/${sessionId}/${contactId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ notes })
            });
          } catch (error) {
            console.error('Failed to update notes:', error);
          }
        };

        window.deleteIcaContact = async (contactId) => {
          if (!sessionId || !confirm('Delete this contact?')) return;
          try {
            await fetch(`/api/ica/contacts/${sessionId}/${contactId}`, { method: 'DELETE' });
            await loadIcaStats();
            await loadIcaContacts();
            showIcaStatus('Contact deleted', 'success');
            setTimeout(hideIcaStatus, 2000);
          } catch (error) {
            console.error('Failed to delete contact:', error);
          }
        };

        icaFilter.addEventListener('change', loadIcaContacts);
        icaSearch.addEventListener('input', () => {
          clearTimeout(icaSearch.debounceTimer);
          icaSearch.debounceTimer = setTimeout(loadIcaContacts, 300);
        });

        async function checkNetworkForCompany(companyName) {
          if (!sessionId) {
            showToast('Session required', 'error');
            return;
          }

          try {
            showToast(`Checking your network at ${companyName}...`, 'info');
            const response = await fetch(`/api/ica/referrals/${sessionId}?company=${encodeURIComponent(companyName)}`);
            const data = await response.json();

            if (data.success) {
              showReferralModal(data.contacts, companyName);
            } else {
              showToast('Failed to check network', 'error');
            }
          } catch (error) {
            console.error('Error checking network:', error);
            showToast('Failed to check network', 'error');
          }
        }

        function showReferralModal(contacts, companyName) {
          const modalHtml = `
            <div class="modal-overlay" id="referral-modal" style="display: flex;">
              <div class="modal" style="max-width: 600px; width: 95%;">
                <button class="modal-close" onclick="closeModalById('referral-modal')">&times;</button>
                <div class="modal-header">
                  <div style="font-size: 2.5rem; margin-bottom: 8px;">ü§ù</div>
                  <h2 style="color: #1E293B;">Connections at ${companyName}</h2>
                  <p style="color: #64748b;">${contacts.length} potential referral advocate${contacts.length === 1 ? '' : 's'} found</p>
                </div>
                <div style="max-height: 450px; overflow-y: auto; margin: 20px 0; display: flex; flex-direction: column; gap: 12px; padding: 4px;">
                  ${contacts.length === 0 ? `
                    <div style="text-align: center; padding: 50px 20px; color: #64748b; background: #F8FAFC; border-radius: 16px; border: 2px dashed #E2E8F0;">
                      <div style="font-size: 3rem; margin-bottom: 16px;">üîç</div>
                      <h3 style="color: #1E293B; margin-bottom: 8px;">No direct connections found</h3>
                      <p style="margin-bottom: 20px;">We couldn't find anyone in your imported LinkedIn network at ${companyName}.</p>
                      <button class="btn btn-secondary" onclick="switchToNetworkingAndSearch('${companyName}')">Search Network Manually</button>
                    </div>
                  ` : contacts.map(contact => `
                    <div class="company-card" style="padding: 16px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid ${contact.ica_category === 'high_potential' ? '#22c55e' : '#94a3b8'};">
                      <div style="flex: 1;">
                        <div style="font-weight: 700; color: #1E293B; font-size: 1.05rem;">${contact.first_name} ${contact.last_name}</div>
                        <div style="font-size: 0.85rem; color: #64748b; margin-top: 2px;">üíº ${contact.position}</div>
                      </div>
                      <div style="display: flex; gap: 8px;">
                        ${contact.linkedin_profile_url ? `
                          <a href="${contact.linkedin_profile_url}" target="_blank" class="btn btn-secondary btn-sm" style="background: #0a66c2; color: white; border: none; padding: 6px 12px;">
                            LinkedIn
                          </a>
                        ` : ''}
                        <button class="btn btn-primary btn-sm" onclick="showOutreachModal('${contact.id}', '${contact.first_name.replace(/'/g, "\\'")} ${contact.last_name.replace(/'/g, "\\'")}')">
                          Log Outreach
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
                <div class="modal-footer" style="padding-top: 20px; border-top: 1px solid #F1F5F9; display: flex; justify-content: flex-end; gap: 10px;">
                  <button class="btn btn-secondary" onclick="closeModalById('referral-modal')">Close</button>
                  <button class="btn btn-primary" onclick="switchToNetworkingAndSearch('${companyName}')">View Full Network</button>
                </div>
              </div>
            </div>
          `;

          const existingModal = document.getElementById('referral-modal');
          if (existingModal) existingModal.remove();

          document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function switchToNetworkingAndSearch(query) {
          closeModalById('referral-modal');
          // Switch to Networking tab
          switchTab('networking');

          // Fill search and trigger
          setTimeout(() => {
            const searchInput = document.getElementById('ica-search');
            if (searchInput) {
              searchInput.value = query;
              loadIcaContacts();
            }
          }, 100);
        }

        function showOutreachModal(contactId, contactName) {
          const modalHtml = `
            <div class="modal-overlay" id="outreach-modal" style="display: flex;">
              <div class="modal" style="max-width: 500px; width: 90%;">
                <button class="modal-close" onclick="closeModalById('outreach-modal')">&times;</button>
                <div class="modal-header">
                  <div style="font-size: 2.5rem; margin-bottom: 8px;">üìù</div>
                  <h2>Log Interaction</h2>
                  <p>Keep track of your outreach to <strong>${contactName}</strong></p>
                </div>
                <div style="margin: 20px 0; display: flex; flex-direction: column; gap: 16px;">
                  <div>
                    <label style="display: block; font-size: 0.9rem; font-weight: 600; color: #475569; margin-bottom: 6px;">Interaction Type</label>
                    <select id="outreach-type" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; background: white;">
                      <option value="message">LinkedIn Message</option>
                      <option value="email">Email</option>
                      <option value="call">Phone Call</option>
                      <option value="meeting">Coffee Chat / Meeting</option>
                      <option value="referral">Referral Request</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.9rem; font-weight: 600; color: #475569; margin-bottom: 6px;">Outcome</label>
                    <select id="outreach-outcome" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; background: white;">
                      <option value="neutral">Sent / Pending</option>
                      <option value="positive">Replied / Positive</option>
                      <option value="no_response">No Response</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.9rem; font-weight: 600; color: #475569; margin-bottom: 6px;">Notes</label>
                    <textarea id="outreach-notes" placeholder="What did you talk about?" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; background: white; resize: none;"></textarea>
                  </div>
                </div>
                <div class="modal-footer" style="padding-top: 20px; border-top: 1px solid #F1F5F9; display: flex; justify-content: flex-end; gap: 10px;">
                  <button class="btn btn-secondary" onclick="closeModalById('outreach-modal')">Cancel</button>
                  <button class="btn btn-primary" onclick="saveOutreach('${contactId}')">Save Interaction</button>
                </div>
              </div>
            </div>
          `;

          const existingModal = document.getElementById('outreach-modal');
          if (existingModal) existingModal.remove();

          document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function saveOutreach(contactId) {
          if (!sessionId) return;

          const type = document.getElementById('outreach-type').value;
          const outcome = document.getElementById('outreach-outcome').value;
          const notes = document.getElementById('outreach-notes').value;

          try {
            const btn = event.target || document.activeElement;
            const originalText = btn.textContent;
            if (btn && btn.tagName === 'BUTTON') {
              btn.disabled = true;
              btn.innerHTML = '<span class="spinner-sm"></span> Saving...';
            }

            const response = await fetch(`/api/ica/interactions/${sessionId}/${contactId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                interactionType: type,
                outcome: outcome,
                notes: notes,
                interactionDate: new Date().toISOString()
              })
            });

            const data = await response.json();
            if (data.success) {
              showToast('Interaction logged successfully!', 'success');
              closeModalById('outreach-modal');
              loadIcaContacts(); // Refresh
            } else {
              showToast(data.error || 'Failed to save', 'error');
            }
          } catch (error) {
            console.error('Error saving outreach:', error);
            showToast('Failed to save interaction', 'error');
          } finally {
            const btn = document.querySelector('#outreach-modal .btn-primary');
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'Save Interaction';
            }
          }
        }

        if (sessionId) {
          loadIcaStats().then(() => {
            loadIcaContacts().then(() => {
              // Always show cards after successful load
              icaStatsCard.style.display = 'block';
              icaContactsCard.style.display = 'block';

              // TODO: Implement these helper functions
              // loadHotLeads();
              // loadCompaniesHiring();
              // loadHelpfulContacts();
            });
          });
        }

        // ========== RESUME OPTIMIZER TAB ==========
        let optimizerFile = null;

        // Upload zone handlers
        const optimizerZone = document.getElementById('optimizer-upload-zone');
        const optimizerInput = document.getElementById('optimizer-resume-input');
        const optimizerJobDesc = document.getElementById('optimizer-job-description');
        const optimizerBtn = document.getElementById('optimize-resume-btn');

        optimizerZone.addEventListener('click', () => optimizerInput.click());
        optimizerZone.addEventListener('dragover', e => {
          e.preventDefault();
          optimizerZone.style.borderColor = '#6366f1';
        });
        optimizerZone.addEventListener('dragleave', () => {
          optimizerZone.style.borderColor = optimizerFile ? '#10b981' : '#2e2e3e';
        });
        optimizerZone.addEventListener('drop', e => {
          e.preventDefault();
          if (e.dataTransfer.files[0]) handleOptimizerFile(e.dataTransfer.files[0]);
        });
        optimizerInput.addEventListener('change', e => {
          if (e.target.files[0]) handleOptimizerFile(e.target.files[0]);
        });

        function handleOptimizerFile(file) {
          if (!file.name.match(/\.(pdf|doc|docx)$/i)) {
            showToast('Please upload PDF or Word document', 'error');
            return;
          }
          optimizerFile = file;
          document.getElementById('optimizer-file-name').textContent = '‚úì ' + file.name;
          document.getElementById('optimizer-file-name').style.display = 'block';
          optimizerZone.classList.add('has-file');
          checkOptimizerReady();
        }

        // Enable button when both inputs are ready
        function checkOptimizerReady() {
          // Check if we have EITHER a local file OR global resume
          const hasFile = optimizerFile || globalResumeState.file || globalResumeState.resumeText;
          const hasJobDesc = optimizerJobDesc.value.trim().length >= 50;
          optimizerBtn.disabled = !(hasFile && hasJobDesc);
        }

        optimizerJobDesc.addEventListener('input', checkOptimizerReady);

        // Optimize button click handler
        optimizerBtn.addEventListener('click', async () => {
          // Use global resume if no local file uploaded
          const jobDesc = optimizerJobDesc.value.trim();
          if (jobDesc.length < 50) {
            showToast('Job description too short (min 50 chars)', 'error');
            return;
          }

          // Show loading
          document.getElementById('optimize-btn-text').textContent = 'Optimizing...';
          document.getElementById('optimize-loading').style.display = 'inline-block';
          optimizerBtn.disabled = true;

          try {
            const formData = new FormData();
            if (optimizerFile) {
              formData.append('resume', optimizerFile);
            } else if (globalResumeState.file) {
              formData.append('resume', globalResumeState.file);
            }

            formData.append('jobDescription', jobDesc);
            if (sessionId) {
              formData.append('sessionId', sessionId);
            }

            const response = await fetch('/api/optimize-resume', {
              method: 'POST',
              body: formData
            });

            if (response.status === 402) {
              showPaywallModal();
              return;
            }

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Optimization failed');
            }

            // Display results
            displayOptimizationResults(data.data);
            showToast('Resume optimized successfully!', 'success');

          } catch (error) {
            console.error('Optimization error:', error);
            showToast(error.message || 'Optimization failed', 'error');
          } finally {
            document.getElementById('optimize-btn-text').textContent = 'üöÄ Optimize My Resume';
            document.getElementById('optimize-loading').style.display = 'none';
            checkOptimizerReady(); // Re-enable if inputs still valid
          }
        });

        function displayOptimizationResults(data) {
          const resultsDiv = document.getElementById('optimizer-results');
          resultsDiv.style.display = 'block';

          // Build audit score section
          const auditHtml = data.auditScore ? `
    <div class="card" style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.05), rgba(255, 149, 0, 0.02)); border-color: rgba(255, 149, 0, 0.2);">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="width: 48px; height: 48px; border-radius: 12px; background: #FF9500; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700;">
          ${data.auditScore.total}
        </div>
        <div>
          <h3 style="margin: 0; color: #1E293B;">Optimization Audit</h3>
          <p style="margin: 0; color: #64748B; font-size: 0.9rem;">Your technical score across key ATS metrics</p>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
        ${(data.auditScore.sections || []).map(section => {
            const isPerfect = section.passed === section.total;
            return `
          <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #E2E8F0; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-weight: 700; font-size: 0.95rem; color: #334155;">${section.name}</span>
              <span class="${isPerfect ? 'text-success' : 'text-warning'}" style="font-weight: 600; font-size: 0.85rem; padding: 2px 8px; border-radius: 6px; background: ${isPerfect ? '#F0FDF4' : '#FFFBEB'};">
                ${section.passed}/${section.total}
              </span>
            </div>
            ${section.issues && section.issues.length > 0 ? `
              <div style="display: flex; flex-direction: column; gap: 6px;">
                ${section.issues.map(issue => `
                  <div style="font-size: 0.8rem; color: #64748b; line-height: 1.4; display: flex; gap: 6px;">
                    <span style="color: #F59E0B;">‚Ä¢</span> ${issue}
                  </div>
                `).join('')}
              </div>
            ` : '<div style="font-size: 0.8rem; color: #10b981; font-weight: 500;">‚úì Optimization Complete</div>'}
          </div>
        `}).join('')}
      </div>
    </div>
  ` : '';

          // Build sections comparison
          const sectionsHtml = (data.sections || []).map(section => {
            if (section.bullets) {
              return `
        <div class="card" style="margin-top: 32px; border-top: 4px solid #6366F1;">
          <div style="margin-bottom: 24px;">
            <h3 style="color: #1E293B; margin: 0;">${section.title}</h3>
            <p style="color: #64748B; font-size: 0.9rem;">AI-enhanced bullet points for maximum impact</p>
          </div>
          <div style="display: flex; flex-direction: column; gap: 20px;">
            ${section.bullets.map(bullet => `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; padding: 20px; background: #F8FAFC; border-radius: 12px; border: 1px solid #E2E8F0;">
                <div>
                  <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Original</div>
                  <div style="color: #64748B; line-height: 1.6; text-decoration: line-through; opacity: 0.6; font-size: 0.95rem;">${bullet.before}</div>
                </div>
                <div style="border-left: 1px solid #E2E8F0; padding-left: 24px; position: relative;">
                  <div style="font-size: 0.75rem; font-weight: 700; color: #6366F1; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                    Optimized ‚ú®
                  </div>
                  <div style="color: #1E293B; line-height: 1.6; font-weight: 500; font-size: 0.95rem;">${bullet.after}</div>
                  ${bullet.changes ? `
                    <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px;">
                      ${bullet.changes.map(change => `<span style="font-size: 0.7rem; color: #6366F1; background: #EEF2FF; padding: 2px 8px; border-radius: 4px; font-weight: 600;">${change}</span>`).join('')}
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
            } else if (Array.isArray(section.before)) {
              return `
        <div class="card" style="margin-top: 32px; border-top: 4px solid #10B981;">
          <h3 style="color: #1E293B; margin-bottom: 20px;">${section.title}</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div style="background: #FFF5F5; padding: 20px; border-radius: 12px; border: 1px solid #FEE2E2;">
              <div style="font-size: 0.75rem; font-weight: 700; color: #F87171; text-transform: uppercase; margin-bottom: 12px;">Removed / Outdated</div>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${section.before.map(skill => `<span class="tag" style="background: #FEF2F2; color: #B91C1C; text-decoration: line-through;">${skill}</span>`).join('')}
              </div>
            </div>
            <div style="background: #F0FDF4; padding: 20px; border-radius: 12px; border: 1px solid #DCFCE7;">
              <div style="font-size: 0.75rem; font-weight: 700; color: #059669; text-transform: uppercase; margin-bottom: 12px;">Added / Optimized</div>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${section.after.map(skill => `<span class="tag" style="background: #DCFCE7; color: #065F46; font-weight: 600;">${skill}</span>`).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
            }
            return '';
          }).join('');


          // Download buttons
          const actionsHtml = `
    <div style="display: flex; gap: 12px; margin-top: 24px;">
      <button class="btn btn-primary" onclick="downloadOptimizedResume()">
        üì• Download PDF
      </button>
      <button class="btn btn-secondary" onclick="copyOptimizedResume()">
        üìã Copy Text
      </button>
    </div>
  `;

          resultsDiv.innerHTML = auditHtml + summaryHtml + sectionsHtml + actionsHtml;
          resultsDiv.style.display = 'block';
          resultsDiv.scrollIntoView({ behavior: 'smooth' });

          // Store for download/copy
          window.lastOptimizationData = data;
        }

        function downloadOptimizedResume() {
          if (!window.lastOptimizationData) {
            showToast('No optimization data available', 'error');
            return;
          }

          // Build complete optimized resume text
          let resumeText = '';
          const data = window.lastOptimizationData;

          (data.sections || []).forEach(section => {
            resumeText += `${section.title}\n${'='.repeat(section.title.length)}\n\n`;

            if (section.bullets) {
              // Experience section with bullets
              section.bullets.forEach(bullet => {
                resumeText += `‚Ä¢ ${bullet.after}\n\n`;
              });
            } else if (Array.isArray(section.after)) {
              // Skills section
              resumeText += section.after.join(', ') + '\n\n';
            } else {
              // Summary or other text sections
              resumeText += section.after + '\n\n';
            }
          });

          // Create downloadable text file
          const blob = new Blob([resumeText.trim()], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'optimized-resume.txt';
          a.click();
          URL.revokeObjectURL(url);

          showToast('Resume downloaded! Paste into Google Docs and save as PDF', 'success');
        }

        function copyOptimizedResume() {
          if (!window.lastOptimizationData) {
            showToast('No optimization data available', 'error');
            return;
          }

          let resumeText = '';
          const data = window.lastOptimizationData;

          (data.sections || []).forEach(section => {
            resumeText += `${section.title}\n${'='.repeat(section.title.length)}\n\n`;

            if (section.bullets) {
              section.bullets.forEach(bullet => {
                resumeText += `‚Ä¢ ${bullet.after}\n\n`;
              });
            } else if (Array.isArray(section.after)) {
              resumeText += section.after.join(', ') + '\n\n';
            } else {
              resumeText += section.after + '\n\n';
            }
          });

          navigator.clipboard.writeText(resumeText.trim()).then(() => {
            showToast('Optimized resume copied to clipboard!', 'success');
          }).catch(() => {
            showToast('Failed to copy', 'error');
          });
        }

        // ========================================
        // TARGET COMPANIES FUNCTIONALITY (v2 Unified)
        // ========================================
        let targetCompaniesData = [];

        async function loadTargetCompanies() {
          const sessionId = window.sessionId || localStorage.getItem('sessionId') || (window.globalResumeState && window.globalResumeState.sessionId);
          const container = document.getElementById('companies-container');
          const discoveryContainer = document.getElementById('discovery-container');

          if (!sessionId) {
            container.innerHTML = `
              <div id="empty-companies-state" style="text-align: center; padding: 60px 20px; color: #64748b; background: #F8FAFC; border-radius: 16px; border: 2px dashed #E2E8F0;">
                <div style="font-size: 4rem; margin-bottom: 20px;">üè¢</div>
                <h2 style="color: #1E293B; margin-bottom: 12px;">Start your target list</h2>
                <p style="font-size: 1.1rem; max-width: 500px; margin: 0 auto 24px auto;">Search for companies above or explore popular choices below to get started.</p>
              </div>
            `;
            loadDiscoverySuggestions();
            return;
          }

          try {
            const response = await fetch(`/api/target-companies?sessionId=${sessionId}`);
            if (!response.ok) {
              if (response.status === 401 || response.status === 403) {
                renderTargetCompanies([]);
                return;
              }
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (data.success) {
              targetCompaniesData = data.data.companies || [];
              renderTargetCompanies(targetCompaniesData);
              updateTargetCompaniesStats(data.data.stats);

              if (targetCompaniesData.length === 0) {
                loadDiscoverySuggestions();
              } else {
                discoveryContainer.style.display = 'none';
              }
            }
          } catch (error) {
            console.error('Error loading target companies:', error);
            if (sessionId) showToast('Could not load your companies.', 'info');
          }
        }

        async function loadDiscoverySuggestions() {
          const discoveryContainer = document.getElementById('discovery-container');
          const grid = document.getElementById('discovery-grid');
          const title = document.getElementById('discovery-title');

          discoveryContainer.style.display = 'block';
          title.textContent = 'üî• Discover Popular Companies';
          grid.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';

          try {
            const response = await fetch('/api/target-companies/suggestions');
            const data = await response.json();

            if (data.success && data.data.suggestions) {
              renderDiscoveryGrid(data.data.suggestions);
            } else {
              grid.innerHTML = '<p class="text-muted">No suggestions available. Try searching above!</p>';
            }
          } catch (error) {
            console.error('Discovery error:', error);
            grid.innerHTML = '<p class="text-error">Failed to load suggestions. <a href="#" onclick="runMigration()">Run Sync</a></p>';
          }
        }

        let companySearchTimeout;
        async function handleCompanySearch(query) {
          clearTimeout(companySearchTimeout);
          const discoveryContainer = document.getElementById('discovery-container');
          const title = document.getElementById('discovery-title');
          const grid = document.getElementById('discovery-grid');

          if (!query || query.length < 2) {
            if (targetCompaniesData.length === 0 || !query) {
              loadDiscoverySuggestions();
            } else {
              discoveryContainer.style.display = 'none';
            }
            return;
          }

          companySearchTimeout = setTimeout(async () => {
            discoveryContainer.style.display = 'block';
            title.textContent = `üîç Search results for "${query}"`;
            grid.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';

            try {
              const response = await fetch(`/api/target-companies/search-suggestions?query=${encodeURIComponent(query)}`);
              const data = await response.json();

              if (data.success && data.data.suggestions && data.data.suggestions.length > 0) {
                renderDiscoveryGrid(data.data.suggestions, true);
              } else {
                grid.innerHTML = `
                  <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                    <p class="text-muted mb-4">No matches found for "${query}"</p>
                    <button class="btn btn-primary" onclick="addCustomFromSearch('${query.replace(/'/g, "\\'")}')">
                      Add "${query}" as Custom Company
                    </button>
                  </div>
                `;
              }
            } catch (error) {
              console.error('Search error:', error);
            }
          }, 400);
        }

        function renderDiscoveryGrid(companies, isSearch = false) {
          const grid = document.getElementById('discovery-grid');
          grid.innerHTML = companies.map(company => `
            <div class="discovery-card">
              <div class="industry">${company.industry || 'Company'}</div>
              <h4>${company.company_name}</h4>
              <p class="description">${company.description || 'Add this company to track openings.'}</p>
              <button class="btn-add" onclick="addCompanyFromDiscovery('${company.company_name.replace(/'/g, "\\'")}')">
                Add to Targets
              </button>
            </div>
          `).join('');
        }

        async function addCompanyFromDiscovery(companyName) {
          const sessionId = window.sessionId || localStorage.getItem('sessionId') || (window.globalResumeState && window.globalResumeState.sessionId);
          if (!sessionId) {
            showToast('Please upload a resume first', 'error');
            return;
          }

          try {
            const response = await fetch('/api/target-companies/bulk', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId, companyNames: [companyName] })
            });

            const data = await response.json();
            if (data.success) {
              showToast(`${companyName} added!`, 'success');
              document.getElementById('company-search-input').value = '';
              loadTargetCompanies();
            } else {
              showToast(data.error || 'Already in your list', 'info');
            }
          } catch (error) {
            showToast('Failed to add company', 'error');
          }
        }

        function addCustomFromSearch(name) {
          showAddCompanyModal();
          setTimeout(() => {
            const input = document.getElementById('custom-company-name');
            if (input) input.value = name;
          }, 100);
        }

        function showAddCompanyModal() {
          const modalHtml = `
            <div class="modal-overlay" id="add-company-modal" style="display: flex;">
              <div class="modal">
                <button class="modal-close" onclick="closeModalById('add-company-modal')">&times;</button>
                <div class="modal-header">
                  <h2>‚ûï Add Custom Company</h2>
                  <p>Enter details for a new target company</p>
                </div>
                <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px;">
                  <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">Company Name *</label>
                    <input type="text" id="custom-company-name" class="input" placeholder="e.g. Acme Corp">
                  </div>
                  <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">Industry</label>
                    <input type="text" id="custom-company-industry" class="input" placeholder="e.g. Technology">
                  </div>
                  <div class="form-group">
                    <label style="display: block; margin-bottom: 4px; font-weight: 600;">Priority (1-5, 1=High)</label>
                    <select id="custom-company-priority" class="input">
                      <option value="1">1 - High Priority</option>
                      <option value="2">2 - Medium-High</option>
                      <option value="3" selected>3 - Medium</option>
                      <option value="4">4 - Medium-Low</option>
                      <option value="5">5 - Low Priority</option>
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" onclick="closeModalById('add-company-modal')">Cancel</button>
                  <button class="btn btn-primary" onclick="submitCustomCompany()">Add Company</button>
                </div>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function submitCustomCompany() {
          const name = document.getElementById('custom-company-name').value;
          const industry = document.getElementById('custom-company-industry').value;
          const priority = document.getElementById('custom-company-priority').value;

          if (!name) return showToast('Name is required', 'error');
          const sessionId = window.sessionId || localStorage.getItem('sessionId') || (window.globalResumeState && window.globalResumeState.sessionId);
          if (!sessionId) return showToast('Please upload a resume first', 'error');

          try {
            const response = await fetch('/api/target-companies', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId, companyName: name, industry, priority: parseInt(priority) })
            });

            const data = await response.json();
            if (data.success) {
              showToast(`${name} added!`, 'success');
              closeModalById('add-company-modal');
              loadTargetCompanies();
            } else {
              showToast(data.error || 'Failed to add', 'error');
            }
          } catch (e) {
            showToast('Failed to add company', 'error');
          }
        }

        function renderTargetCompanies(companies) {
          const container = document.getElementById('companies-container');
          const statsDiv = document.getElementById('target-companies-stats');

          if (!companies || companies.length === 0) {
            container.innerHTML = `
              <div id="empty-companies-state" style="text-align: center; padding: 60px 20px; color: #64748b; background: #F8FAFC; border-radius: 16px; border: 2px dashed #E2E8F0;">
                <div style="font-size: 4rem; margin-bottom: 20px;">üè¢</div>
                <h2 style="color: #1E293B; margin-bottom: 12px;">Start your target list</h2>
                <p style="font-size: 1.1rem; max-width: 500px; margin: 0 auto 24px auto;">Search for companies above or explore popular choices below to get started.</p>
              </div>
            `;
            statsDiv.style.display = 'none';
            return;
          }

          const priorityLabels = { 1: 'High', 2: 'Med-High', 3: 'Medium', 4: 'Med-Low', 5: 'Low' };

          container.innerHTML = companies.map(company => `
            <div class="company-card priority-${company.priority || 3} ${!company.is_active ? 'inactive' : ''}">
              <div class="company-header">
                <div class="company-info">
                  <div class="company-name" style="font-size: 1.2rem; font-weight: 700;">
                    ${company.company_name}
                    <span class="priority-badge p${company.priority || 3}">
                      ${priorityLabels[company.priority || 3]}
                    </span>
                  </div>
                  <div class="company-meta">
                    ${company.industry ? `<span class="company-meta-item">üè≠ ${company.industry}</span>` : ''}
                    ${company.total_jobs_found > 0 ? `<span class="company-meta-item">üìã ${company.total_jobs_found} jobs</span>` : ''}
                    ${company.new_jobs_count > 0 ? `<span class="badge-new">${company.new_jobs_count} new</span>` : ''}
                  </div>
                </div>
                <div class="company-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <button class="btn btn-primary btn-sm" onclick="searchCompanyJobs('${company.company_id}', '${company.company_name.replace(/'/g, "\\'")}')">
                    üîç Jobs
                  </button>
                  <button class="btn btn-secondary btn-sm" onclick="checkNetworkForCompany('${company.company_name.replace(/'/g, "\\'")}')" style="background: #F0FDF4; color: #166534; border-color: #BBF7D0;">
                    üë• Network
                  </button>
                  <button class="btn btn-secondary btn-sm" onclick="deleteCompany('${company.company_id}', '${company.company_name.replace(/'/g, "\\'")}')">
                    üóëÔ∏è
                  </button>
                </div>
              </div>
            </div>
          `).join('');
        }

        function updateTargetCompaniesStats(stats) {
          if (!stats) return;
          const statsDiv = document.getElementById('target-companies-stats');
          if (stats.total > 0) {
            statsDiv.style.display = 'grid';
            document.getElementById('stat-total-companies').textContent = stats.total || 0;
            document.getElementById('stat-new-jobs').textContent = stats.newJobsCount || 0;
            document.getElementById('stat-high-priority').textContent = stats.highPriorityCount || 0;
            document.getElementById('stat-total-jobs').textContent = stats.totalJobsFound || 0;
          } else {
            statsDiv.style.display = 'none';
          }
        }

        async function runMigration() {
          const btn = event.currentTarget || document.activeElement;
          const originalText = btn ? btn.innerHTML : 'üõ† Setup Database';

          if (btn && btn.tagName === 'BUTTON') {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-sm"></span> Syncing...';
          }

          try {
            showToast('Syncing database...', 'info');
            const response = await fetch('/api/migrate-target-companies', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
              showToast('Database synced successfully!', 'success');
              loadTargetCompanies();
            } else {
              showToast(data.error || 'Sync failed', 'error');
            }
          } catch (error) {
            showToast('Connection failed', 'error');
          } finally {
            if (btn && btn.tagName === 'BUTTON') {
              btn.disabled = false;
              btn.innerHTML = originalText;
            }
          }
        }

        async function searchCompanyJobs(companyId, companyName) {
          const sessionId = window.sessionId;
          if (!sessionId) {
            showToast('Session required', 'error');
            return;
          }

          try {
            const response = await fetch(`/api/target-companies/${companyId}/search`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId })
            });

            const data = await response.json();

            if (data.success && data.data.searchUrls) {
              showJobSearchModal(data.data.searchUrls, companyName);
            } else {
              showToast('Search failed', 'error');
            }
          } catch (error) {
            console.error('Error searching jobs:', error);
            showToast('Search failed', 'error');
          }
        }

        function showJobSearchModal(searchUrls, companyName) {
          const modalHtml = `
    <div class="modal-overlay" id="search-results-modal" style="display: flex;">
      <div class="modal">
        <button class="modal-close" onclick="closeModalById('search-results-modal')">&times;</button>
        <div class="modal-header">
          <h2>üîç Search Jobs at ${companyName}</h2>
          <p>Click below to search on each platform</p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          ${searchUrls.map(search => `
            <a href="${search.url}" target="_blank" class="btn btn-primary" style="text-decoration: none;">
              üîó Search on ${search.platform}
            </a>
          `).join('')}
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModalById('search-results-modal')">Close</button>
        </div>
      </div>
    </div>
  `;

          const existingModal = document.getElementById('search-results-modal');
          if (existingModal) existingModal.remove();

          document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function deleteCompany(companyId, companyName) {
          if (!confirm(`Remove ${companyName} from your target companies?`)) {
            return;
          }

          const sessionId = window.sessionId;

          try {
            const response = await fetch(`/api/target-companies/${companyId}?sessionId=${sessionId}`, {
              method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
              showToast(data.message, 'success');
              loadTargetCompanies();
            } else {
              showToast(data.error || 'Failed to delete', 'error');
            }
          } catch (error) {
            console.error('Error deleting company:', error);
            showToast('Failed to delete company', 'error');
          }
        }

        function toggleCompanySelection(companyId) {
          // No longer used in simplified UI
        }


        function closeModalById(modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.remove();
          }
        }

        function showPaywallModal() {
          // Remove existing if any
          const existing = document.getElementById('paywall-modal');
          if (existing) existing.remove();

          const modal = document.createElement('div');
          modal.id = 'paywall-modal';
          modal.className = 'cl-modal open';
          modal.innerHTML = `
        <div class="paywall-modal-content">
          <div class="paywall-icon">üîì</div>
          <h2 class="paywall-title">Premium Feature</h2>
          <p class="paywall-desc">Deep Analysis and AI Generators are part of our premium toolkit. These features are currently in private beta for our early supporters.</p>
          <div class="flex justify-center gap-4">
            <button class="paywall-close-btn" onclick="document.getElementById('paywall-modal').remove()">Maybe Later</button>
            <button class="btn btn-primary" onclick="window.open('/upgrade.html', '_blank')">Notify Me of Launch</button>
          </div>
          <p style="margin-top: 24px; font-size: 0.8rem; color: #64748b;">Are you a friend testing? Use your secret key in the request headers.</p>
        </div>
      `;
          document.body.appendChild(modal);
        }

        function showUserGuide() {
          const guideModal = document.getElementById('guide-modal');
          if (guideModal) {
            guideModal.classList.add('show');
          }
        }

        // ========== MOCK INTERVIEW FUNCTIONS ==========
        let mockCurrentSession = null;
        let mockCurrentQuestions = [];
        let mockCurrentQuestionIndex = 0;
        let mockMediaRecorder = null;
        let mockRecordedChunks = [];
        let mockStream = null;
        let mockTimerInterval = null;
        let mockRecordingStartTime = null;

        function initializeMockInterview() {
          // Reset any existing state
          mockCurrentSession = null;
          mockCurrentQuestions = [];
          mockCurrentQuestionIndex = 0;

          // Show setup form
          document.getElementById('mock-interview-setup').style.display = 'block';
          document.getElementById('mock-interview-session').style.display = 'none';
          document.getElementById('mock-interview-results').style.display = 'none';
        }

        async function startMockInterview() {
          const jobRole = document.getElementById('mock-job-role').value;
          const interviewType = document.getElementById('mock-interview-type').value;
          const duration = parseInt(document.getElementById('mock-duration').value);
          const jobDescription = document.getElementById('mock-job-description').value.trim();

          if (!jobRole) {
            showToast('Please enter a job role', 'error');
            return;
          }

          try {
            showToast('Generating interview questions...', 'info');

            // Generate questions with optional job description
            const questionPayload = {
              jobRole,
              interviewType,
              experienceLevel: 'mid',
              duration
            };

            // Only include jobDescription if it's not empty
            if (jobDescription) {
              questionPayload.jobDescription = jobDescription;
            }

            const questionsResponse = await fetch('/api/mock-interview/generate-interview-questions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(questionPayload)
            });

            if (!questionsResponse.ok) throw new Error('Failed to generate questions');
            const questionsData = await questionsResponse.json();
            mockCurrentQuestions = questionsData.data;

            // Create session
            const sessionId = globalResumeState.sessionId ||
              localStorage.getItem('sessionId') ||
              localStorage.getItem('currentSessionId') ||
              localStorage.getItem('jobmatch_session');

            const sessionBody = { jobRole, interviewType, duration };
            const headers = { 'Content-Type': 'application/json' };

            if (sessionId) {
              sessionBody.sessionId = sessionId;
            }

            // Also include user ID if available
            if (currentUser && currentUser.id) {
              headers['x-user-id'] = currentUser.id;
            }

            console.log('Mock Interview: Creating session with', { sessionId, userId: currentUser?.id });

            const sessionResponse = await fetch('/api/mock-interview/interview-session', {
              method: 'POST',
              headers,
              body: JSON.stringify(sessionBody)
            });

            if (!sessionResponse.ok) throw new Error('Failed to create session');
            const sessionData = await sessionResponse.json();
            mockCurrentSession = sessionData.data;

            // Initialize camera
            const cameraReady = await initializeMockCamera();
            if (!cameraReady) return;

            // Show session screen
            document.getElementById('mock-interview-setup').style.display = 'none';
            document.getElementById('mock-interview-session').style.display = 'block';

            // Load first question
            loadMockQuestion(0);
            showToast('Mock interview started!', 'success');

          } catch (error) {
            console.error('Error starting interview:', error);
            showToast('Failed to start interview. Please try again.', 'error');
          }
        }

        async function initializeMockCamera() {
          try {
            mockStream = await navigator.mediaDevices.getUserMedia({
              video: { width: 1280, height: 720 },
              audio: true
            });
            const videoElement = document.getElementById('mock-preview-video');
            if (videoElement) {
              videoElement.srcObject = mockStream;
            }
            return true;
          } catch (error) {
            console.error('Camera initialization failed:', error);
            showToast('Unable to access camera/microphone. Please grant permissions.', 'error');
            return false;
          }
        }

        function loadMockQuestion(index) {
          if (index >= mockCurrentQuestions.length) {
            finishMockInterview();
            return;
          }

          mockCurrentQuestionIndex = index;
          const question = mockCurrentQuestions[index];

          document.getElementById('mock-question-number').textContent = `Question ${index + 1} of ${mockCurrentQuestions.length}`;
          document.getElementById('mock-question-text').textContent = question.text;
          document.getElementById('mock-timer').textContent = '00:00';

          // Reset buttons
          document.getElementById('mock-start-recording-btn').style.display = 'inline-flex';
          document.getElementById('mock-stop-recording-btn').style.display = 'none';
          document.getElementById('mock-next-question-btn').style.display = 'none';
        }

        function startMockRecording() {
          mockRecordedChunks = [];
          mockRecordingStartTime = Date.now();

          mockMediaRecorder = new MediaRecorder(mockStream, {
            mimeType: 'video/webm;codecs=vp9'
          });

          mockMediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              mockRecordedChunks.push(event.data);
            }
          };

          mockMediaRecorder.onstop = () => {
            uploadMockRecording();
          };

          mockMediaRecorder.start();

          // Update UI
          document.getElementById('mock-start-recording-btn').style.display = 'none';
          document.getElementById('mock-stop-recording-btn').style.display = 'inline-flex';

          // Start timer
          mockTimerInterval = setInterval(updateMockTimer, 1000);
        }

        function updateMockTimer() {
          const elapsed = Math.floor((Date.now() - mockRecordingStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById('mock-timer').textContent =
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function stopMockRecording() {
          if (mockMediaRecorder && mockMediaRecorder.state === 'recording') {
            mockMediaRecorder.stop();
          }

          if (mockTimerInterval) {
            clearInterval(mockTimerInterval);
            mockTimerInterval = null;
          }

          // Update UI
          document.getElementById('mock-stop-recording-btn').style.display = 'none';
          document.getElementById('mock-next-question-btn').style.display = 'inline-flex';
        }

        async function uploadMockRecording() {
          try {
            // For MVP, we'll just simulate upload and store placeholder URL
            const videoUrl = `/uploads/mock-interview/${mockCurrentSession.sessionToken}_q${mockCurrentQuestionIndex}.webm`;

            const response = await fetch('/api/mock-interview/upload-interview-response', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                sessionToken: mockCurrentSession.sessionToken,
                questionId: mockCurrentQuestions[mockCurrentQuestionIndex].id,
                videoUrl
              })
            });

            if (!response.ok) throw new Error('Upload failed');
            console.log('Recording uploaded successfully');
          } catch (error) {
            console.error('Error uploading recording:', error);
            showToast('Failed to upload recording. Please try again.', 'error');
          }
        }

        function nextMockQuestion() {
          loadMockQuestion(mockCurrentQuestionIndex + 1);
        }

        async function finishMockInterview() {
          // Stop camera
          if (mockStream) {
            mockStream.getTracks().forEach(track => track.stop());
          }

          // Show results screen
          document.getElementById('mock-interview-session').style.display = 'none';
          document.getElementById('mock-interview-results').style.display = 'block';

          try {
            showToast('Analyzing your interview performance...', 'info');

            // Fetch results
            const response = await fetch(`/api/mock-interview/interview-results/${mockCurrentSession.sessionToken}`);
            if (!response.ok) throw new Error('Failed to fetch results');

            const data = await response.json();
            const feedback = data.data;

            // Display scores - map from backend rubrics structure
            document.getElementById('mock-overall-score').textContent = feedback.overallScore || '--';
            document.getElementById('mock-communication-score').textContent = feedback.rubrics?.communication?.score || '--';
            document.getElementById('mock-technical-score').textContent = feedback.rubrics?.technicalKnowledge?.score || '--';
            document.getElementById('mock-confidence-score').textContent = feedback.rubrics?.confidence?.score || '--';

            // Display strengths
            const strengthsList = document.getElementById('mock-strengths-list');
            strengthsList.innerHTML = '';
            (feedback.strengths || []).forEach(strength => {
              const li = document.createElement('li');
              li.style.cssText = 'padding: 12px 16px; background: #F0FDF4; border-radius: 10px; border: 1px solid #DCFCE7; color: #166534; font-size: 0.95rem; font-weight: 500; display: flex; gap: 8px;';
              li.innerHTML = `<span>‚úì</span> <span>${strength}</span>`;
              strengthsList.appendChild(li);
            });

            // Display improvements (map from growthAreas)
            const improvementsList = document.getElementById('mock-improvements-list');
            improvementsList.innerHTML = '';
            (feedback.growthAreas || []).forEach(improvement => {
              const li = document.createElement('li');
              li.style.cssText = 'padding: 12px 16px; background: #FFFBEB; border-radius: 10px; border: 1px solid #FEF3C7; color: #92400e; font-size: 0.95rem; font-weight: 500; display: flex; gap: 8px;';
              li.innerHTML = `<span>‚Ä¢</span> <span>${improvement}</span>`;
              improvementsList.appendChild(li);
            });

            showToast('Interview analysis complete!', 'success');
          } catch (error) {
            console.error('Error fetching results:', error);
            showToast('Failed to load results. Please try again.', 'error');
          }
        }

        function resetMockInterview() {
          // Reset all state
          mockCurrentSession = null;
          mockCurrentQuestions = [];
          mockCurrentQuestionIndex = 0;

          if (mockStream) {
            mockStream.getTracks().forEach(track => track.stop());
            mockStream = null;
          }

          if (mockTimerInterval) {
            clearInterval(mockTimerInterval);
            mockTimerInterval = null;
          }

          // Reset form
          document.getElementById('mock-job-role').value = '';
          document.getElementById('mock-interview-type').value = 'technical';
          document.getElementById('mock-duration').value = '15';

          // Show setup screen
          initializeMockInterview();
        }

        // ========== INTERVIEW DASHBOARD FUNCTIONS ==========

        async function loadInterviewDashboard() {
          try {
            // Show loading state
            document.getElementById('dashboard-loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('dashboard-empty-state').style.display = 'none';
            document.getElementById('dashboard-error-message').style.display = 'none';

            // Get session ID from multiple sources
            const sessionId = globalResumeState.sessionId ||
              localStorage.getItem('sessionId') ||
              localStorage.getItem('currentSessionId') ||
              localStorage.getItem('jobmatch_session');

            const headers = {};
            if (sessionId) {
              headers['x-session-id'] = sessionId;
            }

            // Also try to get user info if available
            if (currentUser && currentUser.id) {
              headers['x-user-id'] = currentUser.id;
            }

            console.log('Dashboard: Attempting to load with sessionId:', sessionId, 'user:', currentUser);

            const response = await fetch('/api/mock-interview/interview-dashboard', { headers });
            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to load dashboard');
            }

            const { interviews, summary, message } = data.data;

            // Hide loading
            document.getElementById('dashboard-loading').style.display = 'none';

            // Show login message if not authenticated
            if (message) {
              showDashboardError(message);
              showDashboardEmptyState();
              return;
            }

            // Show empty state if no interviews
            if (!interviews || interviews.length === 0) {
              showDashboardEmptyState();
              return;
            }

            // Display dashboard content
            displayDashboardSummaryStats(summary);
            displayDashboardInterviews(interviews);
            document.getElementById('dashboard-content').style.display = 'block';

          } catch (error) {
            console.error('Error loading dashboard:', error);
            document.getElementById('dashboard-loading').style.display = 'none';
            showDashboardError('Failed to load interview dashboard. Please try again.');
          }
        }

        function displayDashboardSummaryStats(summary) {
          document.getElementById('total-interviews').textContent = summary.totalInterviews || 0;
          document.getElementById('completed-interviews').textContent = summary.completedInterviews || 0;
          document.getElementById('average-score').textContent = summary.averageScore ? `${summary.averageScore}%` : '--';

          // Calculate days since last interview
          if (summary.lastInterviewDate) {
            const lastDate = new Date(summary.lastInterviewDate);
            const today = new Date();
            const diffTime = Math.abs(today - lastDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            document.getElementById('last-interview').textContent = diffDays === 0 ? 'Today' : `${diffDays}d`;
          } else {
            document.getElementById('last-interview').textContent = '--';
          }
        }

        function displayDashboardInterviews(interviews) {
          const container = document.getElementById('interviews-list');
          container.innerHTML = '';

          interviews.forEach(interview => {
            const card = createDashboardInterviewCard(interview);
            container.appendChild(card);
          });
        }

        function createDashboardInterviewCard(interview) {
          const card = document.createElement('div');
          card.className = 'card';
          card.style.cssText = 'margin-bottom: 20px; transition: all 0.2s ease;';

          const statusClass = getDashboardStatusClass(interview.status);
          const formattedDate = formatDashboardDate(interview.createdAt);
          const duration = interview.completedAt ?
            formatDashboardDuration(new Date(interview.completedAt) - new Date(interview.createdAt)) :
            `${interview.duration} min planned`;

          card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <div style="font-size: 1.1rem; font-weight: 700; color: #1E293B; margin-bottom: 4px;">${interview.jobRole}</div>
            <div style="color: #64748B; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 8px;">
               <span style="background: #F1F5F9; padding: 2px 8px; border-radius: 4px;">${capitalizeFirst(interview.interviewType)}</span>
               <span>‚Ä¢</span>
               <span>${formattedDate}</span>
            </div>
          </div>
          <span style="padding: 6px 14px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; ${statusClass}">${interview.status}</span>
        </div>
        
        ${interview.results ? `
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0;">
            <div style="text-align: center; padding: 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px;">
              <div style="font-size: 1.4rem; font-weight: 800; color: #6366F1;">${interview.results.overallScore}</div>
              <div style="font-size: 0.65rem; font-weight: 700; color: #94A3B8; text-transform: uppercase; margin-top: 4px;">Overall</div>
            </div>
            <div style="text-align: center; padding: 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px;">
              <div style="font-size: 1.4rem; font-weight: 800; color: #10B981;">${interview.results.categoryScores.communication}</div>
              <div style="font-size: 0.65rem; font-weight: 700; color: #94A3B8; text-transform: uppercase; margin-top: 4px;">Comm.</div>
            </div>
            <div style="text-align: center; padding: 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px;">
              <div style="font-size: 1.4rem; font-weight: 800; color: #F59E0B;">${interview.results.categoryScores.technical}</div>
              <div style="font-size: 0.65rem; font-weight: 700; color: #94A3B8; text-transform: uppercase; margin-top: 4px;">Tech.</div>
            </div>
            <div style="text-align: center; padding: 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px;">
              <div style="font-size: 1.4rem; font-weight: 800; color: #8B5CF6;">${interview.results.categoryScores.confidence}</div>
              <div style="font-size: 0.65rem; font-weight: 700; color: #94A3B8; text-transform: uppercase; margin-top: 4px;">Conf.</div>
            </div>
          </div>
        ` : interview.status === 'completed' ? `
          <div style="text-align: center; padding: 24px; color: #64748B; font-weight: 500; background: #F8FAFC; border-radius: 12px; margin: 16px 0;">
             ‚åõ Analysis is pending... check back in a moment.
          </div>
        ` : ''}
        
        <div style="display: flex; gap: 8px; margin-top: 20px;">
          ${interview.results ? `
            <button class="btn btn-primary btn-sm" onclick="viewDashboardResults('${interview.sessionToken}')" style="background: #1E293B; color: white;">
               View Report
            </button>
          ` : ''}
          ${interview.status !== 'completed' ? `
            <button class="btn btn-primary btn-sm" onclick="continueDashboardInterview('${interview.sessionToken}')">
               Resume Session
            </button>
          ` : ''}
          <button class="btn btn-secondary btn-sm" onclick="deleteDashboardInterview('${interview.id}')" style="color: #EF4444; background: #FEF2F2; border: 1px solid #FEE2E2;">
            Delete
          </button>
        </div>
      `;

          return card;
        }

        function getDashboardStatusClass(status) {
          switch (status) {
            case 'completed': return 'background: #DCFCE7; color: #166534; border: 1px solid #BBF7D0;';
            case 'in_progress': return 'background: #FFFBEB; color: #92400E; border: 1px solid #FEF3C7;';
            case 'setup': return 'background: #EFF6FF; color: #1E40AF; border: 1px solid #DBEAFE;';
            default: return 'background: #F1F5F9; color: #475569; border: 1px solid #E2E8F0;';
          }
        }

        function formatDashboardDate(dateString) {
          const date = new Date(dateString);
          const now = new Date();
          const diffTime = Math.abs(now - date);
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

          if (diffDays === 0) return 'Today';
          if (diffDays === 1) return 'Yesterday';
          if (diffDays < 7) return `${diffDays} days ago`;

          return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
          });
        }

        function formatDashboardDuration(milliseconds) {
          const minutes = Math.floor(milliseconds / (1000 * 60));
          if (minutes < 60) return `${minutes} min`;

          const hours = Math.floor(minutes / 60);
          const remainingMinutes = minutes % 60;
          return `${hours}h ${remainingMinutes}m`;
        }

        function capitalizeFirst(str) {
          return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function showDashboardError(message) {
          const errorDiv = document.getElementById('dashboard-error-message');
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
        }

        function showDashboardEmptyState() {
          document.getElementById('dashboard-empty-state').style.display = 'block';
        }

        // Action handlers
        function viewDashboardResults(sessionToken) {
          // Switch to mock interview tab and show results
          showTab('mock-interview');
          // TODO: Load specific results
          showToast('Loading interview results...', 'info');
        }

        function continueDashboardInterview(sessionToken) {
          // Switch to mock interview tab and continue
          showTab('mock-interview');
          showToast('Continuing interview...', 'info');
        }

        async function deleteDashboardInterview(interviewId) {
          if (!confirm('Are you sure you want to delete this interview? This action cannot be undone.')) {
            return;
          }

          try {
            // Get session ID from global state
            const sessionId = globalResumeState.sessionId || localStorage.getItem('sessionId');
            const headers = {};
            if (sessionId) {
              headers['x-session-id'] = sessionId;
            }

            const response = await fetch(`/api/mock-interview/interview-session/${interviewId}`, {
              method: 'DELETE',
              headers
            });

            if (response.ok) {
              // Reload the dashboard
              loadInterviewDashboard();
              showToast('Interview deleted successfully', 'success');
            } else {
              throw new Error('Failed to delete interview');
            }
          } catch (error) {
            console.error('Error deleting interview:', error);
            showToast('Failed to delete interview. Please try again.', 'error');
          }
        }

        // ========== COMMUNITY FEATURE FUNCTIONS ==========

        // Community state
        let communityCurrentFilter = 'all';
        let communityCurrentOffset = 0;
        const communityPageSize = 20;
        let communityHasMore = false;

        // Initialize community when tab is shown
        function initializeCommunity() {
          loadCommunityPosts();
        }

        // Load community posts
        async function loadCommunityPosts(append = false) {
          const feedEl = document.getElementById('community-feed');
          const loadingEl = document.getElementById('community-loading');
          const emptyEl = document.getElementById('community-empty');
          const loadMoreEl = document.getElementById('community-load-more');
          const sortEl = document.getElementById('community-sort');

          if (!append) {
            communityCurrentOffset = 0;
            feedEl.innerHTML = '';
          }

          loadingEl.style.display = 'block';
          emptyEl.style.display = 'none';
          loadMoreEl.style.display = 'none';

          try {
            const params = new URLSearchParams({
              category: communityCurrentFilter,
              sort: sortEl.value,
              limit: communityPageSize.toString(),
              offset: communityCurrentOffset.toString(),
            });

            const response = await fetch(`/api/community/posts?${params}`, {
              headers: {
                'x-user-id': currentUser?.id || localStorage.getItem('jobmatch_session') || '',
              },
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to load posts');
            }

            loadingEl.style.display = 'none';

            if (data.posts.length === 0 && !append) {
              emptyEl.style.display = 'block';
              return;
            }

            data.posts.forEach(post => {
              feedEl.appendChild(createPostCard(post));
            });

            communityHasMore = data.hasMore;
            communityCurrentOffset += data.posts.length;

            if (communityHasMore) {
              loadMoreEl.style.display = 'block';
            }
          } catch (error) {
            console.error('Error loading posts:', error);
            loadingEl.style.display = 'none';
            showToast('Failed to load posts. Please try again.', 'error');
          }
        }

        // Create post card
        function createPostCard(post) {
          const card = document.createElement('div');
          card.className = 'card';
          card.style.cssText = 'cursor: pointer; transition: all 0.2s ease; border-left: 4px solid ' + getCategoryColor(post.category);

          const categoryEmoji = getCategoryEmoji(post.category);
          const timeAgo = getTimeAgo(new Date(post.created_at));

          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="background: ${getCategoryBg(post.category)}; color: ${getCategoryColor(post.category)}; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                    ${categoryEmoji} ${post.category.replace('_', ' ')}
                  </span>
                  ${post.is_anonymous ? '<span style="color: #64748B; font-size: 0.85rem;">Anonymous</span>' : `<span style="color: #64748B; font-size: 0.85rem;">by ${post.author_name}</span>`}
                  <span style="color: #94A3B8; font-size: 0.85rem;">‚Ä¢ ${timeAgo}</span>
                </div>
                <h3 style="font-size: 1.2rem; font-weight: 700; color: #1E293B; margin-bottom: 8px;">${escapeHtml(post.title)}</h3>
                <p style="color: #475569; line-height: 1.6; margin-bottom: 12px;">${truncateText(escapeHtml(post.content), 200)}</p>
                ${post.tags && post.tags.length > 0 ? `
                  <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
                    ${post.tags.map(tag => `<span class="tag" style="background: #F1F5F9; color: #475569; padding: 4px 10px; border-radius: 50px; font-size: 0.75rem;">#${tag}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 20px; color: #64748B; font-size: 0.9rem;">
              <span onclick="event.stopPropagation(); togglePostLike('${post.id}')" style="cursor: pointer; display: flex; align-items: center; gap: 6px;">
                <span id="like-icon-${post.id}">${post.user_has_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                <span id="like-count-${post.id}">${post.like_count || 0}</span>
              </span>
              <span style="display: flex; align-items: center; gap: 6px;">
                üí¨ ${post.comment_count || 0}
              </span>
              <span style="display: flex; align-items: center; gap: 6px;">
                üëÅÔ∏è ${post.view_count || 0}
              </span>
            </div>
          `;

          card.onclick = () => openPostDetail(post.id);

          return card;
        }

        // Filter community posts
        function filterCommunity(category) {
          communityCurrentFilter = category;

          // Update button states
          document.querySelectorAll('[id^="filter-"]').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
            btn.style.background = '';
            btn.style.color = '';
          });

          const activeBtn = document.getElementById(`filter-${category}`);
          if (activeBtn) {
            activeBtn.classList.remove('btn-secondary');
            activeBtn.classList.add('btn-primary');
            activeBtn.style.background = '#FF9500';
            activeBtn.style.color = 'white';
          }

          loadCommunityPosts();
        }

        // Load more posts
        function loadMorePosts() {
          loadCommunityPosts(true);
        }

        // Show create post modal
        function showCreatePostModal() {
          if (!currentUser && !localStorage.getItem('jobmatch_session')) {
            showToast('Please sign in to create a post', 'error');
            openAuthModal('login');
            return;
          }

          const modal = document.getElementById('create-post-modal');
          if (modal) {
            modal.style.display = 'flex';
            // Reset form
            document.getElementById('create-post-form').reset();
          }
        }

        // Close create post modal
        function closeCreatePostModal() {
          const modal = document.getElementById('create-post-modal');
          if (modal) {
            modal.style.display = 'none';
          }
        }

        // Submit community post
        async function submitCommunityPost(event) {
          event.preventDefault();

          const title = document.getElementById('post-title').value;
          const content = document.getElementById('post-content').value;
          const category = document.getElementById('post-category').value;
          const tagsInput = document.getElementById('post-tags').value;
          const isAnonymous = document.getElementById('post-anonymous').checked;

          const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

          const submitBtn = document.getElementById('submit-post-btn');
          const submitText = document.getElementById('submit-post-text');
          const submitLoading = document.getElementById('submit-post-loading');

          submitBtn.disabled = true;
          submitText.style.display = 'none';
          submitLoading.style.display = 'inline-block';

          try {
            const response = await fetch('/api/community/posts', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-user-id': currentUser?.id || localStorage.getItem('jobmatch_session') || '',
              },
              body: JSON.stringify({
                title,
                content,
                category,
                tags,
                isAnonymous,
              }),
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to create post');
            }

            showToast('Post created successfully!', 'success');
            closeCreatePostModal();
            loadCommunityPosts(); // Reload feed
          } catch (error) {
            console.error('Error creating post:', error);
            showToast(error.message || 'Failed to create post', 'error');
          } finally {
            submitBtn.disabled = false;
            submitText.style.display = 'inline';
            submitLoading.style.display = 'none';
          }
        }

        // Open post detail
        async function openPostDetail(postId) {
          const modal = document.getElementById('post-detail-modal');
          const titleEl = document.getElementById('detail-post-title');
          const contentEl = document.getElementById('post-detail-content');

          if (!modal) return;

          modal.style.display = 'flex';
          contentEl.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

          try {
            const response = await fetch(`/api/community/posts/${postId}`, {
              headers: {
                'x-user-id': currentUser?.id || localStorage.getItem('jobmatch_session') || '',
              },
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to load post');
            }

            const post = data.post;
            const comments = data.comments || [];

            titleEl.textContent = post.title;

            const categoryEmoji = getCategoryEmoji(post.category);
            const timeAgo = getTimeAgo(new Date(post.created_at));

            contentEl.innerHTML = `
              <div style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                  <span style="background: ${getCategoryBg(post.category)}; color: ${getCategoryColor(post.category)}; padding: 6px 14px; border-radius: 50px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">
                    ${categoryEmoji} ${post.category.replace('_', ' ')}
                  </span>
                  ${post.is_anonymous ? '<span style="color: #64748B;">Anonymous</span>' : `<span style="color: #64748B;">by ${post.author_name}</span>`}
                  <span style="color: #94A3B8;">‚Ä¢ ${timeAgo}</span>
                </div>
                <div style="color: #1E293B; line-height: 1.8; white-space: pre-wrap;">${escapeHtml(post.content)}</div>
                ${post.tags && post.tags.length > 0 ? `
                  <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px;">
                    ${post.tags.map(tag => `<span class="tag" style="background: #F1F5F9; color: #475569; padding: 6px 12px; border-radius: 50px; font-size: 0.85rem;">#${tag}</span>`).join('')}
                  </div>
                ` : ''}
                <div style="display: flex; align-items: center; gap: 24px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #E2E8F0;">
                  <button onclick="togglePostLike('${post.id}')" class="btn btn-sm" style="display: flex; align-items: center; gap: 8px;">
                    <span id="like-icon-${post.id}">${post.user_has_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                    <span id="like-count-${post.id}">${post.like_count || 0} Likes</span>
                  </button>
                  <span style="color: #64748B;">üí¨ ${post.comment_count || 0} Comments</span>
                  <span style="color: #64748B;">üëÅÔ∏è ${post.view_count || 0} Views</span>
                </div>
              </div>

              <div style="border-top: 2px solid #E2E8F0; padding-top: 24px;">
                <h3 style="margin-bottom: 20px; color: #1E293B;">Comments (${comments.length})</h3>
                
                <form onsubmit="submitComment(event, '${postId}')" style="margin-bottom: 24px;">
                  <textarea id="comment-input-${postId}" placeholder="Add a comment..." required
                    style="width: 100%; min-height: 80px; padding: 12px; background: white; border: 2px solid #E2E8F0; border-radius: 12px; color: #1E293B; font-family: inherit; resize: vertical; margin-bottom: 12px;"></textarea>
                  <button type="submit" class="btn btn-primary">Post Comment</button>
                </form>

                <div id="comments-list-${postId}" style="display: flex; flex-direction: column; gap: 16px;">
                  ${comments.length === 0 ? '<p style="text-align: center; color: #94A3B8; padding: 40px;">No comments yet. Be the first to comment!</p>' : comments.map(comment => createCommentHTML(comment, postId)).join('')}
                </div>
              </div>
            `;
          } catch (error) {
            console.error('Error loading post:', error);
            contentEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #EF4444;">Failed to load post details</div>';
          }
        }

        // Close post detail modal
        function closePostDetailModal() {
          const modal = document.getElementById('post-detail-modal');
          if (modal) {
            modal.style.display = 'none';
          }
        }

        // Create comment HTML
        function createCommentHTML(comment, postId) {
          const timeAgo = getTimeAgo(new Date(comment.created_at));
          return `
            <div class="card" style="background: #F8FAFC; border: 1px solid #E2E8F0;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="font-weight: 600; color: #1E293B;">${comment.author_name}</div>
                <div style="color: #94A3B8; font-size: 0.85rem;">${timeAgo}</div>
              </div>
              <div style="color: #475569; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(comment.content)}</div>
              <div style="margin-top: 12px; display: flex; align-items: center; gap: 16px;">
                <button onclick="toggleCommentLike('${comment.id}')" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; color: #64748B; font-size: 0.9rem;">
                  <span id="comment-like-icon-${comment.id}">${comment.user_has_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                  <span id="comment-like-count-${comment.id}">${comment.like_count || 0}</span>
                </button>
              </div>
            </div>
          `;
        }

        // Submit comment
        async function submitComment(event, postId) {
          event.preventDefault();

          const input = document.getElementById(`comment-input-${postId}`);
          const content = input.value.trim();

          if (!content) return;

          if (!currentUser && !localStorage.getItem('jobmatch_session')) {
            showToast('Please sign in to comment', 'error');
            openAuthModal('login');
            return;
          }

          try {
            const response = await fetch(`/api/community/posts/${postId}/comments`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-user-id': currentUser?.id || localStorage.getItem('jobmatch_session') || '',
              },
              body: JSON.stringify({ content }),
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to add comment');
            }

            showToast('Comment added!', 'success');
            input.value = '';

            // Reload post detail to show new comment
            openPostDetail(postId);
          } catch (error) {
            console.error('Error adding comment:', error);
            showToast(error.message || 'Failed to add comment', 'error');
          }
        }

        // Toggle post like
        async function togglePostLike(postId) {
          if (!currentUser && !localStorage.getItem('jobmatch_session')) {
            showToast('Please sign in to like posts', 'error');
            openAuthModal('login');
            return;
          }

          try {
            const response = await fetch(`/api/community/posts/${postId}/like`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-user-id': currentUser?.id || localStorage.getItem('jobmatch_session') || '',
              },
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to toggle like');
            }

            // Update UI
            const iconEl = document.getElementById(`like-icon-${postId}`);
            const countEl = document.getElementById(`like-count-${postId}`);

            if (iconEl && countEl) {
              iconEl.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
              const currentCount = parseInt(countEl.textContent) || 0;
              countEl.textContent = data.liked ? currentCount + 1 : Math.max(0, currentCount - 1);
            }
          } catch (error) {
            console.error('Error toggling like:', error);
            showToast('Failed to update like', 'error');
          }
        }

        // Toggle comment like
        async function toggleCommentLike(commentId) {
          if (!currentUser && !localStorage.getItem('jobmatch_session')) {
            showToast('Please sign in to like comments', 'error');
            openAuthModal('login');
            return;
          }

          try {
            const response = await fetch(`/api/community/comments/${commentId}/like`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-user-id': currentUser?.id || localStorage.getItem('jobmatch_session') || '',
              },
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to toggle like');
            }

            // Update UI
            const iconEl = document.getElementById(`comment-like-icon-${commentId}`);
            const countEl = document.getElementById(`comment-like-count-${commentId}`);

            if (iconEl && countEl) {
              iconEl.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
              const currentCount = parseInt(countEl.textContent) || 0;
              countEl.textContent = data.liked ? currentCount + 1 : Math.max(0, currentCount - 1);
            }
          } catch (error) {
            console.error('Error toggling like:', error);
            showToast('Failed to update like', 'error');
          }
        }

        // Helper functions
        function getCategoryColor(category) {
          const colors = {
            success_story: '#10B981',
            question: '#3B82F6',
            advice: '#F59E0B',
            vent: '#8B5CF6',
            resource: '#06B6D4',
          };
          return colors[category] || '#64748B';
        }

        function getCategoryBg(category) {
          const bgs = {
            success_story: '#D1FAE5',
            question: '#DBEAFE',
            advice: '#FEF3C7',
            vent: '#EDE9FE',
            resource: '#CFFAFE',
          };
          return bgs[category] || '#F1F5F9';
        }

        function getCategoryEmoji(category) {
          const emojis = {
            success_story: 'üéâ',
            question: '‚ùì',
            advice: 'üí°',
            vent: 'üò§',
            resource: 'üìö',
          };
          return emojis[category] || 'üí¨';
        }

        function getTimeAgo(date) {
          const seconds = Math.floor((new Date() - date) / 1000);

          if (seconds < 60) return 'just now';
          if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
          if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
          if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;

          return date.toLocaleDateString();
        }

        function truncateText(text, maxLength) {
          if (text.length <= maxLength) return text;
          return text.substring(0, maxLength) + '...';
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        // Initialize community when switching to the tab
        const originalSwitchTab = window.switchTab;
        window.switchTab = function (tabName) {
          if (originalSwitchTab) {
            originalSwitchTab(tabName);
          }
          if (tabName === 'community') {
            initializeCommunity();
          }
        };

      </script>

      <!-- Auth Modal -->
      <div id="authModal" class="modal"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
          style="background: #1e1e2e; padding: 30px; border-radius: 16px; width: 100%; max-width: 400px; border: 1px solid #2e2e3e;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="authTitle" style="font-size: 1.5rem; font-weight: 700;">Sign In</h2>
            <button onclick="closeAuthModal()"
              style="background: none; border: none; color: #64748b; font-size: 1.5rem; cursor: pointer;">&times;</button>
          </div>

          <!-- Google Button Container -->
          <div id="g_id_signin_container" style="width: 100%; margin-bottom: 20px;"></div>

          <div
            style="display: flex; align-items: center; gap: 10px; margin: 20px 0; color: #64748b; font-size: 0.8rem;">
            <div style="flex: 1; height: 1px; background: #2e2e3e;"></div>
            OR
            <div style="flex: 1; height: 1px; background: #2e2e3e;"></div>
          </div>

          <form id="authForm" onsubmit="handleAuthSubmit(event)">
            <div class="form-group" style="margin-bottom: 15px;">
              <label style="display: block; color: #94a3b8; font-size: 0.85rem; margin-bottom: 6px;">Email
                Address</label>
              <input type="email" name="email" required class="input" placeholder="you@example.com">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
              <label style="display: block; color: #94a3b8; font-size: 0.85rem; margin-bottom: 6px;">Password</label>
              <input type="password" name="password" required class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div id="registerFields" style="display: none;">
              <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; color: #94a3b8; font-size: 0.85rem; margin-bottom: 6px;">Full Name</label>
                <input type="text" name="fullName" class="input" placeholder="John Doe">
              </div>
            </div>

            <div style="color: #ef4444; font-size: 0.85rem; margin-bottom: 15px; display: none;" id="authError"></div>

            <button type="submit" class="btn btn-primary btn-full" id="authSubmitBtn">Sign In</button>
          </form>

          <div style="margin-top: 20px; text-align: center; font-size: 0.9rem; color: #94a3b8;">
            <span id="authSwitchText">Don't have an account?</span>
            <button onclick="toggleAuthMode()"
              style="background: none; border: none; color: #6366f1; cursor: pointer; font-weight: 600; text-decoration: underline;">
              <span id="authSwitchAction">Sign Up</span>
            </button>
          </div>
        </div>
      </div>

      <script>
        let isRegisterMode = false;
        // let currentUser = null; // Already declared in main script

        function openAuthModal(mode = 'login') {
          const modal = document.getElementById('authModal');
          modal.style.display = 'flex';
          isRegisterMode = mode === 'register';
          updateAuthUI();
        }

        function closeAuthModal() {
          const modal = document.getElementById('authModal');
          const errorDiv = document.getElementById('authError');
          if (modal) modal.style.display = 'none';
          if (errorDiv) {
            errorDiv.style.display = 'none';
            errorDiv.innerText = '';
          }
        }

        function toggleAuthMode() {
          isRegisterMode = !isRegisterMode;
          updateAuthUI();
        }

        function updateAuthUI() {
          const title = document.getElementById('authTitle');
          const submitBtn = document.getElementById('authSubmitBtn');
          const switchText = document.getElementById('authSwitchText');
          const switchAction = document.getElementById('authSwitchAction');
          const registerFields = document.getElementById('registerFields');

          if (isRegisterMode) {
            title.innerText = 'Create Account';
            submitBtn.innerText = 'Sign Up';
            switchText.innerText = 'Already have an account?';
            switchAction.innerText = 'Sign In';
            registerFields.style.display = 'block';
            document.querySelector('input[name="fullName"]').required = true;
          } else {
            title.innerText = 'Sign In';
            submitBtn.innerText = 'Sign In';
            switchText.innerText = 'Don\'t have an account?';
            switchAction.innerText = 'Sign Up';
            registerFields.style.display = 'none';
            document.querySelector('input[name="fullName"]').required = false;
          }
        }

        async function handleAuthSubmit(e) {
          e.preventDefault();
          const form = e.target;
          const email = form.email.value;
          const password = form.password.value;
          const fullName = form.fullName?.value;
          const errorDiv = document.getElementById('authError');
          const btn = document.getElementById('authSubmitBtn');

          // Get current guest session (if any) from localStorage or URL
          // (Assuming sessionId is stored or we let backend resolve from cookie/header if implemented)
          // For now, let's grab the 'sessionId' from wherever the app stores it.
          // Inspecting app logic: sessionId is usually returned in upload response.
          // We will try to send 'sessionId' if we have one in State.
          const sessionId = localStorage.getItem('currentSessionId');

          btn.disabled = true;
          btn.innerText = 'Processing...';
          errorDiv.style.display = 'none';

          try {
            const endpoint = isRegisterMode ? '/api/auth/register' : '/api/auth/login';
            const body = { email, password, sessionId };
            if (isRegisterMode) body.fullName = fullName;

            const res = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });

            const data = await res.json();

            if (!data.success) {
              throw new Error(data.error || 'Authentication failed');
            }

            // Success
            currentUser = data.user;
            updateUserDisplay(currentUser);
            closeAuthModal();
            alert(isRegisterMode ? 'Account created successfully!' : 'Signed in successfully!');

          } catch (err) {
            errorDiv.innerText = err.message;
            errorDiv.style.display = 'block';
          } finally {
            btn.disabled = false;
            btn.innerText = isRegisterMode ? 'Sign Up' : 'Sign In';
          }
        }

        // Initialize Google Sign-In
        let GOOGLE_CLIENT_ID = null;

        async function initGoogleSignIn() {
          try {
            // Fetch Google Client ID from config
            if (!GOOGLE_CLIENT_ID) {
              const configRes = await fetch('/api/config');
              const config = await configRes.json();
              GOOGLE_CLIENT_ID = config.googleClientId;
            }

            if (!GOOGLE_CLIENT_ID) {
              console.error('Google Client ID not configured');
              return;
            }

            // Wait for Google library to load
            if (typeof google === 'undefined' || !google.accounts) {
              setTimeout(initGoogleSignIn, 100);
              return;
            }

            // Initialize Google Sign-In
            google.accounts.id.initialize({
              client_id: GOOGLE_CLIENT_ID,
              callback: handleGoogleCredential,
              auto_select: false
            });

            // Render the button
            google.accounts.id.renderButton(
              document.getElementById('g_id_signin_container'),
              {
                theme: 'filled_blue',
                size: 'large',
                width: '100%',
                text: 'continue_with',
                shape: 'rectangular'
              }
            );
          } catch (err) {
            console.error('Failed to initialize Google Sign-In:', err);
          }
        }

        async function handleGoogleCredential(response) {
          const sessionId = localStorage.getItem('jobmatch_session') || localStorage.getItem('currentSessionId');

          try {
            const res = await fetch('/api/auth/google', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                credential: response.credential,
                sessionId
              })
            });

            const data = await res.json();

            if (!data.success) {
              throw new Error(data.error || 'Google Sign-In failed');
            }

            // Save user to memory and localStorage
            currentUser = data.user;
            localStorage.setItem('jobmatch_user', JSON.stringify(currentUser));

            // Update UI
            updateUserDisplay(currentUser);
            closeAuthModal();
            alert('Welcome ' + currentUser.fullName + '!');

          } catch (err) {
            alert('Google Sign-In Error: ' + err.message);
          }
        }

        // Initialize Google Sign-In when page loads
        window.addEventListener('load', function () {
          initGoogleSignIn();
          // Update user display if already logged in
          if (currentUser) {
            updateUserDisplay(currentUser);
          }
        });

        function updateUserDisplay(user) {
          // Header items
          const authButtons = document.getElementById('auth-buttons');
          const userMenu = document.getElementById('user-menu');
          const userDisplayName = document.getElementById('user-display-name');
          const userAvatar = document.getElementById('user-avatar');

          // Sidebar items
          const sidebarAuthButtons = document.getElementById('sidebar-auth-buttons');
          const sidebarUserMenu = document.getElementById('sidebar-user-menu');
          const sidebarUserName = document.getElementById('sidebar-user-name');
          const sidebarUserAvatar = document.getElementById('sidebar-user-avatar');

          const nameToDisplay = user ? (user.fullName || user.email) : '';
          const avatarInitial = nameToDisplay ? nameToDisplay.charAt(0).toUpperCase() : 'U';

          if (user) {
            // Update Header
            if (authButtons) authButtons.style.display = 'none';
            if (userMenu) {
              userMenu.style.display = 'block';
              if (userDisplayName) userDisplayName.innerText = nameToDisplay;
              if (userAvatar) userAvatar.innerText = avatarInitial;
            }

            // Update Sidebar
            if (sidebarAuthButtons) sidebarAuthButtons.style.display = 'none';
            if (sidebarUserMenu) {
              sidebarUserMenu.style.display = 'block';
              if (sidebarUserName) sidebarUserName.innerText = nameToDisplay;
              if (sidebarUserAvatar) sidebarUserAvatar.innerText = avatarInitial;
            }
          } else {
            // Update Header
            if (authButtons) authButtons.style.display = 'flex';
            if (userMenu) userMenu.style.display = 'none';

            // Update Sidebar
            if (sidebarAuthButtons) sidebarAuthButtons.style.display = 'flex';
            if (sidebarUserMenu) sidebarUserMenu.style.display = 'none';
          }
        }
      </script>

    </div><!-- /content-wrapper -->
  </div><!-- /main-content -->

  <!-- Mobile Overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- Sidebar JavaScript -->
  <script>
    // Sidebar state
    let sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

    // Initialize sidebar
    function initSidebar() {
      const sidebar = document.getElementById('sidebar');

      if (sidebarCollapsed && window.innerWidth > 768) {
        sidebar.classList.add('collapsed');
      }

      // Nav item clicks
      document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const tab = item.dataset.tab;

          // Update active state
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');

          // Switch tab (use existing switchTab function)
          if (typeof switchTab === 'function') {
            switchTab(tab);
          }

          // Close on mobile
          if (window.innerWidth <= 768) {
            closeSidebar();
          }
        });
      });
    }

    // Toggle sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      if (window.innerWidth <= 768) {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
      } else {
        sidebar.classList.toggle('collapsed');
        sidebarCollapsed = sidebar.classList.contains('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
      }
    }

    // Close sidebar
    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebar-overlay').classList.remove('show');
    }

    // Init on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSidebar);
    } else {
      initSidebar();
    }
  </script>

  <script>
    // ========== JOB MATCHING SEARCH (New) ==========

    async function initiateJobSearch() {
      const queryInput = document.getElementById('search-query');
      const locationInput = document.getElementById('search-location');
      const dateInput = document.getElementById('search-date-posted'); // New
      const searchBtn = document.getElementById('search-jobs-btn');
      const searchBtnText = document.getElementById('search-btn-text');
      const searchLoading = document.getElementById('search-loading');

      const jobTitle = queryInput.value.trim();
      const location = locationInput.value.trim();
      const datePosted = dateInput ? dateInput.value : 'month'; // Default to month

      if (!jobTitle) {
        showToast('Please enter a job title or keyword', 'error');
        return;
      }

      if (!location) {
        showToast('Please enter a location', 'error');
        return;
      }

      // UI Loading State
      if (searchBtn) searchBtn.disabled = true;
      if (searchBtnText) searchBtnText.style.display = 'none';
      if (searchLoading) searchLoading.style.display = 'inline-block';

      try {
        const sessionId = window.sessionId || localStorage.getItem('jobmatch_session');

        const response = await fetch('/api/jobs/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': currentUser?.id || sessionId || 'anonymous'
          },
          body: JSON.stringify({
            jobTitle,
            location,
            datePosted,
            count: 20
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.message || data.error || 'Search failed');
        }

        showToast(`Searching for jobs posted in the past ${datePosted === 'today' ? '24h' : datePosted}...`, 'info');

        // Start polling
        const runId = data.data.runId;
        pollJobUpdates(runId);

      } catch (error) {
        console.error('Search error:', error);
        showToast(error.message, 'error');
        resetSearchButton();
      }
    }

    // ... (resetSearchButton and pollJobUpdates remain same, skipping to renderJobResults) ...

    function renderJobResults(jobs) {
      const resultsContainer = document.getElementById('job-results');
      const jobList = document.getElementById('job-list');
      const suggestSection = document.getElementById('suggestions-section');

      if (!resultsContainer || !suggestSection) return;

      resultsContainer.style.display = 'block';
      suggestSection.style.display = 'block';

      // Update count
      const countEl = document.getElementById('jobs-count');
      if (countEl) countEl.innerText = jobs.length;

      // Clear previous list
      if (jobList) jobList.innerHTML = '';

      if (jobs.length === 0) {
        jobList.innerHTML = '<div style="text-align:center; padding: 40px; color: #64748b;">No jobs found matching your criteria. Try widening your search or location.</div>';
        return;
      }

      jobs.forEach(job => {
        const card = document.createElement('div');
        card.className = 'job-card';
        card.style.cssText = `
              background: white; 
              padding: 20px; 
              border-radius: 16px; 
              border: 1px solid #E2E8F0; 
              margin-bottom: 16px;
              box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
              transition: all 0.2s ease;
              position: relative;
              overflow: hidden;
           `;
        card.onmouseover = () => {
          card.style.transform = 'translateY(-2px)';
          card.style.boxShadow = '0 10px 15px -3px rgba(0,0,0,0.1)';
          card.style.borderColor = '#CBD5E1';
        };
        card.onmouseout = () => {
          card.style.transform = 'none';
          card.style.boxShadow = '0 4px 6px -1px rgba(0,0,0,0.05)';
          card.style.borderColor = '#E2E8F0';
        };

        const postedDateStr = job.postedAt || job.datePosted;
        let postedLabel = 'Recently';
        let isNew = false;

        if (postedDateStr) {
          const date = new Date(postedDateStr);
          // Check if valid date
          if (!isNaN(date.getTime())) {
            postedLabel = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            // If < 2 days
            const hoursDiff = (new Date() - date) / (1000 * 60 * 60);
            if (hoursDiff < 48) isNew = true;
          } else {
            // Fallback if string like "2 days ago"
            postedLabel = postedDateStr;
            if (String(postedDateStr).includes('hours') || String(postedDateStr).includes('minute')) isNew = true;
          }
        }

        card.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:start; gap: 16px;">
                  <div style="flex: 1;">
                      <div style="display:flex; align-items:center; gap: 8px; margin-bottom: 6px;">
                        ${isNew ? '<span style="background: #DEF7EC; color: #046C4E; font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 700; letter-spacing: 0.025em; text-transform: uppercase;">New</span>' : ''}
                        <h4 style="font-size:1.25rem; font-weight:700; color:#1E293B; margin:0; line-height: 1.4;">${job.title || job.positionName}</h4>
                      </div>
                      <div style="color:#64748B; font-size:0.95rem; margin-bottom:12px; display:flex; align-items:center; gap: 6px;">
                          <span style="font-weight: 600; color: #475569;">${job.company || job.companyName}</span>
                          <span>‚Ä¢</span>
                          <span>${job.location}</span>
                      </div>
                  </div>
                  ${job.companyLogo ? `<img src="${job.companyLogo}" style="width:48px; height:48px; border-radius:10px; object-fit:contain; border: 1px solid #F1F5F9; padding: 4px; background: white;">` : '<div style="width:48px; height:48px; background:#F8FAFC; border-radius:10px; display:flex; align-items:center; justify-content:center; border: 1px solid #E2E8F0;"><span style="font-size:1.5rem;">üè¢</span></div>'}
              </div>
              
              <div style="font-size:0.9rem; color:#475569; margin-bottom:16px; line-height: 1.6; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">
                  ${job.description || 'No description available.'}
              </div>
              
              <div style="display:flex; justify-content:space-between; align-items:center; padding-top: 16px; border-top: 1px solid #F1F5F9;">
                  <div style="display:flex; align-items:center; gap: 6px; font-size:0.85rem; color:#94A3B8;">
                    <span>üìÖ Posted ${postedLabel}</span>
                  </div>
                  <a href="${job.url || job.jobUrl || '#'}" target="_blank" class="btn btn-primary btn-sm" style="padding: 8px 16px; display: flex; align-items: center; gap: 6px;">
                    Apply Now <span>‚Üí</span>
                  </a>
              </div>
           `;
        jobList.appendChild(card);
      });
    }

    // Bind Event Listener
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('search-jobs-btn');
      if (btn) {
        btn.addEventListener('click', initiateJobSearch);
      }
    });
  </script>
</body>

</html>