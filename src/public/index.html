<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JobMatch AI - Resume Analyzer + Job Search</title>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; color: #e2e8f0; min-height: 100vh; }
    
    /* Header */
    header { background: #12121a; border-bottom: 1px solid #1e1e2e; padding: 16px 24px; position: sticky; top: 0; z-index: 100; }
    .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .logo span { background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    /* Main Tabs */
    .main-tabs { display: flex; gap: 8px; }
    .main-tab { padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #94a3b8; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
    .main-tab:hover { color: #e2e8f0; background: #1e1e2e; }
    .main-tab.active { background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.1)); color: #a5b4fc; border-color: rgba(99, 102, 241, 0.3); }
    .main-tab .badge { background: #6366f1; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; margin-left: 6px; }
    
    /* Container */
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    
    /* Cards */
    .card { background: #12121a; border: 1px solid #1e1e2e; border-radius: 16px; padding: 24px; margin-bottom: 20px; }
    .card-header { margin-bottom: 20px; }
    .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 4px; }
    .card-subtitle { font-size: 0.9rem; color: #64748b; }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; font-size: 0.95rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #1e1e2e; color: #e2e8f0; border: 1px solid #2e2e3e; }
    .btn-secondary:hover { background: #2e2e3e; }
    .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
    .btn-full { width: 100%; }
    
    /* Grid */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } .main-tabs { flex-wrap: wrap; } }
    
    /* Upload */
    .upload-zone { border: 2px dashed #2e2e3e; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }
    .upload-zone.has-file { border-color: #10b981; background: rgba(16, 185, 129, 0.05); }
    .upload-zone input { display: none; }
    .upload-icon { font-size: 2.5rem; margin-bottom: 12px; }
    .file-name { color: #10b981; font-weight: 600; margin-top: 12px; }
    
    /* Textarea */
    textarea { width: 100%; min-height: 200px; padding: 16px; background: #1e1e2e; border: 1px solid #2e2e3e; border-radius: 10px; color: #e2e8f0; font-family: inherit; font-size: 0.95rem; resize: vertical; }
    textarea:focus { outline: none; border-color: #6366f1; }
    
    /* Input */
    .input { width: 100%; padding: 12px 16px; background: #1e1e2e; border: 1px solid #2e2e3e; border-radius: 10px; color: #e2e8f0; font-size: 0.95rem; }
    .input:focus { outline: none; border-color: #6366f1; }
    
    /* Sections */
    .section { display: none; }
    .section.active { display: block; }
    
    /* Score Display */
    .score-hero { text-align: center; padding: 32px; border-radius: 16px; margin-bottom: 24px; }
    .score-hero.strong { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border: 2px solid rgba(16, 185, 129, 0.3); }
    .score-hero.moderate { background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05)); border: 2px solid rgba(245, 158, 11, 0.3); }
    .score-hero.weak { background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); border: 2px solid rgba(239, 68, 68, 0.3); }
    
    .score-ring { width: 120px; height: 120px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 16px; border: 5px solid; }
    .score-ring.high { border-color: #10b981; color: #10b981; }
    .score-ring.medium { border-color: #f59e0b; color: #f59e0b; }
    .score-ring.low { border-color: #ef4444; color: #ef4444; }
    .score-number { font-size: 2.5rem; font-weight: 800; }
    .score-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }
    
    .verdict-badge { display: inline-block; padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: 0.85rem; margin-bottom: 12px; }
    .verdict-badge.high { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .verdict-badge.medium { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .verdict-badge.low { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    
    /* Analysis Items */
    .analysis-card { background: #1e1e2e; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
    .analysis-card h4 { font-size: 0.95rem; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    
    .item { background: #0a0a0f; padding: 14px; border-radius: 10px; margin-bottom: 8px; }
    .item.success { border-left: 4px solid #10b981; }
    .item.danger { border-left: 4px solid #ef4444; }
    .item.warning { border-left: 4px solid #f59e0b; }
    .item-title { font-weight: 600; margin-bottom: 4px; }
    .item-desc { font-size: 0.9rem; color: #94a3b8; }
    .item-fix { font-size: 0.85rem; color: #6366f1; margin-top: 8px; padding-top: 8px; border-top: 1px solid #2e2e3e; }
    
    /* Tags */
    .tag { display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 500; margin: 3px; }
    .tag-success { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .tag-danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .tag-warning { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .tag-info { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; }
    
    /* Progress Bar */
    .progress-bar { height: 8px; background: #1e1e2e; border-radius: 4px; overflow: hidden; margin: 12px 0; }
    .progress-fill { height: 100%; border-radius: 4px; }
    .progress-fill.high { background: #10b981; }
    .progress-fill.medium { background: #f59e0b; }
    .progress-fill.low { background: #ef4444; }
    
    /* Job Cards */
    .job-card { background: #12121a; border: 1px solid #1e1e2e; border-radius: 14px; padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; }
    .job-card:hover { border-color: #3e3e4e; transform: translateX(4px); }
    .job-card.excellent { border-left: 4px solid #10b981; }
    .job-card.good { border-left: 4px solid #6366f1; }
    .job-card.moderate { border-left: 4px solid #f59e0b; }
    .job-header { display: flex; justify-content: space-between; }
    .job-title { font-size: 1.05rem; font-weight: 600; }
    .job-company { color: #94a3b8; font-size: 0.9rem; }
    .job-meta { display: flex; gap: 16px; color: #64748b; font-size: 0.85rem; margin-top: 8px; }
    .match-percent { font-size: 1.5rem; font-weight: 700; }
    .match-percent.high { color: #10b981; }
    .match-percent.medium { color: #f59e0b; }
    .match-percent.low { color: #ef4444; }
    
    .recommendation { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
    .recommendation.apply-now { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .recommendation.worth-it { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
    .recommendation.customize { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .recommendation.skip { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    
    /* Bottom Line */
    .bottom-line { background: linear-gradient(135deg, #1e1e2e, #12121a); border: 1px solid #2e2e3e; border-radius: 16px; padding: 28px; text-align: center; margin-top: 24px; }
    .bottom-line h3 { color: #f59e0b; margin-bottom: 16px; }
    .one-thing { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 10px; padding: 16px; margin: 16px 0; }
    .one-thing-label { font-size: 0.75rem; color: #818cf8; text-transform: uppercase; margin-bottom: 6px; }
    .one-thing-text { font-weight: 600; }
    .encouragement { color: #10b981; font-style: italic; }
    
    /* Cover Letter */
    .cover-letter-box { background: #1e1e2e; border-radius: 12px; padding: 24px; font-size: 0.95rem; line-height: 1.8; white-space: pre-wrap; }
    
    /* Tracker Stats */
    .tracker-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: #1e1e2e; padding: 20px; border-radius: 12px; text-align: center; }
    .stat-number { font-size: 2rem; font-weight: 700; }
    .stat-number.saved { color: #6366f1; }
    .stat-number.applied { color: #f59e0b; }
    .stat-number.interview { color: #10b981; }
    .stat-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-top: 4px; }
    @media (max-width: 600px) { .tracker-stats { grid-template-columns: repeat(2, 1fr); } }
    
    /* Search Links Grid */
    .search-links-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 700px) { .search-links-grid { grid-template-columns: 1fr; } }
    
    /* Actions */
    .action-list { list-style: none; }
    .action-list li { padding: 12px 14px; background: #0a0a0f; border-radius: 8px; margin-bottom: 6px; border-left: 3px solid; }
    .action-list.urgent li { border-left-color: #ef4444; }
    .action-list.quick li { border-left-color: #10b981; }
    .action-list.effort li { border-left-color: #f59e0b; }
    
    /* Cover Letter Modal (old style) */
    .cl-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .cl-modal.open { display: flex; }
    .cl-modal-content { background: #12121a; border: 1px solid #2e2e3e; border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
    .cl-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #1e1e2e; position: sticky; top: 0; background: #12121a; }
    .cl-modal-body { padding: 24px; }
    .cl-modal-close { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; }
    
    /* Misc */
    .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; background: #1e1e2e; border: 1px solid #2e2e3e; color: white; border-radius: 12px; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-color: #10b981; }
    .toast.error { border-color: #ef4444; background: #ef4444; }
    .empty-state { text-align: center; padding: 48px; color: #64748b; }
    .empty-state .icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
    .divider { height: 1px; background: #1e1e2e; margin: 20px 0; }
    .text-muted { color: #64748b; }
    .mb-4 { margin-bottom: 16px; }
    .mt-4 { margin-top: 16px; }
    .flex { display: flex; }
    .gap-2 { gap: 8px; }
    .gap-4 { gap: 16px; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .flex-wrap { flex-wrap: wrap; }
    
    /* Auth Styles */
    .auth-buttons { display: flex; gap: 8px; align-items: center; }
    .auth-buttons .btn { padding: 8px 16px; font-size: 0.85rem; }
    .user-menu { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; }
    .user-name { font-size: 0.9rem; color: #e2e8f0; }
    .dropdown { position: relative; }
    .dropdown-menu { position: absolute; top: 100%; right: 0; background: #1e1e2e; border: 1px solid #2e2e3e; border-radius: 8px; padding: 8px 0; min-width: 180px; display: none; z-index: 200; margin-top: 8px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 10px 16px; cursor: pointer; font-size: 0.9rem; color: #94a3b8; transition: all 0.2s; }
    .dropdown-item:hover { background: #2e2e3e; color: #e2e8f0; }
    
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-overlay.show { display: flex !important; }
    .modal { background: #12121a; border: 1px solid #2e2e3e; border-radius: 16px; padding: 32px; width: 90%; max-width: 420px; position: relative; }
    .modal-header { text-align: center; margin-bottom: 24px; }
    .modal-header h2 { font-size: 1.4rem; margin-bottom: 8px; }
    .modal-header p { color: #64748b; font-size: 0.9rem; }
    .modal-close { position: absolute; top: 12px; right: 16px; background: none; border: none; color: #94a3b8; font-size: 1.8rem; cursor: pointer; line-height: 1; padding: 4px; }
    .modal-close:hover { color: #e2e8f0; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 0.85rem; color: #94a3b8; margin-bottom: 6px; }
    .form-group input { width: 100%; padding: 12px 16px; background: #1e1e2e; border: 1px solid #2e2e3e; border-radius: 8px; color: #e2e8f0; font-size: 0.95rem; }
    .form-group input:focus { outline: none; border-color: #6366f1; }
    .form-error { color: #ef4444; font-size: 0.8rem; margin-top: 4px; display: none; }
    .form-divider { display: flex; align-items: center; gap: 16px; margin: 20px 0; color: #64748b; font-size: 0.85rem; }
    .form-divider::before, .form-divider::after { content: ''; flex: 1; height: 1px; background: #2e2e3e; }
    .auth-switch { text-align: center; margin-top: 16px; font-size: 0.9rem; color: #64748b; }
    .auth-switch a { color: #6366f1; cursor: pointer; text-decoration: underline; }
    .btn-google { background: white; color: #1f1f1f; border: 1px solid #dadce0; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 500; }
    .btn-google:hover { background: #f8f9fa; border-color: #dadce0; }
    .btn-google svg { flex-shrink: 0; }
    .google-btn-container { display: flex; justify-content: center; margin-bottom: 12px; }
    
    /* Saved Items indicator */
    .saved-indicator { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
    .saved-indicator .icon { font-size: 1.2rem; }
    .saved-indicator .text { font-size: 0.9rem; color: #10b981; }
  </style>
</head>
<body>
  <script>
    // Global auth modal functions (need to be available immediately)
    function showAuthModal(mode) {
      var modal = document.getElementById('auth-modal');
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        if (mode === 'signup') {
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('signup-form').style.display = 'block';
        } else {
          document.getElementById('login-form').style.display = 'block';
          document.getElementById('signup-form').style.display = 'none';
        }
      }
    }
    function hideAuthModal() {
      var modal = document.getElementById('auth-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
      }
    }
    function switchAuthMode(mode) {
      if (mode === 'signup') {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('signup-form').style.display = 'block';
      } else {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('signup-form').style.display = 'none';
      }
    }
  </script>
  <header>
    <div class="header-content">
      <div class="logo">üéØ <span>JobMatch AI</span></div>
      <nav class="main-tabs">
        <div class="main-tab active" data-tab="analyze">üîç Analyze Resume</div>
        <div class="main-tab" data-tab="search">üíº Find Jobs <span class="badge" id="jobs-badge" style="display:none">0</span></div>
        <div class="main-tab" data-tab="tracker">üìã Tracker <span class="badge" id="saved-badge" style="display:none">0</span></div>
        <div class="main-tab" data-tab="networking">üë• Networking</div>
      </nav>
      
      <!-- Auth Section -->
      <div id="auth-section">
        <!-- Shown when logged out -->
        <div id="auth-buttons" class="auth-buttons">
          <button type="button" class="btn btn-secondary" onclick="showAuthModal('login')">Log In</button>
          <button type="button" class="btn btn-primary" onclick="showAuthModal('signup')">Sign Up</button>
        </div>
        
        <!-- Shown when logged in -->
        <div id="user-menu" class="user-menu" style="display: none;">
          <div class="dropdown">
            <div style="display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="toggleUserDropdown()">
              <div class="user-avatar" id="user-avatar">U</div>
              <span class="user-name" id="user-display-name">User</span>
              <span style="color: #64748b;">‚ñº</span>
            </div>
            <div class="dropdown-menu" id="user-dropdown">
              <div class="dropdown-item" onclick="showMyData()">üìÅ My Saved Data</div>
              <div class="dropdown-item" onclick="showMyCoverLetters()">‚úâÔ∏è My Cover Letters</div>
              <div class="dropdown-item" style="border-top: 1px solid #2e2e3e; margin-top: 8px; padding-top: 12px;" onclick="logout()">üö™ Log Out</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Auth Modal -->
  <div class="modal-overlay" id="auth-modal">
    <div class="modal" style="position: relative;">
      <button class="modal-close" onclick="hideAuthModal()">&times;</button>
      
      <!-- Login Form -->
      <div id="login-form">
        <div class="modal-header">
          <h2>Welcome Back</h2>
          <p>Log in to access your saved resumes and cover letters</p>
        </div>
        
        <!-- Google Sign In -->
        <div id="google-signin-btn-login" class="google-btn-container"></div>
        <button type="button" class="btn btn-google btn-full" onclick="signInWithGoogle()">
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 3.58c1.22 0 2.31.42 3.17 1.25l2.38-2.38A8 8 0 0 0 1.83 5.4L4.5 7.49a4.8 4.8 0 0 1 4.48-3.9z"/></svg>
          Continue with Google
        </button>
        
        <div class="form-divider">or</div>
        
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="login-email" placeholder="your@email.com" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>
          <div class="form-error" id="login-error"></div>
          <button type="submit" class="btn btn-primary btn-full" id="login-btn">
            <span id="login-btn-text">Log In</span>
            <span class="loading" id="login-loading" style="display:none"></span>
          </button>
        </form>
        <div class="auth-switch">
          Don't have an account? <a onclick="switchAuthMode('signup')">Sign up</a>
        </div>
      </div>
      
      <!-- Signup Form -->
      <div id="signup-form" style="display: none;">
        <div class="modal-header">
          <h2>Create Account</h2>
          <p>Save your resumes and cover letters for easy access</p>
        </div>
        
        <!-- Google Sign In -->
        <button type="button" class="btn btn-google btn-full" onclick="signInWithGoogle()">
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 3.58c1.22 0 2.31.42 3.17 1.25l2.38-2.38A8 8 0 0 0 1.83 5.4L4.5 7.49a4.8 4.8 0 0 1 4.48-3.9z"/></svg>
          Sign up with Google
        </button>
        
        <div class="form-divider">or</div>
        
        <form onsubmit="handleSignup(event)">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="signup-name" placeholder="John Doe" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="signup-email" placeholder="your@email.com" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
          </div>
          <div class="form-error" id="signup-error"></div>
          <button type="submit" class="btn btn-primary btn-full" id="signup-btn">
            <span id="signup-btn-text">Create Account</span>
            <span class="loading" id="signup-loading" style="display:none"></span>
          </button>
        </form>
        <div class="auth-switch">
          Already have an account? <a onclick="switchAuthMode('login')">Log in</a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- My Data Modal -->
  <div class="modal-overlay" id="my-data-modal">
    <div class="modal" style="position: relative; max-width: 600px;">
      <button class="modal-close" onclick="hideMyDataModal()">&times;</button>
      <div class="modal-header">
        <h2>üìÅ My Saved Data</h2>
        <p>Your saved resumes and profile information</p>
      </div>
      <div id="my-data-content">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
  
  <!-- My Cover Letters Modal -->
  <div class="modal-overlay" id="cover-letters-modal">
    <div class="modal" style="position: relative; max-width: 700px; max-height: 80vh; overflow-y: auto;">
      <button class="modal-close" onclick="hideCoverLettersModal()">&times;</button>
      <div class="modal-header">
        <h2>‚úâÔ∏è My Cover Letters</h2>
        <p>Your saved cover letters</p>
      </div>
      <div id="cover-letters-content">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
  
  <div class="container">
    <!-- TAB 1: ANALYZE RESUME -->
    <section class="section active" id="tab-analyze">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üîç Why No Interviews?</h2>
          <p class="card-subtitle">Get brutally honest feedback on why your resume isn't getting callbacks</p>
        </div>
        
        <div class="grid-2">
          <div>
            <label style="font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 8px;">Your Resume</label>
            <div class="upload-zone" id="analyze-upload-zone">
              <input type="file" id="analyze-resume-input" accept=".pdf,.doc,.docx">
              <div class="upload-icon">üìÑ</div>
              <div style="color: #94a3b8;">Drop resume or click to browse</div>
              <div class="file-name" id="analyze-file-name"></div>
            </div>
          </div>
          <div>
            <label style="font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 8px;">Job Description</label>
            <textarea id="job-description" placeholder="Paste the complete job description here..."></textarea>
          </div>
        </div>
        
        <button class="btn btn-primary btn-full mt-4" id="analyze-btn" disabled>
          <span id="analyze-btn-text">üéØ Analyze My Match</span>
          <span class="loading" id="analyze-loading" style="display:none"></span>
        </button>
      </div>
      
      <!-- Analysis Results -->
      <div id="analysis-results" style="display:none">
        <!-- Filled by JS -->
      </div>
    </section>
    
    <!-- TAB 2: FIND JOBS -->
    <section class="section" id="tab-search">
      <!-- Upload Profile First -->
      <div class="card" id="search-upload-card">
        <div class="card-header">
          <h2 class="card-title">üíº Upload Resume to Find Matching Jobs</h2>
          <p class="card-subtitle">We'll analyze your profile and find jobs ranked by how well YOU match</p>
        </div>
        
        <div class="upload-zone" id="search-upload-zone">
          <input type="file" id="search-resume-input" accept=".pdf,.doc,.docx">
          <div class="upload-icon">üìÑ</div>
          <div style="color: #94a3b8;">Drop resume or click to browse</div>
          <div class="file-name" id="search-file-name"></div>
        </div>
        
        <button class="btn btn-primary btn-full mt-4" id="extract-btn" disabled>
          <span id="extract-btn-text">Extract My Profile & Find Jobs</span>
          <span class="loading" id="extract-loading" style="display:none"></span>
        </button>
      </div>
      
      <!-- Profile Display -->
      <div class="card" id="profile-card" style="display:none">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 id="profile-name">Your Name</h3>
            <p class="text-muted" id="profile-title">Your Title</p>
          </div>
          <button class="btn btn-primary" id="search-jobs-btn">
            <span id="search-btn-text">üîç Search Jobs</span>
            <span class="loading" id="search-loading" style="display:none"></span>
          </button>
        </div>
        
        <div class="flex gap-2 flex-wrap mb-4">
          <span class="tag tag-info" id="profile-exp">- years</span>
          <span class="tag tag-info" id="profile-level">-</span>
          <span class="tag tag-info" id="profile-location">-</span>
        </div>
        
        <div class="flex gap-4 mb-4">
          <input type="text" class="input" id="search-query" placeholder="Job title or keywords..." style="flex:1">
          <input type="text" class="input" id="search-location" placeholder="Location" style="width:150px">
        </div>
        
        <div>
          <label style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px; display: block;">Your Skills:</label>
          <div id="profile-skills" class="flex gap-2 flex-wrap"></div>
        </div>
      </div>
      
      <!-- Job Results -->
      <div id="job-results" style="display:none">
        <!-- FRESH JOBS AT TOP -->
        <div class="card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.05)); border-color: rgba(245, 158, 11, 0.3);">
          <h3 style="color: #f59e0b; margin-bottom: 8px;">üî• Fresh Jobs from Company Career Pages</h3>
          <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 16px;">Search directly from ATS systems (Workday, Greenhouse, Lever, etc.) - Real job postings!</p>
          
          <div id="fresh-jobs-links" class="flex gap-2 flex-wrap mb-4"></div>
          
          <div class="flex gap-2 flex-wrap">
            <div id="fresh-jobs-all"></div>
            <div id="fresh-jobs-24h"></div>
          </div>
        </div>
        
        <!-- Smart Search Links -->
        <div class="card" id="search-links-card">
          <h3 class="mb-4">üîó Job Board Search Links</h3>
          <p class="text-muted mb-4">Click to search major job boards with your profile:</p>
          
          <div id="primary-links" class="flex gap-4 flex-wrap mb-4"></div>
          
          <div class="divider"></div>
          
          <div class="search-links-grid">
            <div>
              <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üéØ Search by Your Target Roles</h4>
              <div id="title-links"></div>
            </div>
            <div>
              <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üí° Search by Your Skills</h4>
              <div id="skill-links" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üåê General Job Boards</h4>
          <div id="secondary-links" class="flex gap-2 flex-wrap mb-4"></div>
          
          <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üíª Tech & Startups</h4>
          <div id="tech-links" class="flex gap-2 flex-wrap mb-4"></div>
          
          <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">üè† Remote Jobs</h4>
          <div id="remote-links" class="flex gap-2 flex-wrap"></div>
        </div>
        
        <!-- AI Suggestions -->
        <div id="suggestions-section" style="display: none;">
          <div class="flex justify-between items-center mb-4">
            <h3>üí° Suggested Matches (<span id="jobs-count">0</span>)</h3>
            <div class="flex gap-2">
              <button class="btn btn-sm btn-secondary filter-btn active" data-filter="all">All</button>
              <button class="btn btn-sm btn-secondary filter-btn" data-filter="excellent">üü¢ Best</button>
              <button class="btn btn-sm btn-secondary filter-btn" data-filter="good">üîµ Good</button>
            </div>
          </div>
          <p class="text-muted mb-4" style="font-size: 0.9rem;">Based on your profile, here are roles worth exploring:</p>
          <div id="job-list"></div>
        </div>
      </div>
    </section>
    
    <!-- TAB 3: TRACKER -->
    <section class="section" id="tab-tracker">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìã Application Tracker</h2>
          <p class="card-subtitle">Track your job applications in one place</p>
        </div>
        
        <div class="tracker-stats">
          <div class="stat-card"><div class="stat-number saved" id="stat-saved">0</div><div class="stat-label">Saved</div></div>
          <div class="stat-card"><div class="stat-number applied" id="stat-applied">0</div><div class="stat-label">Applied</div></div>
          <div class="stat-card"><div class="stat-number interview" id="stat-interview">0</div><div class="stat-label">Interview</div></div>
          <div class="stat-card"><div class="stat-number" style="color:#ef4444" id="stat-rejected">0</div><div class="stat-label">Rejected</div></div>
        </div>
      </div>
      
      <div id="saved-jobs-list">
        <div class="empty-state" id="no-saved-jobs">
          <div class="icon">üìã</div>
          <h3>No Saved Jobs Yet</h3>
          <p>Save jobs from search results to track them here</p>
        </div>
      </div>
    </section>

    <!-- Networking (ICA) Section -->
    <section class="section" id="tab-networking">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üë• Ideal Contact Advocates (ICA)</h2>
          <p class="card-subtitle">Import and categorize your LinkedIn contacts by opportunity potential</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-zone" id="ica-dropzone" style="margin-top: 20px;">
          <div class="upload-icon">üìÑ</div>
          <h3>Drag & drop your LinkedIn Connections.csv</h3>
          <p>or <span class="browse" style="color: #6366f1; cursor: pointer;">browse files</span></p>
          <input type="file" id="ica-file-input" accept=".csv" style="display: none;">
        </div>

        <div id="ica-file-preview" style="display: none; margin-top: 16px; padding: 12px; background: #1e1e2e; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
          <span id="ica-filename" style="flex: 1;">Connections.csv</span>
          <button id="ica-upload-btn" class="btn btn-primary btn-sm">Upload & Analyze</button>
          <button id="ica-cancel-btn" class="btn btn-secondary btn-sm">Cancel</button>
        </div>

        <div id="ica-status" style="margin-top: 12px; padding: 12px; border-radius: 8px; display: none;"></div>
      </div>

      <!-- Stats Card -->
      <div class="card" id="ica-stats-card" style="display: none; margin-top: 20px;">
        <div class="card-header">
          <h3 class="card-title">Contact Statistics</h3>
        </div>
        <div class="grid-2" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
          <div class="stat-card"><div class="stat-number" id="ica-stat-total">0</div><div class="stat-label">Total Contacts</div></div>
          <div class="stat-card"><div class="stat-number" style="color: #22c55e;" id="ica-stat-high">0</div><div class="stat-label">High Potential</div></div>
          <div class="stat-card"><div class="stat-number" style="color: #f59e0b;" id="ica-stat-medium">0</div><div class="stat-label">Medium Potential</div></div>
          <div class="stat-card"><div class="stat-number" style="color: #64748b;" id="ica-stat-low">0</div><div class="stat-label">Low Potential</div></div>
        </div>
      </div>

      <!-- Contacts Table -->
      <div class="card" id="ica-contacts-card" style="display: none; margin-top: 20px;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <div>
            <h3 class="card-title">Your Contacts</h3>
            <p class="card-subtitle">Categorize by interview opportunity potential</p>
          </div>
          <div style="display: flex; gap: 12px;">
            <input type="text" id="ica-search" placeholder="Search..." style="padding: 8px 12px; border: 1px solid #2e2e3e; border-radius: 8px; background: #1e1e2e; color: #e2e8f0;">
            <select id="ica-filter" style="padding: 8px 12px; border: 1px solid #2e2e3e; border-radius: 8px; background: #1e1e2e; color: #e2e8f0;">
              <option value="all">All Categories</option>
              <option value="high_potential">High Potential</option>
              <option value="medium_potential">Medium Potential</option>
              <option value="low_potential">Low Potential</option>
              <option value="uncategorized">Uncategorized</option>
            </select>
          </div>
        </div>

        <div style="overflow-x: auto; margin-top: 16px;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid #2e2e3e;">
                <th style="padding: 12px; text-align: left; color: #94a3b8; font-weight: 500;">Name</th>
                <th style="padding: 12px; text-align: left; color: #94a3b8; font-weight: 500;">Company</th>
                <th style="padding: 12px; text-align: left; color: #94a3b8; font-weight: 500;">Position</th>
                <th style="padding: 12px; text-align: left; color: #94a3b8; font-weight: 500;">Category</th>
                <th style="padding: 12px; text-align: left; color: #94a3b8; font-weight: 500;">Connected</th>
                <th style="padding: 12px; text-align: left; color: #94a3b8; font-weight: 500;">Notes</th>
                <th style="padding: 12px; text-align: left; color: #94a3b8; font-weight: 500;">Actions</th>
              </tr>
            </thead>
            <tbody id="ica-contacts-tbody">
              <tr>
                <td colspan="7" style="padding: 40px; text-align: center; color: #64748b;">
                  Upload your LinkedIn Connections CSV to get started
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Cover Letter Modal -->
  <div class="cl-modal" id="cover-letter-modal">
    <div class="cl-modal-content">
      <div class="cl-modal-header">
        <div>
          <h3>üìù Cover Letter</h3>
          <p class="text-muted" id="cl-job-info">For: Job at Company</p>
        </div>
        <button class="cl-modal-close" onclick="closeCoverLetterModal()">√ó</button>
      </div>
      <div class="cl-modal-body">
        <div class="cover-letter-box" id="cover-letter-text">Generating...</div>
        <div class="flex gap-2 mt-4">
          <button class="btn btn-primary" onclick="copyCoverLetter()">üìã Copy</button>
          <button class="btn btn-secondary" onclick="regenerateCoverLetter()">üîÑ Regenerate</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

<script>
// ========== AUTH & USER STATE ==========
let currentUser = JSON.parse(localStorage.getItem('jobmatch_user') || 'null');

// Initialize auth UI on page load
function initAuth() {
  if (currentUser) {
    document.getElementById('auth-buttons').style.display = 'none';
    document.getElementById('user-menu').style.display = 'flex';
    document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
    document.getElementById('user-display-name').textContent = currentUser.name.split(' ')[0];
    
    // Load saved resume if exists
    loadSavedUserData();
  }
}

function showAuthModal(mode) {
  const modal = document.getElementById('auth-modal');
  if (modal) {
    modal.classList.add('show');
    modal.style.display = 'flex'; // Fallback
    switchAuthMode(mode);
  }
}

function hideAuthModal() {
  const modal = document.getElementById('auth-modal');
  if (modal) {
    modal.classList.remove('show');
    modal.style.display = 'none'; // Fallback
  }
  const loginErr = document.getElementById('login-error');
  const signupErr = document.getElementById('signup-error');
  if (loginErr) loginErr.style.display = 'none';
  if (signupErr) signupErr.style.display = 'none';
}

function switchAuthMode(mode) {
  if (mode === 'login') {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('signup-form').style.display = 'none';
  } else {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('signup-form').style.display = 'block';
  }
}

function handleSignup(e) {
  e.preventDefault();
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim().toLowerCase();
  const password = document.getElementById('signup-password').value;
  
  // Check if user exists
  const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
  if (users[email]) {
    document.getElementById('signup-error').textContent = 'Email already registered. Please log in.';
    document.getElementById('signup-error').style.display = 'block';
    return;
  }
  
  // Create user
  const user = {
    name,
    email,
    password: btoa(password), // Simple encoding (not secure, but ok for demo)
    createdAt: Date.now(),
    savedResumes: [],
    savedCoverLetters: [],
    savedProfile: null
  };
  
  users[email] = user;
  localStorage.setItem('jobmatch_users', JSON.stringify(users));

  // Log in the user
  currentUser = user;
  localStorage.setItem('jobmatch_user', JSON.stringify(user));

  // Ensure sessionId is created for new user
  if (!sessionId) {
    sessionId = 'user_' + btoa(email).replace(/=/g, '') + '_' + Date.now();
    localStorage.setItem('jobmatch_session', sessionId);
  }

  hideAuthModal();
  initAuth();
  showToast(`Welcome, ${name.split(' ')[0]}! Your account has been created.`, 'success');
}

function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value.trim().toLowerCase();
  const password = document.getElementById('login-password').value;
  
  const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
  const user = users[email];
  
  if (!user || user.password !== btoa(password)) {
    document.getElementById('login-error').textContent = 'Invalid email or password.';
    document.getElementById('login-error').style.display = 'block';
    return;
  }
  
  // Log in
  currentUser = user;
  localStorage.setItem('jobmatch_user', JSON.stringify(user));

  // Ensure sessionId is created/restored after login
  if (!sessionId) {
    sessionId = 'user_' + btoa(email).replace(/=/g, '') + '_' + Date.now();
    localStorage.setItem('jobmatch_session', sessionId);
  }

  hideAuthModal();
  initAuth();
  showToast(`Welcome back, ${user.name.split(' ')[0]}!`, 'success');
}

function logout() {
  currentUser = null;
  localStorage.removeItem('jobmatch_user');
  document.getElementById('auth-buttons').style.display = 'flex';
  document.getElementById('user-menu').style.display = 'none';
  document.getElementById('user-dropdown').classList.remove('show');
  showToast('Logged out successfully', 'success');
}

// ========== GOOGLE OAUTH ==========
const GOOGLE_CLIENT_ID = '1003386519443-uenaqfp471k2lp69chptqi4t7gqp6dfd.apps.googleusercontent.com';

function initGoogleSignIn() {
  if (typeof google !== 'undefined' && google.accounts) {
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleGoogleSignIn,
      auto_select: false
    });
  }
}

function signInWithGoogle() {
  if (typeof google !== 'undefined' && google.accounts) {
    google.accounts.id.prompt((notification) => {
      if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
        // Fallback to popup
        try {
          google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: 'email profile',
            callback: (response) => {
              if (response.access_token) {
                fetchGoogleUserInfo(response.access_token);
              }
            }
          }).requestAccessToken();
        } catch (e) {
          showToast('Google Sign-In failed. Try again.', 'error');
        }
      }
    });
  } else {
    showToast('Google Sign-In loading... Try again in a moment.', 'error');
  }
}

function handleGoogleSignIn(response) {
  // Decode JWT token
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  const { email, name, picture, sub: googleId } = payload;
  
  completeGoogleAuth(email, name, picture, googleId);
}

function fetchGoogleUserInfo(accessToken) {
  fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
    headers: { Authorization: `Bearer ${accessToken}` }
  })
  .then(res => res.json())
  .then(data => {
    completeGoogleAuth(data.email, data.name, data.picture, data.id);
  })
  .catch(err => {
    showToast('Failed to get Google user info', 'error');
  });
}

function completeGoogleAuth(email, name, picture, googleId) {
  const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');

  let user = users[email];
  if (!user) {
    // Create new user
    user = {
      name,
      email,
      picture,
      googleId,
      authProvider: 'google',
      createdAt: Date.now(),
      savedResumes: [],
      savedCoverLetters: [],
      savedProfile: null
    };
    users[email] = user;
    localStorage.setItem('jobmatch_users', JSON.stringify(users));
    showToast(`Welcome, ${name.split(' ')[0]}! Account created with Google.`, 'success');
  } else {
    // Update existing user with Google info
    user.picture = picture;
    user.googleId = googleId;
    user.authProvider = 'google';
    users[email] = user;
    localStorage.setItem('jobmatch_users', JSON.stringify(users));
    showToast(`Welcome back, ${name.split(' ')[0]}!`, 'success');
  }

  currentUser = user;
  localStorage.setItem('jobmatch_user', JSON.stringify(user));

  // CRITICAL FIX: Ensure sessionId is created/restored after Google login
  if (!sessionId) {
    // Create a new session tied to the user's email
    sessionId = 'user_' + btoa(email).replace(/=/g, '') + '_' + Date.now();
    localStorage.setItem('jobmatch_session', sessionId);
  }

  hideAuthModal();
  initAuth();
}

// Initialize Google Sign-In when ready
if (document.readyState === 'complete') {
  initGoogleSignIn();
} else {
  window.addEventListener('load', initGoogleSignIn);
}

function toggleUserDropdown() {
  document.getElementById('user-dropdown').classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown')) {
    document.getElementById('user-dropdown')?.classList.remove('show');
  }
  // Close auth modal when clicking overlay (not the modal itself)
  if (e.target.id === 'auth-modal') {
    hideAuthModal();
  }
  if (e.target.id === 'my-data-modal') {
    hideMyDataModal();
  }
  if (e.target.id === 'cover-letters-modal') {
    hideCoverLettersModal();
  }
});

// ========== USER DATA PERSISTENCE ==========
function saveUserResume(resumeText, fileName, profileData, fileBase64 = null) {
  if (!currentUser) return;
  
  const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
  const user = users[currentUser.email];
  
  if (user) {
    // Save latest resume
    user.savedProfile = profileData;
    user.lastResumeText = resumeText;
    user.lastResumeFileName = fileName;
    user.lastResumeDate = Date.now();
    if (fileBase64) {
      user.lastResumeBase64 = fileBase64; // Store actual file for re-upload
    }
    
    // Keep history (max 3 resumes with full data)
    if (!user.savedResumes) user.savedResumes = [];
    
    // Check if this resume already exists (by name)
    const existingIdx = user.savedResumes.findIndex(r => r.fileName === fileName);
    if (existingIdx >= 0) {
      user.savedResumes.splice(existingIdx, 1);
    }
    
    user.savedResumes.unshift({
      id: Date.now(),
      fileName,
      resumeText: resumeText.substring(0, 1000), // Store preview
      profile: profileData,
      fileBase64: fileBase64, // Store full file
      savedAt: Date.now()
    });
    user.savedResumes = user.savedResumes.slice(0, 3); // Max 3 full resumes
    
    users[currentUser.email] = user;
    localStorage.setItem('jobmatch_users', JSON.stringify(users));
    currentUser = user;
    localStorage.setItem('jobmatch_user', JSON.stringify(user));
  }
}

// Convert file to base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Convert base64 back to File object
function base64ToFile(base64, fileName) {
  const arr = base64.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n);
  }
  return new File([u8arr], fileName, { type: mime });
}

function saveCoverLetter(coverLetter, jobTitle, companyName) {
  if (!currentUser) {
    showToast('Log in to save cover letters', 'error');
    return false;
  }
  
  const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
  const user = users[currentUser.email];
  
  if (user) {
    if (!user.savedCoverLetters) user.savedCoverLetters = [];
    user.savedCoverLetters.unshift({
      id: Date.now(),
      coverLetter,
      jobTitle: jobTitle || 'Unknown Role',
      companyName: companyName || 'Unknown Company',
      savedAt: Date.now()
    });
    user.savedCoverLetters = user.savedCoverLetters.slice(0, 20); // Max 20
    
    users[currentUser.email] = user;
    localStorage.setItem('jobmatch_users', JSON.stringify(users));
    currentUser = user;
    localStorage.setItem('jobmatch_user', JSON.stringify(user));
    return true;
  }
  return false;
}

function loadSavedUserData() {
  if (!currentUser || !currentUser.savedProfile) return;
  
  // Auto-load profile into Find Jobs tab
  profile = currentUser.savedProfile;
  sessionId = localStorage.getItem('jobmatch_session') || 'user_' + Date.now();
  localStorage.setItem('jobmatch_session', sessionId);
}

function showMyData() {
  document.getElementById('user-dropdown').classList.remove('show');
  
  const content = document.getElementById('my-data-content');
  
  if (!currentUser) {
    content.innerHTML = '<p style="color: #64748b;">Please log in to see your saved data.</p>';
  } else if (!currentUser.savedResumes || currentUser.savedResumes.length === 0) {
    content.innerHTML = `
      <p style="color: #64748b; margin-bottom: 16px;">No saved resumes yet.</p>
      <p style="color: #94a3b8; font-size: 0.9rem;">Upload a resume in the "Analyze Resume" or "Find Jobs" tab and it will be saved automatically.</p>
    `;
  } else {
    const resumes = currentUser.savedResumes || [];
    content.innerHTML = `
      <div class="saved-indicator">
        <div class="icon">üìÑ</div>
        <div class="text">${resumes.length} saved resume${resumes.length > 1 ? 's' : ''}</div>
      </div>
      
      <h4 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px;">Your Saved Resumes</h4>
      
      ${resumes.map((r, idx) => `
        <div style="background: #1e1e2e; padding: 16px; border-radius: 10px; margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
            <div>
              <h4 style="font-size: 0.95rem; margin-bottom: 4px;">üìé ${r.fileName}</h4>
              <p style="font-size: 0.8rem; color: #64748b;">Saved ${new Date(r.savedAt).toLocaleDateString()}</p>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="deleteSavedResume(${idx})" style="padding: 4px 8px;">üóëÔ∏è</button>
          </div>
          ${r.profile ? `
            <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 8px;">${r.profile.name || ''} ‚Ä¢ ${r.profile.currentTitle || ''}</p>
            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">
              ${(r.profile.hardSkills || []).slice(0, 5).map(s => `<span class="tag tag-info" style="font-size: 0.7rem; padding: 2px 6px;">${s}</span>`).join('')}
            </div>
          ` : ''}
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-primary btn-sm" onclick="useSavedResume(${idx}, 'analyze')">üîç Analyze</button>
            <button class="btn btn-secondary btn-sm" onclick="useSavedResume(${idx}, 'search')">üíº Find Jobs</button>
          </div>
        </div>
      `).join('')}
      
      <button class="btn btn-secondary btn-full" style="margin-top: 8px;" onclick="clearSavedData()">üóëÔ∏è Clear All Data</button>
    `;
  }
  
  document.getElementById('my-data-modal').classList.add('show');
}

function hideMyDataModal() {
  document.getElementById('my-data-modal').classList.remove('show');
}

function useStoredProfile() {
  if (currentUser && currentUser.savedProfile) {
    profile = currentUser.savedProfile;
    
    // Switch to Find Jobs tab and show profile
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="search"]').classList.add('active');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('tab-search').classList.add('active');
    
    // Display profile
    displayProfile(profile);
    document.getElementById('search-upload-card').style.display = 'none';
    document.getElementById('profile-card').style.display = 'block';
    
    hideMyDataModal();
    showToast('Profile loaded! Click "Search Jobs" to find matches.', 'success');
  }
}

function clearSavedData() {
  if (!currentUser) return;
  if (!confirm('Are you sure you want to clear all saved data?')) return;
  
  const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
  const user = users[currentUser.email];
  
  if (user) {
    user.savedProfile = null;
    user.lastResumeText = null;
    user.lastResumeFileName = null;
    user.savedResumes = [];
    user.lastResumeBase64 = null;
    
    users[currentUser.email] = user;
    localStorage.setItem('jobmatch_users', JSON.stringify(users));
    currentUser = user;
    localStorage.setItem('jobmatch_user', JSON.stringify(user));
  }
  
  hideMyDataModal();
  showToast('Saved data cleared', 'success');
}

function deleteSavedResume(index) {
  if (!currentUser) return;
  if (!confirm('Delete this saved resume?')) return;
  
  const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
  const user = users[currentUser.email];
  
  if (user && user.savedResumes) {
    user.savedResumes.splice(index, 1);
    users[currentUser.email] = user;
    localStorage.setItem('jobmatch_users', JSON.stringify(users));
    currentUser = user;
    localStorage.setItem('jobmatch_user', JSON.stringify(user));
    
    showMyData(); // Refresh
    showToast('Resume deleted', 'success');
  }
}

async function useSavedResume(index, mode) {
  if (!currentUser || !currentUser.savedResumes || !currentUser.savedResumes[index]) {
    showToast('Resume not found', 'error');
    return;
  }
  
  const savedResume = currentUser.savedResumes[index];
  
  hideMyDataModal();
  
  if (mode === 'analyze') {
    // Switch to Analyze tab
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="analyze"]').classList.add('active');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('tab-analyze').classList.add('active');
    
    if (savedResume.fileBase64) {
      // Convert base64 back to file and set it
      analyzeFile = base64ToFile(savedResume.fileBase64, savedResume.fileName);
      document.getElementById('analyze-file-name').textContent = '‚úì ' + savedResume.fileName + ' (saved)';
      document.getElementById('analyze-upload-zone').classList.add('has-file');
      checkAnalyzeReady();
      showToast('Resume loaded! Paste a job description and click Analyze.', 'success');
    } else {
      showToast('Resume file not available. Please re-upload.', 'error');
    }
  } else if (mode === 'search') {
    // Switch to Find Jobs tab
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="search"]').classList.add('active');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('tab-search').classList.add('active');
    
    if (savedResume.profile) {
      // Use saved profile directly
      profile = savedResume.profile;
      sessionId = localStorage.getItem('jobmatch_session') || 'user_' + Date.now();
      localStorage.setItem('jobmatch_session', sessionId);
      
      displayProfile();
      document.getElementById('search-upload-card').style.display = 'none';
      document.getElementById('profile-card').style.display = 'block';
      
      showToast('Profile loaded! Click "Search Jobs" to find matches.', 'success');
    } else if (savedResume.fileBase64) {
      // Re-extract profile from saved file
      searchFile = base64ToFile(savedResume.fileBase64, savedResume.fileName);
      document.getElementById('search-file-name').textContent = '‚úì ' + savedResume.fileName + ' (saved)';
      document.getElementById('search-upload-zone').classList.add('has-file');
      document.getElementById('extract-btn').disabled = false;
      showToast('Resume loaded! Click "Extract My Profile" to continue.', 'success');
    } else {
      showToast('Resume data not available. Please re-upload.', 'error');
    }
  }
}

function showMyCoverLetters() {
  document.getElementById('user-dropdown').classList.remove('show');
  
  const content = document.getElementById('cover-letters-content');
  
  if (!currentUser) {
    content.innerHTML = '<p style="color: #64748b;">Please log in to see your cover letters.</p>';
  } else if (!currentUser.savedCoverLetters || currentUser.savedCoverLetters.length === 0) {
    content.innerHTML = `
      <p style="color: #64748b; margin-bottom: 16px;">No saved cover letters yet.</p>
      <p style="color: #94a3b8; font-size: 0.9rem;">Generate a cover letter in the "Analyze Resume" tab and save it.</p>
    `;
  } else {
    content.innerHTML = currentUser.savedCoverLetters.map((cl, i) => `
      <div style="background: #1e1e2e; padding: 16px; border-radius: 10px; margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div>
            <h4 style="font-size: 0.95rem;">${cl.jobTitle}</h4>
            <p style="font-size: 0.85rem; color: #64748b;">${cl.companyName} ‚Ä¢ ${new Date(cl.savedAt).toLocaleDateString()}</p>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary btn-sm" onclick="copySavedCoverLetter(${i})">üìã Copy</button>
            <button class="btn btn-secondary btn-sm" onclick="deleteCoverLetter(${i})">üóëÔ∏è</button>
          </div>
        </div>
        <div style="background: #0a0a0f; padding: 12px; border-radius: 8px; max-height: 150px; overflow-y: auto; font-size: 0.85rem; color: #94a3b8; white-space: pre-wrap;">${cl.coverLetter.substring(0, 400)}${cl.coverLetter.length > 400 ? '...' : ''}</div>
      </div>
    `).join('');
  }
  
  document.getElementById('cover-letters-modal').classList.add('show');
}

function hideCoverLettersModal() {
  document.getElementById('cover-letters-modal').classList.remove('show');
}

function copySavedCoverLetter(index) {
  if (currentUser && currentUser.savedCoverLetters && currentUser.savedCoverLetters[index]) {
    navigator.clipboard.writeText(currentUser.savedCoverLetters[index].coverLetter).then(() => {
      showToast('Cover letter copied!', 'success');
    });
  }
}

function deleteCoverLetter(index) {
  if (!currentUser) return;
  if (!confirm('Delete this cover letter?')) return;
  
  const users = JSON.parse(localStorage.getItem('jobmatch_users') || '{}');
  const user = users[currentUser.email];
  
  if (user && user.savedCoverLetters) {
    user.savedCoverLetters.splice(index, 1);
    users[currentUser.email] = user;
    localStorage.setItem('jobmatch_users', JSON.stringify(users));
    currentUser = user;
    localStorage.setItem('jobmatch_user', JSON.stringify(user));
    
    showMyCoverLetters(); // Refresh the modal
    showToast('Cover letter deleted', 'success');
  }
}

// Initialize auth on page load
document.addEventListener('DOMContentLoaded', initAuth);

// ========== EXISTING STATE ==========
// State
let sessionId = localStorage.getItem('jobmatch_session');
let profile = null;
let jobs = [];
let savedJobs = [];
let currentJob = null;
let analyzeFile = null;
let searchFile = null;

// Tab Navigation
document.querySelectorAll('.main-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
  });
});

// ========== ANALYZE TAB ==========
const analyzeZone = document.getElementById('analyze-upload-zone');
const analyzeInput = document.getElementById('analyze-resume-input');
const analyzeBtn = document.getElementById('analyze-btn');
const jobDescInput = document.getElementById('job-description');

analyzeZone.addEventListener('click', () => analyzeInput.click());
analyzeZone.addEventListener('dragover', e => { e.preventDefault(); analyzeZone.style.borderColor = '#6366f1'; });
analyzeZone.addEventListener('dragleave', () => { analyzeZone.style.borderColor = analyzeFile ? '#10b981' : '#2e2e3e'; });
analyzeZone.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files[0]) handleAnalyzeFile(e.dataTransfer.files[0]); });
analyzeInput.addEventListener('change', e => { if (e.target.files[0]) handleAnalyzeFile(e.target.files[0]); });

function handleAnalyzeFile(file) {
  if (!file.name.match(/\.(pdf|doc|docx)$/i)) { showToast('Please upload PDF or Word', 'error'); return; }
  analyzeFile = file;
  document.getElementById('analyze-file-name').textContent = '‚úì ' + file.name;
  analyzeZone.classList.add('has-file');
  checkAnalyzeReady();
}

jobDescInput.addEventListener('input', checkAnalyzeReady);
function checkAnalyzeReady() {
  analyzeBtn.disabled = !(analyzeFile && jobDescInput.value.trim().length > 50);
}

analyzeBtn.addEventListener('click', async () => {
  setLoading('analyze', true, 'Analyzing (15-20 sec)...');
  
  try {
    const formData = new FormData();
    formData.append('resume', analyzeFile);
    formData.append('jobDescription', jobDescInput.value.trim());
    
    const res = await fetch('/api/analyze-match', { method: 'POST', body: formData });
    const data = await res.json();
    
    if (!data.success) throw new Error(data.error);
    
    // IMPORTANT: Capture sessionId from response
    if (data.sessionId) {
      sessionId = data.sessionId;
      localStorage.setItem('jobmatch_session', sessionId);
    }
    
    lastAnalysisData = data.data; // Store for cover letter generation
    
    // Save resume for logged-in users
    if (currentUser && analyzeFile) {
      try {
        const fileBase64 = await fileToBase64(analyzeFile);
        const profile = data.data.profile || { name: 'User', currentTitle: 'Professional' };
        saveUserResume(data.data.resumeText || '', analyzeFile.name, profile, fileBase64);
      } catch (e) {
        console.log('Could not save resume:', e);
      }
    }
    
    displayAnalysisResults(data.data);
    
  } catch (err) {
    showToast(err.message, 'error');
  } finally {
    setLoading('analyze', false, 'üéØ Analyze My Match');
  }
});

function displayAnalysisResults(d) {
  const score = d.overallScore || 0;
  const scoreClass = score >= 70 ? 'high' : score >= 50 ? 'medium' : 'low';
  const heroClass = score >= 70 ? 'strong' : score >= 50 ? 'moderate' : 'weak';
  
  document.getElementById('analysis-results').style.display = 'block';
  document.getElementById('analysis-results').innerHTML = `
    <div class="score-hero ${heroClass}">
      <div class="score-ring ${scoreClass}">
        <div class="score-number">${score}%</div>
        <div class="score-label">Match</div>
      </div>
      <div class="verdict-badge ${scoreClass}">${d.verdict || 'ANALYZED'}</div>
      <p style="color:#94a3b8; max-width:600px; margin:0 auto;">${d.summary || ''}</p>
    </div>
    
    <div class="card">
      <div class="flex justify-between items-center mb-4">
        <span>Interview Probability</span>
        <span style="font-size:1.5rem; font-weight:700;" class="${scoreClass === 'high' ? 'text-success' : scoreClass === 'medium' ? 'text-warning' : 'text-danger'}">${d.interviewProbability?.percentage || 0}%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill ${scoreClass}" style="width:${d.interviewProbability?.percentage || 0}%"></div></div>
      <p class="text-muted" style="font-size:0.9rem;">${d.interviewProbability?.reasoning || ''}</p>
      ${d.interviewProbability?.whatWouldIncreaseOdds ? `<div class="item success mt-4"><div class="item-title">üí° To increase your odds:</div><div class="item-desc">${d.interviewProbability.whatWouldIncreaseOdds}</div></div>` : ''}
    </div>
    
    <div class="grid-2">
      <div>
        <div class="analysis-card">
          <h4>üëÅÔ∏è 6-Second Scan</h4>
          <div class="flex items-center gap-4 mb-4">
            <span style="font-size:2rem;">${d.sixSecondScan?.wouldReadMore === true ? '‚úÖ' : d.sixSecondScan?.wouldReadMore === false ? '‚ùå' : 'ü§î'}</span>
            <div>
              <div style="font-weight:600;">${d.sixSecondScan?.wouldReadMore === true ? 'They\'d keep reading!' : d.sixSecondScan?.wouldReadMore === false ? 'Probably not...' : 'Borderline'}</div>
              <div class="text-muted" style="font-size:0.9rem;">${d.sixSecondScan?.whyOrWhyNot || ''}</div>
            </div>
          </div>
          <p class="text-muted" style="font-size:0.9rem;">${d.sixSecondScan?.firstImpression || ''}</p>
        </div>
        
        <div class="analysis-card">
          <h4>ü§ñ ATS Compatibility</h4>
          <div class="flex justify-between items-center mb-2">
            <span class="tag ${d.atsAnalysis?.likelyToPass ? 'tag-success' : 'tag-danger'}">${d.atsAnalysis?.likelyToPass ? '‚úì Likely to pass' : '‚úó Likely to fail'}</span>
            <span style="font-weight:700;">${d.atsAnalysis?.score || 0}%</span>
          </div>
          <div class="progress-bar"><div class="progress-fill ${(d.atsAnalysis?.score || 0) >= 70 ? 'high' : 'low'}" style="width:${d.atsAnalysis?.score || 0}%"></div></div>
          <div class="mb-4">
            <div style="font-size:0.8rem; color:#10b981; margin-bottom:6px;">‚úì Keywords found:</div>
            <div>${(d.atsAnalysis?.keywordsFound || []).map(k => `<span class="tag tag-success">${k}</span>`).join('') || '<span class="text-muted">None</span>'}</div>
          </div>
          <div>
            <div style="font-size:0.8rem; color:#ef4444; margin-bottom:6px;">‚úó Missing keywords:</div>
            <div>${(d.atsAnalysis?.criticalKeywordsMissing || []).map(k => `<span class="tag tag-danger">${k}</span>`).join('') || '<span class="text-muted">None</span>'}</div>
          </div>
          ${d.atsAnalysis?.suggestionToPassATS ? `<div class="item warning mt-4"><div class="item-title">üîß To pass ATS:</div><div class="item-desc">${d.atsAnalysis.suggestionToPassATS}</div></div>` : ''}
        </div>
        
        ${(d.hiddenRedFlags || []).length > 0 ? `
        <div class="analysis-card">
          <h4>üö© Hidden Red Flags</h4>
          ${d.hiddenRedFlags.map(f => `
            <div class="item warning">
              <div class="item-title">${f.issue}</div>
              <div class="item-desc">ü§î Recruiter thinks: "${f.whatRecruiterThinks}"</div>
              ${f.howToAddress ? `<div class="item-fix">üîß ${f.howToAddress}</div>` : ''}
            </div>
          `).join('')}
        </div>
        ` : ''}
      </div>
      
      <div>
        <div class="analysis-card">
          <h4>üìè Experience Gap</h4>
          <div class="grid-2 mb-4" style="gap:12px;">
            <div class="item"><div style="font-size:0.75rem; color:#64748b;">They want:</div><div>${d.qualificationGap?.experienceRequired || '-'}</div></div>
            <div class="item"><div style="font-size:0.75rem; color:#64748b;">You have:</div><div>${d.qualificationGap?.experienceYouHave || '-'}</div></div>
          </div>
          <span class="tag ${(d.qualificationGap?.gapAssessment || '').includes('GOOD') ? 'tag-success' : 'tag-warning'}">${(d.qualificationGap?.gapAssessment || 'Unknown').replace(/_/g, ' ')}</span>
          <p class="text-muted mt-4" style="font-size:0.9rem;">${d.qualificationGap?.yearsGap || ''}</p>
          ${d.qualificationGap?.howToCloseGap ? `<div class="item success mt-4"><div class="item-desc">${d.qualificationGap.howToCloseGap}</div></div>` : ''}
        </div>
        
        ${(d.dealbreakers || []).length > 0 ? `
        <div class="analysis-card">
          <h4>üõë Dealbreakers</h4>
          ${d.dealbreakers.map(db => `
            <div class="item danger">
              <div class="item-title">${db.requirement}</div>
              <div class="item-desc">Status: ${db.status}</div>
              ${db.urgentFix ? `<div class="item-fix">üîß ${db.urgentFix}</div>` : ''}
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        ${(d.strengths || []).length > 0 ? `
        <div class="analysis-card">
          <h4>üí™ Your Strengths</h4>
          ${d.strengths.map(s => `
            <div class="item success">
              <div class="item-title">${s.skill}</div>
              <div class="item-desc">${s.howItHelps}</div>
              ${s.howToHighlight ? `<div class="item-fix">üí° ${s.howToHighlight}</div>` : ''}
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        <div class="analysis-card">
          <h4>üë• Your Competition</h4>
          <div class="item mb-4"><div style="font-size:0.8rem; color:#64748b;">Typical winner:</div><div style="font-size:0.9rem;">${d.competitorAnalysis?.typicalWinningCandidate || '-'}</div></div>
          <div class="item mb-4"><div style="font-size:0.8rem; color:#64748b;">How you compare:</div><div style="font-size:0.9rem;">${d.competitorAnalysis?.howYouCompare || '-'}</div></div>
          <div class="grid-2" style="gap:8px;">
            <div class="item success"><div style="font-size:0.75rem; color:#10b981;">Your advantage:</div><div style="font-size:0.85rem;">${d.competitorAnalysis?.yourCompetitiveAdvantage || '-'}</div></div>
            <div class="item danger"><div style="font-size:0.75rem; color:#ef4444;">Your disadvantage:</div><div style="font-size:0.85rem;">${d.competitorAnalysis?.yourBiggestDisadvantage || '-'}</div></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h3 class="mb-4">üìã Action Plan</h3>
      <div class="grid-2">
        <div>
          <div style="color:#ef4444; font-size:0.85rem; font-weight:600; margin-bottom:8px;">üö® Before applying:</div>
          <ul class="action-list urgent">${(d.prioritizedActionPlan?.before_applying || []).map(a => `<li>${a}</li>`).join('') || '<li class="text-muted">None</li>'}</ul>
        </div>
        <div>
          <div style="color:#10b981; font-size:0.85rem; font-weight:600; margin-bottom:8px;">‚ö° Quick wins:</div>
          <ul class="action-list quick">${(d.prioritizedActionPlan?.quick_wins || []).map(a => `<li>${a}</li>`).join('') || '<li class="text-muted">None</li>'}</ul>
        </div>
      </div>
    </div>
    
    ${(d.resumeRewrites || []).length > 0 ? `
    <div class="card">
      <h3 class="mb-4">‚úçÔ∏è Suggested Rewrites</h3>
      ${d.resumeRewrites.map(r => `
        <div style="background:#1e1e2e; border-radius:10px; padding:16px; margin-bottom:12px;">
          <div style="font-size:0.8rem; color:#64748b; margin-bottom:8px;">${r.section || 'Resume section'}</div>
          <div style="font-size:0.75rem; color:#ef4444; margin-bottom:4px;">BEFORE:</div>
          <div style="background:#0a0a0f; padding:10px; border-radius:6px; text-decoration:line-through; color:#64748b;">${r.currentText}</div>
          <div style="font-size:0.75rem; color:#10b981; margin:12px 0 4px;">AFTER:</div>
          <div style="background:rgba(16,185,129,0.1); padding:10px; border-radius:6px;">${r.rewrittenText}</div>
          ${r.whyBetter ? `<div style="font-size:0.85rem; color:#64748b; margin-top:8px; font-style:italic;">Why: ${r.whyBetter}</div>` : ''}
        </div>
      `).join('')}
    </div>
    ` : ''}
    
    <div class="bottom-line">
      <h3>üí¨ The Bottom Line</h3>
      <p style="font-size:1.05rem; margin-bottom:16px; color:#e2e8f0;">${d.bottomLine?.honestAssessment || ''}</p>
      <div class="one-thing">
        <div class="one-thing-label">If you fix ONE thing, fix this:</div>
        <div class="one-thing-text">${d.bottomLine?.oneThingToFix || ''}</div>
      </div>
      <p class="encouragement">${d.bottomLine?.encouragement || ''}</p>
    </div>
    
    <!-- COVER LETTER GENERATOR -->
    <div class="card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05)); border-color: rgba(139, 92, 246, 0.3);">
      <h3 style="color: #a78bfa; margin-bottom: 8px;">‚úâÔ∏è Generate Killer Cover Letter</h3>
      <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 16px;">Create a highly specific cover letter that shows exactly why YOU are perfect for THIS role</p>
      <button class="btn btn-primary btn-full" id="generate-cover-letter-btn" style="background: linear-gradient(135deg, #8b5cf6, #3b82f6);">
        <span id="cover-letter-btn-text">‚úâÔ∏è Generate Cover Letter</span>
        <span class="loading" id="cover-letter-loading" style="display:none"></span>
      </button>
    </div>
    
    <!-- Cover Letter Output -->
    <div id="cover-letter-output" style="display:none">
      <div class="card">
        <div class="flex justify-between items-center mb-4">
          <h3>‚úâÔ∏è Your Personalized Cover Letter</h3>
          <div class="flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="copyCoverLetter()">üìã Copy</button>
            <button class="btn btn-primary btn-sm" onclick="saveCurrentCoverLetter()">üíæ Save</button>
          </div>
        </div>
        <div id="cover-letter-content" style="background: #0a0a0f; padding: 20px; border-radius: 10px; white-space: pre-wrap; font-family: Georgia, serif; line-height: 1.8; color: #e2e8f0;"></div>
      </div>
    </div>
  `;
  
  // Attach cover letter button listener
  setTimeout(() => {
    const clBtn = document.getElementById('generate-cover-letter-btn');
    if (clBtn) clBtn.addEventListener('click', generateAnalysisCoverLetter);
  }, 100);
  
  document.getElementById('analysis-results').scrollIntoView({ behavior: 'smooth' });
}

// ========== COVER LETTER GENERATOR (ANALYZE PAGE) ==========
let lastAnalysisData = null; // Store the analysis data for cover letter

async function generateAnalysisCoverLetter() {
  const jobDesc = document.getElementById('job-description').value.trim();
  if (!jobDesc) {
    showToast('Job description is required for cover letter', 'error');
    return;
  }

  if (!lastAnalysisData) {
    showToast('Please analyze your resume first', 'error');
    return;
  }

  // Ensure sessionId exists before generating cover letter
  if (!sessionId) {
    if (currentUser && currentUser.email) {
      sessionId = 'user_' + btoa(currentUser.email).replace(/=/g, '') + '_' + Date.now();
      localStorage.setItem('jobmatch_session', sessionId);
    } else {
      sessionId = 'temp_' + Date.now();
      localStorage.setItem('jobmatch_session', sessionId);
    }
  }

  // Show loading
  document.getElementById('cover-letter-btn-text').textContent = 'Generating...';
  document.getElementById('cover-letter-loading').style.display = 'inline-block';
  document.getElementById('generate-cover-letter-btn').disabled = true;

  try {
    const res = await fetch('/api/generate-specific-cover-letter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: sessionId,
        jobDescription: jobDesc,
        analysisData: lastAnalysisData
      })
    });
    
    const data = await res.json();
    
    if (!data.success) throw new Error(data.error || 'Generation failed');
    
    // Display the cover letter
    document.getElementById('cover-letter-content').textContent = data.data.coverLetter;
    document.getElementById('cover-letter-output').style.display = 'block';
    document.getElementById('cover-letter-output').scrollIntoView({ behavior: 'smooth' });
    
    showToast('Cover letter generated!', 'success');
    
  } catch (err) {
    console.error('Cover letter error:', err);
    showToast(String(err.message || 'Generation failed'), 'error');
  } finally {
    document.getElementById('cover-letter-btn-text').textContent = '‚úâÔ∏è Generate Cover Letter';
    document.getElementById('cover-letter-loading').style.display = 'none';
    document.getElementById('generate-cover-letter-btn').disabled = false;
  }
}

function copyCoverLetter() {
  const content = document.getElementById('cover-letter-content').textContent;
  navigator.clipboard.writeText(content).then(() => {
    showToast('Cover letter copied!', 'success');
  }).catch(() => {
    showToast('Failed to copy', 'error');
  });
}

function saveCurrentCoverLetter() {
  const content = document.getElementById('cover-letter-content').textContent;
  if (!content) {
    showToast('No cover letter to save', 'error');
    return;
  }
  
  // Extract job info from the job description
  const jobDesc = document.getElementById('job-description').value || '';
  
  // Try to extract company name
  const companyMatch = jobDesc.match(/(?:at|@|company[:\s]+|about[:\s]+)([A-Z][a-zA-Z0-9\s&]+?)(?:\.|,|\n|is|we|has)/i) ||
                       jobDesc.match(/([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+)?)\s+is\s+(?:seeking|hiring|looking)/i);
  const companyName = companyMatch ? companyMatch[1].trim() : 'Company';
  
  // Try to extract job title
  const titleMatch = jobDesc.match(/(?:title|position|role)[:\s]+([^\n]+)/i) ||
                     jobDesc.match(/(?:seeking|hiring|looking for)[:\s]+(?:an?\s+)?([^\n.]+)/i) ||
                     jobDesc.match(/^([A-Z][a-zA-Z\s]+(?:Engineer|Manager|Director|Developer|Architect|Lead|Analyst))/m);
  const jobTitle = titleMatch ? titleMatch[1].trim().substring(0, 50) : 'Job Role';
  
  if (saveCoverLetter(content, jobTitle, companyName)) {
    showToast('Cover letter saved! View in "My Cover Letters"', 'success');
  }
}

// ========== SEARCH TAB ==========
const searchZone = document.getElementById('search-upload-zone');
const searchInput = document.getElementById('search-resume-input');
const extractBtn = document.getElementById('extract-btn');

searchZone.addEventListener('click', () => searchInput.click());
searchZone.addEventListener('dragover', e => { e.preventDefault(); searchZone.style.borderColor = '#6366f1'; });
searchZone.addEventListener('dragleave', () => { searchZone.style.borderColor = searchFile ? '#10b981' : '#2e2e3e'; });
searchZone.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files[0]) handleSearchFile(e.dataTransfer.files[0]); });
searchInput.addEventListener('change', e => { if (e.target.files[0]) handleSearchFile(e.target.files[0]); });

function handleSearchFile(file) {
  if (!file.name.match(/\.(pdf|doc|docx)$/i)) { showToast('Please upload PDF or Word', 'error'); return; }
  searchFile = file;
  document.getElementById('search-file-name').textContent = '‚úì ' + file.name;
  searchZone.classList.add('has-file');
  extractBtn.disabled = false;
}

extractBtn.addEventListener('click', async () => {
  if (!searchFile) return;
  setLoading('extract', true, 'Extracting profile...');
  
  try {
    const formData = new FormData();
    formData.append('resume', searchFile);
    
    const res = await fetch('/api/extract-profile', { method: 'POST', body: formData });
    const data = await res.json();
    
    if (!data.success) throw new Error(data.error);
    
    sessionId = data.data.sessionId;
    profile = data.data.profile;
    localStorage.setItem('jobmatch_session', sessionId);
    
    // Auto-save profile and file if user is logged in
    if (currentUser) {
      try {
        const fileBase64 = await fileToBase64(searchFile);
        saveUserResume(data.data.resumeText || '', searchFile.name, profile, fileBase64);
        showToast('Profile extracted and saved to your account!', 'success');
      } catch (e) {
        saveUserResume(data.data.resumeText || '', searchFile.name, profile);
        showToast('Profile extracted and saved!', 'success');
      }
    } else {
      showToast('Profile extracted! Log in to save it.', 'success');
    }
    
    displayProfile();
    
  } catch (err) {
    showToast(err.message, 'error');
  } finally {
    setLoading('extract', false, 'Extract My Profile & Find Jobs');
  }
});

function displayProfile() {
  document.getElementById('search-upload-card').style.display = 'none';
  document.getElementById('profile-card').style.display = 'block';
  
  document.getElementById('profile-name').textContent = profile.name || 'Your Profile';
  document.getElementById('profile-title').textContent = profile.currentTitle || '';
  document.getElementById('profile-exp').textContent = `${profile.yearsExperience || '?'} years`;
  document.getElementById('profile-level').textContent = profile.experienceLevel || '';
  document.getElementById('profile-location').textContent = profile.location || '';
  document.getElementById('profile-skills').innerHTML = (profile.hardSkills || []).slice(0, 8).map(s => `<span class="tag tag-info">${s}</span>`).join('');
  
  if (profile.targetTitles?.[0]) document.getElementById('search-query').value = profile.targetTitles[0];
  if (profile.location) document.getElementById('search-location').value = profile.location;
}

document.getElementById('search-jobs-btn').addEventListener('click', searchJobs);
document.getElementById('search-query').addEventListener('keypress', e => { if (e.key === 'Enter') searchJobs(); });

async function searchJobs() {
  if (!sessionId || !profile) { showToast('Upload resume first', 'error'); return; }
  
  // Generate links INSTANTLY (client-side, no API)
  const searchLinks = generateSearchLinksClientSide();
  displaySearchLinks(searchLinks);
  document.getElementById('job-results').style.display = 'block';
  document.getElementById('suggestions-section').style.display = 'none'; // Hide suggestions section
  showToast('Search links ready! Click any to find jobs.', 'success');
}

function generateSearchLinksClientSide() {
  const title = document.getElementById('search-query').value || profile.targetTitles?.[0] || profile.currentTitle || 'software engineer';
  const location = document.getElementById('search-location').value || profile.location || '';
  const encode = encodeURIComponent;
  
  // ATS sites for Fresh Jobs - all 15 sites
  const atsSites = [
    'myworkdayjobs.com', 'greenhouse.io', 'lever.co', 'icims.com',
    'smartrecruiters.com', 'taleo.net', 'jobvite.com', 'workforcenow.adp.com',
    'bamboohr.com', 'brassring.com', 'breezy.hr', 'bullhorn.com',
    'jazzhr.com', 'jobdiva.com', 'successfactors.com'
  ];
  
  // Extract seniority levels from title
  const seniorityLevels = ['Director', 'Head of', 'VP', 'Vice President', 'Principal', 'Lead', 'Senior', 'Manager', 'Chief', 'CTO', 'CIO'];
  const foundSeniority = seniorityLevels.filter(level => 
    title.toLowerCase().includes(level.toLowerCase()) || 
    (profile.targetTitles || []).some(t => t.toLowerCase().includes(level.toLowerCase()))
  );
  const seniorityQuery = foundSeniority.length > 0 
    ? foundSeniority.slice(0, 4) 
    : ['Director', 'Manager', 'Lead']; // Default
  
  // Extract domain/field keywords from title and target roles
  const domainKeywords = ['AI', 'Machine Learning', 'ML', 'Data', 'Engineering', 'Technology', 
    'Enterprise Architecture', 'Platform', 'Digital Transformation', 'Automation', 
    'Cloud', 'Software', 'Product', 'Analytics', 'Infrastructure', 'DevOps', 'Security'];
  const titleAndTargets = [title, ...(profile.targetTitles || [])].join(' ');
  const foundDomains = domainKeywords.filter(domain => 
    titleAndTargets.toLowerCase().includes(domain.toLowerCase())
  );
  const domainQuery = foundDomains.length > 0 
    ? foundDomains.slice(0, 5)
    : ['Technology', 'Engineering', 'Software']; // Default
  
  // Extract tech skills from profile
  const techSkills = (profile.hardSkills || []).slice(0, 6);
  const skillsQuery = techSkills.length > 0 ? techSkills : ['Python', 'AWS', 'Cloud'];
  
  // Location - simplified
  const loc = location.replace(/"/g, '').split(',')[0].trim();
  const locationQuery = loc 
    ? [loc, 'remote', 'United States']
    : ['remote', 'United States', 'worldwide'];
  
  // Build the smart Boolean query
  // Format: (sites) (seniority) (domain) (skills) (location)
  const sitesStr = atsSites.map(s => `site:${s}`).join(' OR ');
  const seniorityStr = seniorityQuery.map(s => `"${s}"`).join(' OR ');
  const domainStr = domainQuery.map(d => `"${d}"`).join(' OR ');
  const skillsStr = skillsQuery.map(s => `"${s}"`).join(' OR ');
  const locationStr = locationQuery.map(l => `"${l}"`).join(' OR ');
  
  const smartQuery = `(${sitesStr}) (${seniorityStr}) (${domainStr}) (${skillsStr}) (${locationStr})`;
  const freshJobsAllUrl = `https://www.google.com/search?q=${encodeURIComponent(smartQuery)}&tbs=qdr:w`;
  const freshJobs24hUrl = `https://www.google.com/search?q=${encodeURIComponent(smartQuery)}&tbs=qdr:d`;
  
  // Individual ATS site searches with simplified query
  const topSites = [
    { site: 'myworkdayjobs.com', name: 'Workday' },
    { site: 'greenhouse.io', name: 'Greenhouse' },
    { site: 'lever.co', name: 'Lever' },
    { site: 'icims.com', name: 'iCIMS' },
    { site: 'smartrecruiters.com', name: 'SmartRecruiters' },
    { site: 'taleo.net', name: 'Taleo' }
  ];
  
  const freshJobsIndividual = topSites.map(ats => {
    const singleSiteQuery = `site:${ats.site} (${seniorityStr}) (${domainStr}) (${locationStr})`;
    return {
      name: ats.name,
      url: `https://www.google.com/search?q=${encodeURIComponent(singleSiteQuery)}&tbs=qdr:w`
    };
  });
  
  // Build smart search queries for job boards
  // LinkedIn/Indeed support Boolean OR in search
  const seniorityTerms = seniorityQuery.join(' OR ');  // "Director" OR "Head of" OR "VP"
  const domainTerms = domainQuery.join(' OR ');        // "AI" OR "Engineering" OR "Technology"
  const topSkills = skillsQuery.slice(0, 3).join(' OR '); // "AWS" OR "Python" OR "MLOps"
  
  // Smart query for LinkedIn (supports OR)
  const linkedInQuery = `(${seniorityTerms}) (${domainTerms})`;
  
  // Smart query for Indeed (supports Boolean)
  const indeedQuery = `(${seniorityTerms}) (${domainTerms})`;
  
  // Smart query for Google Jobs
  const googleJobsQuery = `(${seniorityTerms}) (${domainTerms}) (${topSkills}) ${loc || 'remote'}`;
  
  return {
    primary: [
      { name: 'LinkedIn', icon: 'üíº', url: `https://www.linkedin.com/jobs/search/?keywords=${encode(linkedInQuery)}&location=${encode(location)}` },
      { name: 'Indeed', icon: 'üîç', url: `https://www.indeed.com/jobs?q=${encode(indeedQuery)}&l=${encode(location)}` },
      { name: 'Glassdoor', icon: '‚≠ê', url: `https://www.glassdoor.com/Job/jobs.htm?sc.keyword=${encode(linkedInQuery)}&locKeyword=${encode(location)}` },
      { name: 'Google Jobs', icon: 'üîé', url: `https://www.google.com/search?q=${encode(googleJobsQuery + ' jobs')}&ibp=htl;jobs` }
    ],
    secondary: [
      { name: 'ZipRecruiter', icon: '‚ö°', url: `https://www.ziprecruiter.com/jobs-search?search=${encode(linkedInQuery)}&location=${encode(location)}` },
      { name: 'Monster', icon: 'üëæ', url: `https://www.monster.com/jobs/search?q=${encode(linkedInQuery)}&where=${encode(location)}` },
      { name: 'CareerBuilder', icon: 'üèóÔ∏è', url: `https://www.careerbuilder.com/jobs?keywords=${encode(linkedInQuery)}&location=${encode(location)}` },
      { name: 'SimplyHired', icon: '‚ú®', url: `https://www.simplyhired.com/search?q=${encode(indeedQuery)}&l=${encode(location)}` }
    ],
    tech: [
      { name: 'Dice', icon: 'üé≤', url: `https://www.dice.com/jobs?q=${encode(linkedInQuery)}&location=${encode(location)}` },
      { name: 'Built In', icon: 'üè¢', url: `https://builtin.com/jobs?search=${encode(domainTerms)}&location=${encode(location)}` },
      { name: 'Wellfound', icon: 'üöÄ', url: `https://wellfound.com/jobs?query=${encode(domainTerms)}` },
      { name: 'Levels.fyi', icon: 'üìä', url: `https://www.levels.fyi/jobs?searchText=${encode(linkedInQuery)}&location=${encode(location)}` }
    ],
    remote: [
      { name: 'We Work Remotely', icon: 'üåç', url: `https://weworkremotely.com/remote-jobs/search?term=${encode(domainTerms)}` },
      { name: 'Remote OK', icon: 'üè†', url: `https://remoteok.com/remote-${encode(domainQuery[0] || 'tech').toLowerCase().replace(/\s+/g, '-')}-jobs` },
      { name: 'FlexJobs', icon: 'üßò', url: `https://www.flexjobs.com/search?search=${encode(linkedInQuery)}` },
      { name: 'Remote.co', icon: 'üíª', url: `https://remote.co/remote-jobs/search/?search_keywords=${encode(domainTerms)}` }
    ],
    freshJobs: freshJobsIndividual,
    freshJobsAll: freshJobsAllUrl,
    freshJobs24h: freshJobs24hUrl,
    bySkill: (profile.hardSkills || []).slice(0, 5).map(skill => ({
      skill,
      url: `https://www.linkedin.com/jobs/search/?keywords=${encode(skill + ' ' + seniorityQuery[0])}&location=${encode(location)}`
    })),
    byTitle: (profile.targetTitles || []).slice(0, 4).map(t => ({
      title: t,
      linkedin: `https://www.linkedin.com/jobs/search/?keywords=${encode(t)}&location=${encode(location)}`,
      indeed: `https://www.indeed.com/jobs?q=${encode(t)}&l=${encode(location)}`
    }))
  };
}

function displaySearchLinks(links) {
  // Primary job boards
  document.getElementById('primary-links').innerHTML = links.primary.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-primary" style="text-decoration: none;">
      ${l.icon} ${l.name}
    </a>
  `).join('');
  
  // Secondary job boards (General)
  document.getElementById('secondary-links').innerHTML = links.secondary.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none;">
      ${l.icon} ${l.name}
    </a>
  `).join('');
  
  // Tech job boards
  document.getElementById('tech-links').innerHTML = links.tech.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none;">
      ${l.icon} ${l.name}
    </a>
  `).join('');
  
  // Remote job boards
  document.getElementById('remote-links').innerHTML = links.remote.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none;">
      ${l.icon} ${l.name}
    </a>
  `).join('');
  
  // Fresh Jobs - Individual ATS sites
  document.getElementById('fresh-jobs-links').innerHTML = links.freshJobs.map(l => `
    <a href="${l.url}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none; border-color: #f59e0b;">
      üî• ${l.name}
    </a>
  `).join('');
  
  // Fresh Jobs - All ATS combined (Past Week - more results)
  document.getElementById('fresh-jobs-all').innerHTML = `
    <a href="${links.freshJobsAll}" target="_blank" class="btn btn-primary" style="text-decoration: none; background: linear-gradient(135deg, #f59e0b, #ef4444);">
      üî• ALL ATS Sites (Past Week)
    </a>
  `;
  
  // Fresh Jobs - Last 24h option
  document.getElementById('fresh-jobs-24h').innerHTML = `
    <a href="${links.freshJobs24h}" target="_blank" class="btn btn-secondary" style="text-decoration: none; border-color: #f59e0b; color: #f59e0b;">
      ‚ö° Last 24 Hours Only
    </a>
  `;
  
  // By title
  document.getElementById('title-links').innerHTML = links.byTitle.map(t => `
    <div style="margin-bottom: 8px;">
      <span style="color: #e2e8f0; font-size: 0.9rem; margin-right: 8px;">${t.title}</span>
      <a href="${t.linkedin}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">LinkedIn</a>
      <a href="${t.indeed}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">Indeed</a>
    </div>
  `).join('');
  
  // By skill
  document.getElementById('skill-links').innerHTML = links.bySkill.map(s => `
    <a href="${s.url}" target="_blank" class="tag tag-info" style="text-decoration: none; cursor: pointer;">
      ${s.skill} ‚Üí
    </a>
  `).join('');
}

function displayJobs(list, filter = 'all') {
  let filtered = list;
  if (filter === 'excellent') filtered = list.filter(j => j.matchScore >= 80);
  else if (filter === 'good') filtered = list.filter(j => j.matchScore >= 60 && j.matchScore < 80);
  
  document.getElementById('jobs-count').textContent = filtered.length;
  
  document.getElementById('job-list').innerHTML = filtered.length === 0 
    ? '<div class="empty-state"><div class="icon">üîç</div><h3>No jobs match this filter</h3></div>'
    : filtered.map(job => {
      const scoreClass = job.matchScore >= 80 ? 'high' : job.matchScore >= 60 ? 'medium' : 'low';
      const cardClass = job.matchScore >= 80 ? 'excellent' : job.matchScore >= 60 ? 'good' : 'moderate';
      const recClass = job.recommendation === 'APPLY_NOW' ? 'apply-now' : job.recommendation === 'WORTH_APPLYING' ? 'worth-it' : job.recommendation === 'CUSTOMIZE_FIRST' ? 'customize' : 'skip';
      
      // For suggestions, create search URLs. For real jobs, use applyUrl
      const searchQuery = encodeURIComponent(`${job.title} ${job.company}`);
      const linkedInUrl = job.applyUrl || job.searchUrl || `https://www.linkedin.com/jobs/search/?keywords=${searchQuery}`;
      const indeedUrl = `https://www.indeed.com/jobs?q=${searchQuery}`;
      
      return `
        <div class="job-card ${cardClass}">
          <div class="job-header">
            <div>
              <div class="job-title">${job.title}</div>
              <div class="job-company">${job.company}${job.isSuggestion ? ' <span style="font-size:0.75rem; color:#64748b;">(suggested)</span>' : ''}</div>
              ${job.location ? `<div class="job-meta">
                <span>üìç ${job.location}</span>
                ${job.salary ? `<span>üí∞ ${job.salary}</span>` : ''}
                ${job.postedDate ? `<span>üïê ${job.postedDate}</span>` : ''}
                ${job.isRemote ? '<span>üè† Remote</span>' : ''}
              </div>` : ''}
            </div>
            <div style="text-align:right;">
              <div class="match-percent ${scoreClass}">${job.matchScore}%</div>
              <div style="font-size:0.7rem; color:#64748b;">MATCH</div>
            </div>
          </div>
          <div class="flex gap-2 items-center mt-4">
            <span class="recommendation ${recClass}">${(job.recommendation || 'WORTH_APPLYING').replace(/_/g, ' ')}</span>
            ${(job.matchingSkills || []).slice(0, 3).map(s => `<span class="tag tag-success" style="font-size:0.75rem;">${s}</span>`).join('')}
          </div>
          <p style="color:#94a3b8; font-size:0.9rem; margin-top:12px;">${job.quickTake || job.description || ''}</p>
          <div class="flex gap-2 flex-wrap mt-4">
            <button class="btn btn-primary btn-sm" onclick="generateCoverLetter('${job.id}')">üìù Cover Letter</button>
            <button class="btn btn-secondary btn-sm" onclick="saveJob('${job.id}')">üíæ Save</button>
            <a href="${linkedInUrl}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration:none;">
              ${job.applyUrl ? 'üîó Apply Now' : 'üîó Find on LinkedIn'}
            </a>
            ${!job.applyUrl ? `<a href="${indeedUrl}" target="_blank" class="btn btn-secondary btn-sm" style="text-decoration:none;">üîó Indeed</a>` : ''}
          </div>
        </div>
      `;
    }).join('');
}

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    displayJobs(jobs, btn.dataset.filter);
  });
});

// ========== COVER LETTER ==========
async function generateCoverLetter(jobId) {
  const job = jobs.find(j => j.id === jobId) || savedJobs.find(j => j.id === jobId);
  if (!job) return;

  // Ensure sessionId exists before generating cover letter
  if (!sessionId) {
    if (currentUser && currentUser.email) {
      sessionId = 'user_' + btoa(currentUser.email).replace(/=/g, '') + '_' + Date.now();
      localStorage.setItem('jobmatch_session', sessionId);
    } else {
      sessionId = 'temp_' + Date.now();
      localStorage.setItem('jobmatch_session', sessionId);
    }
  }

  currentJob = job;
  document.getElementById('cl-job-info').textContent = `For: ${job.title} at ${job.company}`;
  document.getElementById('cover-letter-text').innerHTML = '<div class="loading"></div> Generating...';
  document.getElementById('cover-letter-modal').classList.add('open');

  try {
    const res = await fetch('/api/generate-cover-letter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, jobId, companyName: job.company, jobTitle: job.title })
    });
    
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    
    document.getElementById('cover-letter-text').textContent = data.data.coverLetter;
  } catch (err) {
    document.getElementById('cover-letter-text').textContent = 'Failed to generate. Please try again.';
  }
}

function closeCoverLetterModal() { document.getElementById('cover-letter-modal').classList.remove('open'); }
function copyCoverLetter() { navigator.clipboard.writeText(document.getElementById('cover-letter-text').textContent); showToast('Copied!', 'success'); }
function regenerateCoverLetter() { if (currentJob) generateCoverLetter(currentJob.id); }

// ========== TRACKER ==========
async function saveJob(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;
  
  try {
    const res = await fetch('/api/save-job', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, job, status: 'SAVED' })
    });
    
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    
    savedJobs = data.data.savedJobs;
    updateTracker();
    showToast('Job saved!', 'success');
  } catch (err) {
    showToast(err.message, 'error');
  }
}

async function updateJobStatus(jobId, status) {
  try {
    const res = await fetch('/api/update-job-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, jobId, status })
    });
    
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    
    const job = savedJobs.find(j => j.id === jobId);
    if (job) job.status = status;
    updateTracker();
    showToast('Status updated!', 'success');
  } catch (err) {
    showToast(err.message, 'error');
  }
}

function updateTracker() {
  const counts = { SAVED: 0, APPLIED: 0, INTERVIEW: 0, REJECTED: 0 };
  savedJobs.forEach(j => { if (counts[j.status] !== undefined) counts[j.status]++; });
  
  document.getElementById('stat-saved').textContent = counts.SAVED;
  document.getElementById('stat-applied').textContent = counts.APPLIED;
  document.getElementById('stat-interview').textContent = counts.INTERVIEW;
  document.getElementById('stat-rejected').textContent = counts.REJECTED;
  document.getElementById('saved-badge').textContent = savedJobs.length;
  document.getElementById('saved-badge').style.display = savedJobs.length ? 'inline' : 'none';
  
  if (savedJobs.length === 0) {
    document.getElementById('no-saved-jobs').style.display = 'block';
    return;
  }
  
  document.getElementById('no-saved-jobs').style.display = 'none';
  document.getElementById('saved-jobs-list').innerHTML = savedJobs.map(job => {
    const searchQuery = encodeURIComponent(`${job.title} ${job.company}`);
    const applyUrl = job.applyUrl || job.searchUrl || `https://www.linkedin.com/jobs/search/?keywords=${searchQuery}`;
    return `
    <div class="job-card">
      <div class="job-header">
        <div>
          <div class="job-title">${job.title}</div>
          <div class="job-company">${job.company}</div>
          <div class="job-meta">
            ${job.location ? `<span>üìç ${job.location}</span>` : ''}
            <span class="tag ${job.status === 'INTERVIEW' ? 'tag-success' : job.status === 'APPLIED' ? 'tag-warning' : job.status === 'REJECTED' ? 'tag-danger' : 'tag-info'}">${job.status}</span>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="match-percent ${job.matchScore >= 70 ? 'high' : 'medium'}">${job.matchScore}%</div>
        </div>
      </div>
      <div class="flex gap-2 flex-wrap mt-4">
        <select onchange="updateJobStatus('${job.id}', this.value)" style="padding:8px; background:#1e1e2e; border:1px solid #2e2e3e; border-radius:8px; color:#e2e8f0;">
          <option value="SAVED" ${job.status === 'SAVED' ? 'selected' : ''}>Saved</option>
          <option value="APPLIED" ${job.status === 'APPLIED' ? 'selected' : ''}>Applied</option>
          <option value="INTERVIEW" ${job.status === 'INTERVIEW' ? 'selected' : ''}>Interview</option>
          <option value="OFFER" ${job.status === 'OFFER' ? 'selected' : ''}>Offer</option>
          <option value="REJECTED" ${job.status === 'REJECTED' ? 'selected' : ''}>Rejected</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="generateCoverLetter('${job.id}')">üìù Cover Letter</button>
        <a href="${applyUrl}" target="_blank" class="btn btn-primary btn-sm" style="text-decoration:none;">${job.applyUrl ? 'üîó Apply' : 'üîó Find Job'}</a>
      </div>
    </div>
  `;}).join('');
}

// ========== UTILITIES ==========
function setLoading(prefix, loading, text) {
  document.getElementById(`${prefix}-btn-text`).textContent = text;
  document.getElementById(`${prefix}-loading`).style.display = loading ? 'inline-block' : 'none';
  document.getElementById(`${prefix}-btn`).disabled = loading;
}

function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3000);
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeCoverLetterModal(); });

// Load saved on init
async function loadSaved() {
  if (!sessionId) return;
  try {
    const res = await fetch(`/api/saved-jobs?sessionId=${sessionId}`);
    const data = await res.json();
    if (data.success) { savedJobs = data.data.savedJobs || []; updateTracker(); }
  } catch (e) {}
}
loadSaved();

// ============================================
// ICA (Ideal Contact Advocates) Functionality
// ============================================

let icaSelectedFile = null;
let icaContacts = [];

const icaDropzone = document.getElementById('ica-dropzone');
const icaFileInput = document.getElementById('ica-file-input');
const icaFilePreview = document.getElementById('ica-file-preview');
const icaFilename = document.getElementById('ica-filename');
const icaUploadBtn = document.getElementById('ica-upload-btn');
const icaCancelBtn = document.getElementById('ica-cancel-btn');
const icaStatus = document.getElementById('ica-status');
const icaStatsCard = document.getElementById('ica-stats-card');
const icaContactsCard = document.getElementById('ica-contacts-card');
const icaSearch = document.getElementById('ica-search');
const icaFilter = document.getElementById('ica-filter');
const icaContactsTbody = document.getElementById('ica-contacts-tbody');

function showIcaStatus(message, type) {
  icaStatus.textContent = message;
  icaStatus.style.display = 'block';
  icaStatus.style.background = type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#6366f1';
  icaStatus.style.color = 'white';
}

function hideIcaStatus() {
  icaStatus.style.display = 'none';
}

icaDropzone.addEventListener('click', () => icaFileInput.click());
icaDropzone.querySelector('.browse').addEventListener('click', (e) => {
  e.stopPropagation();
  icaFileInput.click();
});

icaDropzone.addEventListener('dragover', (e) => {
  e.preventDefault();
  icaDropzone.style.borderColor = '#6366f1';
});

icaDropzone.addEventListener('dragleave', () => {
  icaDropzone.style.borderColor = '#2e2e3e';
});

icaDropzone.addEventListener('drop', (e) => {
  e.preventDefault();
  icaDropzone.style.borderColor = '#2e2e3e';
  const file = e.dataTransfer.files[0];
  if (file) handleIcaFile(file);
});

icaFileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) handleIcaFile(file);
});

icaCancelBtn.addEventListener('click', () => {
  icaSelectedFile = null;
  icaFileInput.value = '';
  icaFilePreview.style.display = 'none';
  icaDropzone.style.display = 'block';
  hideIcaStatus();
});

function handleIcaFile(file) {
  if (!file.name.endsWith('.csv')) {
    showIcaStatus('Please upload a CSV file', 'error');
    return;
  }
  icaSelectedFile = file;
  icaFilename.textContent = file.name;
  icaDropzone.style.display = 'none';
  icaFilePreview.style.display = 'flex';
  hideIcaStatus();
}

icaUploadBtn.addEventListener('click', async () => {
  if (!icaSelectedFile || !sessionId) return;

  const formData = new FormData();
  formData.append('file', icaSelectedFile);

  try {
    icaUploadBtn.disabled = true;
    icaUploadBtn.textContent = 'Uploading...';

    const response = await fetch(`/api/ica/upload/${sessionId}`, {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(errorText || `Upload failed with status ${response.status}`);
    }

    const result = await response.json();

    if (!result.success) {
      throw new Error(result.error || 'Upload failed');
    }

    showIcaStatus(`Successfully imported ${result.stats.successfulImports} contacts!`, 'success');

    icaSelectedFile = null;
    icaFileInput.value = '';
    icaFilePreview.style.display = 'none';
    icaDropzone.style.display = 'block';

    await loadIcaStats();
    await loadIcaContacts();

    icaStatsCard.style.display = 'block';
    icaContactsCard.style.display = 'block';

  } catch (error) {
    showIcaStatus(error.message || 'Upload failed', 'error');
  } finally {
    icaUploadBtn.disabled = false;
    icaUploadBtn.textContent = 'Upload & Analyze';
  }
});

async function loadIcaStats() {
  if (!sessionId) return;
  try {
    const response = await fetch(`/api/ica/stats/${sessionId}`);
    const result = await response.json();
    if (result.success && result.stats) {
      document.getElementById('ica-stat-total').textContent = result.stats.totalContacts || 0;
      document.getElementById('ica-stat-high').textContent = result.stats.highPotential || 0;
      document.getElementById('ica-stat-medium').textContent = result.stats.mediumPotential || 0;
      document.getElementById('ica-stat-low').textContent = result.stats.lowPotential || 0;
    }
  } catch (error) {
    console.error('Failed to load ICA stats:', error);
  }
}

async function loadIcaContacts() {
  if (!sessionId) {
    console.log('‚ùå loadIcaContacts: No sessionId');
    return;
  }
  try {
    const category = icaFilter.value;
    const search = icaSearch.value;
    let url = `/api/ica/contacts/${sessionId}?category=${category}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    console.log('üì° Fetching contacts from:', url);
    const response = await fetch(url);
    const result = await response.json();
    console.log('üì• Contacts API response:', result);

    if (result.success) {
      icaContacts = result.contacts;
      console.log(`‚úÖ Loaded ${icaContacts.length} contacts`);
      renderIcaContacts();
    } else {
      console.error('‚ùå API returned error:', result.error);
    }
  } catch (error) {
    console.error('‚ùå Failed to load contacts:', error);
  }
}

function renderIcaContacts() {
  if (!icaContactsTbody) {
    console.error('icaContactsTbody element not found');
    return;
  }

  if (icaContacts.length === 0) {
    icaContactsTbody.innerHTML = `<tr><td colspan="7" style="padding: 40px; text-align: center; color: #64748b;">No contacts found</td></tr>`;
    icaContactsCard.style.display = 'block'; // Show card even with no contacts
    return;
  }

  icaContactsTbody.innerHTML = icaContacts.map(contact => `
    <tr style="border-bottom: 1px solid #2e2e3e;">
      <td style="padding: 12px;">${contact.first_name || ''} ${contact.last_name || ''}</td>
      <td style="padding: 12px;">${contact.company || '-'}</td>
      <td style="padding: 12px;">${contact.position || '-'}</td>
      <td style="padding: 12px;">
        <select onchange="updateIcaCategory('${contact.id}', this.value)" style="padding: 6px 10px; border: 1px solid #2e2e3e; border-radius: 6px; background: #1e1e2e; color: #e2e8f0; font-size: 0.85rem;">
          <option value="high_potential" ${contact.ica_category === 'high_potential' ? 'selected' : ''}>High Potential</option>
          <option value="medium_potential" ${contact.ica_category === 'medium_potential' ? 'selected' : ''}>Medium Potential</option>
          <option value="low_potential" ${contact.ica_category === 'low_potential' ? 'selected' : ''}>Low Potential</option>
          <option value="uncategorized" ${contact.ica_category === 'uncategorized' ? 'selected' : ''}>Uncategorized</option>
        </select>
      </td>
      <td style="padding: 12px;">${contact.connected_on ? new Date(contact.connected_on).toLocaleDateString() : '-'}</td>
      <td style="padding: 12px;">
        <input type="text" value="${contact.notes || ''}" onchange="updateIcaNotes('${contact.id}', this.value)" placeholder="Add notes..." style="width: 100%; padding: 6px 10px; border: 1px solid #2e2e3e; border-radius: 6px; background: #1e1e2e; color: #e2e8f0; font-size: 0.85rem;">
      </td>
      <td style="padding: 12px;">
        <button onclick="deleteIcaContact('${contact.id}')" class="btn btn-sm" style="padding: 6px 12px; background: transparent; border: 1px solid #2e2e3e; color: #ef4444;">Delete</button>
      </td>
    </tr>
  `).join('');

  // Ensure contacts card is visible after rendering
  icaContactsCard.style.display = 'block';
}

window.updateIcaCategory = async (contactId, category) => {
  if (!sessionId) return;
  try {
    await fetch(`/api/ica/contacts/${sessionId}/${contactId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ icaCategory: category })
    });
    await loadIcaStats();
    showIcaStatus('Category updated', 'success');
    setTimeout(hideIcaStatus, 2000);
  } catch (error) {
    console.error('Failed to update category:', error);
  }
};

window.updateIcaNotes = async (contactId, notes) => {
  if (!sessionId) return;
  try {
    await fetch(`/api/ica/contacts/${sessionId}/${contactId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notes })
    });
  } catch (error) {
    console.error('Failed to update notes:', error);
  }
};

window.deleteIcaContact = async (contactId) => {
  if (!sessionId || !confirm('Delete this contact?')) return;
  try {
    await fetch(`/api/ica/contacts/${sessionId}/${contactId}`, { method: 'DELETE' });
    await loadIcaStats();
    await loadIcaContacts();
    showIcaStatus('Contact deleted', 'success');
    setTimeout(hideIcaStatus, 2000);
  } catch (error) {
    console.error('Failed to delete contact:', error);
  }
};

icaFilter.addEventListener('change', loadIcaContacts);
icaSearch.addEventListener('input', () => {
  clearTimeout(icaSearch.debounceTimer);
  icaSearch.debounceTimer = setTimeout(loadIcaContacts, 300);
});

if (sessionId) {
  loadIcaStats().then(() => {
    loadIcaContacts().then(() => {
      // Always show cards after successful load
      icaStatsCard.style.display = 'block';
      icaContactsCard.style.display = 'block';
      loadHotLeads();
      loadCompaniesHiring();
      loadHelpfulContacts();
    });
  });
}
</script>
</body>
</html>
